<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM Gastos Viaje - M√≥vil</title>
    <!-- Tailwind CSS para un dise√±o moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js para los reportes -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos base y personalizaciones */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Colores de las categor√≠as para los bordes y gr√°ficos */
        :root {
            --gasolina: #3b82f6; /* blue-500 */
            --hotel: #8b5cf6;   /* violet-500 */
            --comida: #22c55e;  /* green-500 */
            --bebida: #f97316;  /* orange-500 */
        }

        .border-l-gasolina { border-left-color: var(--gasolina); }
        .bg-gasolina { background-color: var(--gasolina); }
        .text-gasolina { color: var(--gasolina); }
        .ring-gasolina { ring-color: var(--gasolina); }

        .border-l-hotel { border-left-color: var(--hotel); }
        .bg-hotel { background-color: var(--hotel); }
        .text-hotel { color: var(--hotel); }
        .ring-hotel { ring-color: var(--hotel); }
        
        .border-l-comida { border-left-color: var(--comida); }
        .bg-comida { background-color: var(--comida); }
        .text-comida { color: var(--comida); }
        .ring-comida { ring-color: var(--comida); }

        .border-l-bebida { border-left-color: var(--bebida); }
        .bg-bebida { background-color: var(--bebida); }
        .text-bebida { color: var(--bebida); }
        .ring-bebida { ring-color: var(--bebida); }
        
        /* Animaci√≥n para el spinner de carga */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin .5s linear infinite;
        }

        /* Transiciones para modales y notificaciones */
        .toast, .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Contenedor principal de la aplicaci√≥n -->
    <div id="app" class="pb-24">

        <!-- Header Fijo -->
        <header class="bg-gradient-to-r from-slate-800 to-slate-900 text-white p-4 sticky top-0 z-20 shadow-lg">
            <h1 class="text-xl font-bold flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                <span>Gestor de Viajes</span>
            </h1>
        </header>

        <!-- Contenido din√°mico (se muestra una vista a la vez) -->
        <main class="p-4">
            <!-- VISTA: DASHBOARD -->
            <div id="view-dashboard">
                <!-- Tarjeta de Gasto Total -->
                <div class="bg-white p-5 rounded-xl shadow-md mb-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-slate-500">Gasto total (este mes)</p>
                            <p id="total-amount" class="text-4xl font-bold text-slate-800 mt-1">$0</p>
                        </div>
                        <button id="generate-summary-btn" class="text-sm bg-slate-100 text-slate-600 font-semibold px-3 py-2 rounded-lg hover:bg-slate-200 active:scale-95 transition-transform flex items-center gap-2 disabled:opacity-75 disabled:cursor-wait">
                            <span id="summary-btn-text">‚ú® Ver Resumen IA</span>
                            <div id="summary-spinner" class="spinner hidden"></div>
                        </button>
                    </div>
                </div>

                <!-- Resumen por Categor√≠as -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border-t-4 border-blue-500">
                        <p class="text-sm text-slate-500">Gasolina</p>
                        <p id="gasolina-amount" class="text-lg font-semibold">$0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-t-4 border-violet-500">
                        <p class="text-sm text-slate-500">Hotel</p>
                        <p id="hotel-amount" class="text-lg font-semibold">$0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-t-4 border-green-500">
                        <p class="text-sm text-slate-500">Comida</p>
                        <p id="comida-amount" class="text-lg font-semibold">$0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-t-4 border-orange-500">
                        <p class="text-sm text-slate-500">Bebida</p>
                        <p id="bebida-amount" class="text-lg font-semibold">$0</p>
                    </div>
                </div>

                <!-- Filtros y Lista de Gastos -->
                <div>
                    <h2 class="text-lg font-semibold mb-3">Gastos Recientes</h2>
                    <div class="bg-white p-4 rounded-xl shadow-md">
                        <!-- Filtros -->
                        <div class="flex flex-col sm:flex-row gap-3 mb-4">
                            <select id="filter-category" class="w-full bg-slate-100 border-slate-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Todas las categor√≠as</option>
                                <option value="gasolina">Gasolina</option>
                                <option value="hotel">Hotel</option>
                                <option value="comida">Comida</option>
                                <option value="bebida">Bebida</option>
                            </select>
                            <input type="month" id="filter-date" class="w-full bg-slate-100 border-slate-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <!-- Lista de Gastos -->
                        <div id="expense-list" class="space-y-3">
                            <!-- El contenido se genera din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISTA: FORMULARIO (Agregar/Editar) -->
            <div id="view-form" class="hidden">
                 <div class="bg-white p-5 rounded-xl shadow-md">
                    <h2 id="form-title" class="text-lg font-semibold mb-4">Nuevo Gasto</h2>
                    <form id="expense-form" class="space-y-4">
                        <input type="hidden" id="expense-id">
                        <div>
                            <label for="expense-date" class="text-sm font-medium text-slate-600">Fecha</label>
                            <input type="date" id="expense-date" required class="mt-1 w-full bg-slate-100 border-slate-200 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="expense-description" class="text-sm font-medium text-slate-600">Descripci√≥n</label>
                            <div class="relative mt-1">
                                <input type="text" id="expense-description" required placeholder="Ej: Cena en restaurante, peaje..." class="w-full bg-slate-100 border-slate-200 rounded-lg p-2 pr-10 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <button type="button" id="autocategorize-btn" title="Categorizar con IA" class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400 hover:text-blue-600 disabled:opacity-50 disabled:cursor-wait">
                                    <span class="emoji-icon">‚ú®</span>
                                    <div class="spinner-icon hidden spinner"></div>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label for="expense-category" class="text-sm font-medium text-slate-600">Categor√≠a</label>
                            <select id="expense-category" required class="mt-1 w-full bg-slate-100 border-slate-200 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="" disabled>Seleccione una categor√≠a</option>
                                <option value="gasolina">Gasolina</option>
                                <option value="hotel">Hotel</option>
                                <option value="comida">Comida</option>
                                <option value="bebida">Bebida</option>
                            </select>
                        </div>
                        <div>
                            <label for="expense-amount" class="text-sm font-medium text-slate-600">Monto</label>
                            <input type="number" id="expense-amount" required placeholder="0" step="1" min="0" class="mt-1 w-full bg-slate-100 border-slate-200 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="expense-payment-method" class="text-sm font-medium text-slate-600">M√©todo de Pago</label>
                            <select id="expense-payment-method" class="mt-1 w-full bg-slate-100 border-slate-200 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option>Efectivo</option>
                                <option>Tarjeta de Cr√©dito</option>
                                <option>Tarjeta de D√©bito</option>
                                <option>Transferencia</option>
                            </select>
                        </div>
                        <button type="submit" id="form-submit-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 active:scale-95 transition-transform">
                            Guardar Gasto
                        </button>
                         <button type="button" id="form-cancel-btn" class="w-full bg-slate-200 text-slate-700 font-semibold py-3 px-4 rounded-lg hover:bg-slate-300 active:scale-95 transition-transform hidden">
                            Cancelar Edici√≥n
                        </button>
                    </form>
                </div>
            </div>

            <!-- VISTA: REPORTES -->
            <div id="view-reports" class="hidden">
                <div class="bg-white p-5 rounded-xl shadow-md space-y-6">
                    <div>
                        <h2 class="text-lg font-semibold mb-4">Reporte Gr√°fico</h2>
                        <div class="h-64 w-full mx-auto mb-4">
                            <canvas id="expenses-chart"></canvas>
                        </div>
                        <div id="report-details" class="space-y-2">
                            <!-- Detalles del reporte generados din√°micamente -->
                        </div>
                    </div>

                    <hr>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-3">Asistente IA</h3>
                        <div class="space-y-3">
                            <button id="generate-tips-btn" class="w-full bg-gradient-to-r from-violet-500 to-purple-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:from-violet-600 hover:to-purple-700 active:scale-95 transition-transform flex items-center justify-center gap-2 disabled:opacity-75 disabled:cursor-wait">
                                <span id="tips-btn-text">‚ú® Generar Consejos de Ahorro</span>
                                <div id="tips-spinner" class="spinner hidden"></div>
                            </button>
                             <button id="generate-email-btn" class="w-full bg-gradient-to-r from-sky-500 to-cyan-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:from-sky-600 hover:to-cyan-700 active:scale-95 transition-transform flex items-center justify-center gap-2 disabled:opacity-75 disabled:cursor-wait">
                                <span id="email-btn-text">üìß Redactar Email de Reporte</span>
                                <div id="email-spinner" class="spinner hidden"></div>
                            </button>
                        </div>
                        <div id="savings-tips-container" class="mt-4 p-4 bg-slate-100 rounded-lg text-sm text-slate-700 hidden prose prose-sm max-w-none"></div>
                        <div id="email-draft-container" class="mt-4 hidden">
                            <label class="text-sm font-medium text-slate-600">Borrador de Email:</label>
                            <textarea id="email-draft-textarea" readonly class="mt-1 w-full h-48 bg-slate-100 border-slate-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500"></textarea>
                            <button id="copy-email-btn" class="mt-2 w-full bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 active:scale-95 transition-transform">Copiar Texto</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Barra de Navegaci√≥n Inferior Fija -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around z-20 shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
        <button data-view="dashboard" class="nav-item flex-1 flex flex-col items-center justify-center p-2 text-blue-600">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mb-1"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            <span class="text-xs font-medium">Inicio</span>
        </button>
        <button data-view="form" class="nav-item flex-1 flex flex-col items-center justify-center p-2 text-slate-500">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mb-1"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
            <span class="text-xs font-medium">Agregar</span>
        </button>
        <button data-view="reports" class="nav-item flex-1 flex flex-col items-center justify-center p-2 text-slate-500">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mb-1"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>
            <span class="text-xs font-medium">Reportes</span>
        </button>
    </nav>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-24 right-4 bg-slate-900 text-white py-2 px-4 rounded-lg shadow-xl opacity-0 translate-y-4 transition-all duration-300 z-50">
        <p id="toast-message"></p>
    </div>

    <!-- Modales -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform scale-95">
            <h3 class="text-lg font-bold text-slate-800">Confirmar Acci√≥n</h3>
            <p id="modal-message" class="text-slate-600 mt-2 mb-6">¬øEst√°s seguro?</p>
            <div class="flex justify-end gap-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md font-semibold hover:bg-slate-300">Cancelar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md font-semibold hover:bg-red-700">Eliminar</button>
            </div>
        </div>
    </div>
    <div id="ai-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div id="ai-modal-content" class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform scale-95">
            <h3 id="ai-modal-title" class="text-lg font-bold text-slate-800 mb-2"></h3>
            <div id="ai-modal-body" class="text-slate-600 text-sm mt-2 mb-6 prose prose-sm max-w-none"></div>
            <div class="flex justify-end">
                <button id="ai-modal-close-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md font-semibold hover:bg-slate-300">Cerrar</button>
            </div>
        </div>
    </div>


    <!-- Firebase y L√≥gica de la App -->
    <script type="module">
        // Importar las funciones necesarias de Firebase v11+
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, onSnapshot, deleteDoc, updateDoc, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACI√ìN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCg9A5CbpKOLV6WspRz87bhWT3wJVbWXDE",
            authDomain: "crm-gastos-viaje.firebaseapp.com",
            projectId: "crm-gastos-viaje",
            storageBucket: "crm-gastos-viaje.firebasestorage.app",
            messagingSenderId: "1030088242238",
            appId: "1:1030088242238:web:53c2dcb3fc6642f82e4d6f"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GEMINI API CONFIG ---
        const API_KEY = ""; // Provided by the execution environment
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        let isGenerating = false; // Flag to prevent multiple API calls

        // --- ESTADO GLOBAL DE LA APLICACI√ìN ---
        let allExpenses = [];
        let currentUnsubscribe = null;
        let expensesChart = null;
        let editingExpenseId = null;

        // --- DEFINICIONES DE CATEGOR√çAS ---
        const categoryDetails = {
            "gasolina": { name: "Gasolina", color: "#3b82f6", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M14 8V5a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3"></path><path d="M18.37 12.63 14 7h-4l-4.37 5.63a1 1 0 0 0 0 1.24L10 22h4l4.37-8.13a1 1 0 0 0 0-1.24Z"></path></svg>` },
            "hotel": { name: "Hotel", color: "#8b5cf6", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M2 22s5.29-1 10-1 10 1 10 1H2Z"></path><path d="M8 11v5"></path><path d="M12 11v5"></path><path d="M16 11v5"></path><path d="M20.39 10.39 14 4 7.61 10.39a2 2 0 0 0 1.41 3.41H18a2 2 0 0 0 2.39-3.41Z"></path></svg>` },
            "comida": { name: "Comida", color: "#22c55e", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M3 12h18"></path><path d="M12 21a9 9 0 0 0 9-9H3a9 9 0 0 0 9 9Z"></path><path d="m5 12 1-9h12l1 9"></path><path d="M6 12a6 6 0 0 1 12 0"></path></svg>` },
            "bebida": { name: "Bebida", color: "#f97316", icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M15 5.5a2.5 2.5 0 0 0-5 0V7h5V5.5Z"></path><path d="M12 22a7 7 0 0 0 7-7h-4a3 3 0 0 1-3-3V7H8v5a3 3 0 0 1-3 3H1a7 7 0 0 0 7 7 6.9 6.9 0 0 0 4 0Z"></path><path d="M12 7V2"></path><path d="M18 7h2"></path><path d="M4 7H2"></path></svg>` }
        };

        // --- FUNCIONES UTILITARIAS ---
        const formatCurrency = (amount) => `$${new Intl.NumberFormat('es-CO', { maximumFractionDigits: 0 }).format(amount)}`;
        const formatDate = (date) => date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
        
        // --- GEMINI API CALLER with Exponential Backoff ---
        async function callGemini(payload, maxRetries = 3) {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || null;
                } catch (error) {
                    console.error(`Gemini API call failed on attempt ${attempt + 1}:`, error);
                    attempt++;
                    if (attempt >= maxRetries) {
                        return null; // Max retries reached
                    }
                    const delay = Math.pow(2, attempt) * 1000; // 2s, 4s, ...
                    await new Promise(res => setTimeout(res, delay));
                }
            }
        }

        // --- L√ìGICA DE NAVEGACI√ìN Y VISTAS ---
        const views = {
            dashboard: document.getElementById('view-dashboard'),
            form: document.getElementById('view-form'),
            reports: document.getElementById('view-reports'),
        };
        const navItems = document.querySelectorAll('.nav-item');

        function switchView(viewName) {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
            }

            navItems.forEach(item => {
                if (item.dataset.view === viewName) {
                    item.classList.add('text-blue-600');
                    item.classList.remove('text-slate-500');
                } else {
                    item.classList.remove('text-blue-600');
                    item.classList.add('text-slate-500');
                }
            });
            window.scrollTo(0, 0);
        }

        // --- L√ìGICA DE UI (MODALES, TOASTS) ---
        const toastEl = document.getElementById('toast');
        const toastMessageEl = document.getElementById('toast-message');

        function showToast(message, isError = false) {
            toastMessageEl.textContent = message;
            toastEl.classList.toggle('bg-red-600', isError);
            toastEl.classList.toggle('bg-slate-900', !isError);
            toastEl.classList.remove('opacity-0', 'translate-y-4');
            setTimeout(() => {
                toastEl.classList.add('opacity-0', 'translate-y-4');
            }, 3000);
        }

        const confirmModal = document.getElementById('confirmation-modal');
        const confirmModalContent = document.getElementById('modal-content');
        const confirmModalMessage = document.getElementById('modal-message');
        const confirmBtn = document.getElementById('modal-confirm-btn');
        const cancelBtn = document.getElementById('modal-cancel-btn');
        
        function showConfirmationModal(message, onConfirm) {
            confirmModalMessage.textContent = message;
            confirmModal.classList.remove('opacity-0', 'pointer-events-none');
            confirmModalContent.classList.remove('scale-95');

            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                hideConfirmationModal();
            });
        }

        function hideConfirmationModal() {
            confirmModal.classList.add('opacity-0', 'pointer-events-none');
            confirmModalContent.classList.add('scale-95');
        }
        
        const aiModal = document.getElementById('ai-modal');
        const aiModalContent = document.getElementById('ai-modal-content');
        const aiModalTitle = document.getElementById('ai-modal-title');
        const aiModalBody = document.getElementById('ai-modal-body');

        function showAiModal(title, content) {
            aiModalTitle.textContent = title;
            aiModalBody.innerHTML = content.replace(/\n/g, '<br>');
            aiModal.classList.remove('opacity-0', 'pointer-events-none');
            aiModalContent.classList.remove('scale-95');
        }

        function hideAiModal() {
            aiModal.classList.add('opacity-0', 'pointer-events-none');
            aiModalContent.classList.add('scale-95');
        }

        // --- L√ìGICA DE RENDERIZADO ---
        function renderExpenses() {
            const expenseListEl = document.getElementById('expense-list');
            const categoryFilter = document.getElementById('filter-category').value;
            const filteredExpenses = allExpenses.filter(e => !categoryFilter || e.category === categoryFilter);
            filteredExpenses.sort((a, b) => b.date.getTime() - a.date.getTime());

            if (filteredExpenses.length === 0) {
                expenseListEl.innerHTML = `<div class="text-center py-10 text-slate-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12 mx-auto mb-2 text-slate-300"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg><p class="font-semibold">Sin gastos</p><p class="text-sm">No hay gastos que coincidan con los filtros.</p></div>`;
            } else {
                expenseListEl.innerHTML = filteredExpenses.map(expense => {
                    const detail = categoryDetails[expense.category] || { name: 'Otro', color: '#64748b' };
                    return `<div class="bg-white rounded-lg shadow-sm flex items-center gap-4 p-3 border-l-4 ${'border-l-' + expense.category}"><div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center bg-${expense.category}/10 text-${expense.category}">${detail.icon}</div><div class="flex-grow"><p class="font-semibold">${expense.description}</p><p class="text-xs text-slate-500">${formatDate(expense.date)} - ${detail.name}</p></div><div class="text-right"><p class="font-bold text-lg">${formatCurrency(expense.amount)}</p><div class="flex gap-2 justify-end mt-1"><button data-id="${expense.id}" class="edit-btn text-slate-400 hover:text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg></button><button data-id="${expense.id}" class="delete-btn text-slate-400 hover:text-red-600"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg></button></div></div></div>`;
                }).join('');
            }
        }

        function updateStatsAndReports() {
            const categoryTotals = { gasolina: 0, hotel: 0, comida: 0, bebida: 0 };
            let totalAmount = 0;
            allExpenses.forEach(e => {
                if(categoryTotals.hasOwnProperty(e.category)) categoryTotals[e.category] += e.amount;
                totalAmount += e.amount;
            });
            document.getElementById('total-amount').textContent = formatCurrency(totalAmount);
            document.getElementById('gasolina-amount').textContent = formatCurrency(categoryTotals.gasolina);
            document.getElementById('hotel-amount').textContent = formatCurrency(categoryTotals.hotel);
            document.getElementById('comida-amount').textContent = formatCurrency(categoryTotals.comida);
            document.getElementById('bebida-amount').textContent = formatCurrency(categoryTotals.bebida);
            updateChart(categoryTotals, totalAmount);
        }

        function updateChart(categoryTotals, totalAmount) {
            const reportDetailsEl = document.getElementById('report-details');
            const ctx = document.getElementById('expenses-chart').getContext('2d');
            const labels = Object.values(categoryDetails).map(d => d.name);
            const data = Object.keys(categoryDetails).map(key => categoryTotals[key] || 0);
            const colors = Object.values(categoryDetails).map(d => d.color);
            reportDetailsEl.innerHTML = Object.keys(categoryDetails).map(key => {
                const percentage = totalAmount > 0 ? ((categoryTotals[key] || 0) / totalAmount * 100).toFixed(1) : 0;
                return `<div class="flex justify-between items-center text-sm"><div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full ${'bg-' + key}"></span><span>${categoryDetails[key].name}</span></div><span class="font-semibold">${percentage}% (${formatCurrency(categoryTotals[key] || 0)})</span></div>`;
            }).join('');
            if (expensesChart) expensesChart.destroy();
            expensesChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data, backgroundColor: colors, borderColor: '#fff', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.label}: ${formatCurrency(c.raw)}` } } } } });
        }

        // --- L√ìGICA DE FIREBASE ---
        function listenToExpenses() {
            if (currentUnsubscribe) currentUnsubscribe();
            const dateFilter = document.getElementById('filter-date').value;
            const [year, month] = dateFilter.split('-').map(Number);
            const startDate = Timestamp.fromDate(new Date(year, month - 1, 1));
            const endDate = Timestamp.fromDate(new Date(year, month, 1));
            const q = query(collection(db, "travel_expenses"), where("date", ">=", startDate), where("date", "<", endDate));
            currentUnsubscribe = onSnapshot(q, (snapshot) => {
                allExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), date: doc.data().date.toDate() }));
                renderExpenses();
                updateStatsAndReports();
            }, e => { console.error(e); showToast("Error al cargar datos.", true); });
        }

        async function saveExpense(expenseData) {
            try {
                const date = new Date(expenseData.date + 'T00:00:00');
                const dataToSave = { ...expenseData, date: Timestamp.fromDate(date) };
                if (editingExpenseId) {
                    await updateDoc(doc(db, "travel_expenses", editingExpenseId), dataToSave);
                    showToast("Gasto actualizado");
                } else {
                    await addDoc(collection(db, "travel_expenses"), dataToSave);
                    showToast("Gasto agregado");
                }
                resetFormAndSwitchView();
            } catch (e) { console.error(e); showToast("Error al guardar.", true); }
        }

        async function deleteExpense(id) {
            try {
                await deleteDoc(doc(db, "travel_expenses", id));
                showToast("Gasto eliminado");
            } catch (e) { console.error(e); showToast("Error al eliminar.", true); }
        }
        
        // --- MANEJO DEL FORMULARIO ---
        function resetFormAndSwitchView() {
            document.getElementById('expense-form').reset();
            editingExpenseId = null;
            document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('expense-category').value = "";
            document.getElementById('form-title').textContent = "Nuevo Gasto";
            document.getElementById('form-submit-btn').textContent = "Guardar Gasto";
            document.getElementById('form-cancel-btn').classList.add('hidden');
            switchView('dashboard');
        }

        function populateFormForEdit(id) {
            const expense = allExpenses.find(e => e.id === id);
            if (!expense) return;
            editingExpenseId = id;
            const yyyy = expense.date.getFullYear();
            const mm = String(expense.date.getMonth() + 1).padStart(2, '0');
            const dd = String(expense.date.getDate()).padStart(2, '0');
            document.getElementById('expense-date').value = `${yyyy}-${mm}-${dd}`;
            document.getElementById('expense-category').value = expense.category;
            document.getElementById('expense-description').value = expense.description;
            document.getElementById('expense-amount').value = expense.amount;
            document.getElementById('expense-payment-method').value = expense.paymentMethod;
            document.getElementById('form-title').textContent = "Editar Gasto";
            document.getElementById('form-submit-btn').textContent = "Actualizar Gasto";
            document.getElementById('form-cancel-btn').classList.remove('hidden');
            switchView('form');
        }

        // --- NUEVAS FUNCIONES CON IA ---
        async function handleAutocategorize() {
            if (isGenerating) return;
            const description = document.getElementById('expense-description').value.trim();
            if (description.length < 3) return showToast("Escribe una descripci√≥n m√°s larga.", true);
            const btn = document.getElementById('autocategorize-btn');
            const emoji = btn.querySelector('.emoji-icon');
            const spinner = btn.querySelector('.spinner-icon');
            isGenerating = true; btn.disabled = true; emoji.classList.add('hidden'); spinner.classList.remove('hidden');

            const payload = {
                contents: [{ parts: [{ text: `Analiza la descripci√≥n del gasto y clasif√≠cala en una de estas categor√≠as: 'gasolina', 'hotel', 'comida', 'bebida'. Responde √∫nicamente con el nombre de la categor√≠a en min√∫sculas. Descripci√≥n: "${description}"` }] }],
                systemInstruction: { parts: [{ text: "Eres un experto categorizando gastos." }] }
            };
            const category = await callGemini(payload);
            if (category && categoryDetails.hasOwnProperty(category.trim())) {
                document.getElementById('expense-category').value = category.trim();
                showToast("Categor√≠a sugerida por IA");
            } else { showToast("No se pudo sugerir una categor√≠a.", true); }
            isGenerating = false; btn.disabled = false; emoji.classList.remove('hidden'); spinner.classList.add('hidden');
        }

        async function getSummaryData() {
            let totalAmount = 0;
            const categoryTotals = {};
            allExpenses.forEach(e => {
                totalAmount += e.amount;
                categoryTotals[e.category] = (categoryTotals[e.category] || 0) + e.amount;
            });
            let summary = `Total gastado: ${formatCurrency(totalAmount)}.\n`;
            summary += Object.entries(categoryTotals)
                .map(([cat, amount]) => `${categoryDetails[cat].name}: ${formatCurrency(amount)} (${totalAmount > 0 ? ((amount/totalAmount)*100).toFixed(0) : 0}%)`)
                .join('.\n');
            return { summary, totalAmount };
        }

        async function handleGenerateDashboardSummary() {
            if (isGenerating) return;
            const { summary, totalAmount } = await getSummaryData();
            if (totalAmount === 0) return showToast("No hay gastos para resumir.", true);

            const btn = document.getElementById('generate-summary-btn');
            const spinner = document.getElementById('summary-spinner');
            isGenerating = true; btn.disabled = true; spinner.classList.remove('hidden');

            const payload = {
                contents: [{ parts: [{ text: `Basado en este resumen de gastos de viaje, escribe un p√°rrafo corto (2-3 frases) en tono amigable y alentador sobre los gastos del mes. Menciona la categor√≠a principal de gasto. Resumen:\n${summary}` }] }],
                systemInstruction: { parts: [{ text: "Eres un asistente financiero amigable que resume gastos de viaje en espa√±ol." }] }
            };
            const result = await callGemini(payload);
            if(result) showAiModal('Resumen del Mes', result);
            else showToast('No se pudo generar el resumen.', true);

            isGenerating = false; btn.disabled = false; spinner.classList.add('hidden');
        }

        async function handleGenerateTips() {
            if (isGenerating) return;
            const { summary, totalAmount } = await getSummaryData();
            if (totalAmount === 0) return showToast("No hay gastos para analizar este mes.", true);
            const btn = document.getElementById('generate-tips-btn');
            const btnText = document.getElementById('tips-btn-text');
            const spinner = document.getElementById('tips-spinner');
            const container = document.getElementById('savings-tips-container');
            isGenerating = true; btn.disabled = true; btnText.textContent = "Analizando..."; spinner.classList.remove('hidden'); container.classList.add('hidden'); document.getElementById('email-draft-container').classList.add('hidden');

            const payload = {
                contents: [{ parts: [{ text: `Basado en este resumen de gastos de viaje, proporciona 2-3 consejos de ahorro concisos, pr√°cticos y personalizados para el pr√≥ximo viaje del usuario. Formatea la respuesta como un √∫nico bloque de texto, usando markdown para listas (ej: usando '*' para vi√±etas). Mant√©n un tono positivo y servicial.\n\nResumen de Gastos:\n${summary}` }] }],
                systemInstruction: { parts: [{ text: "Eres un amigable y experto asesor financiero para viajeros. Proporcionas consejos pr√°cticos y alentadores en espa√±ol." }] }
            };
            const tips = await callGemini(payload);
            if (tips) {
                container.innerHTML = tips.replace(/\* /g, '<p class="pl-4 -indent-4">&bull; ');
                container.classList.remove('hidden');
            } else showToast("No se pudieron generar los consejos.", true);
            isGenerating = false; btn.disabled = false; btnText.textContent = "‚ú® Generar Consejos de Ahorro"; spinner.classList.add('hidden');
        }

        async function handleGenerateReportEmail() {
            if (isGenerating) return;
            if (allExpenses.length === 0) return showToast("No hay gastos para reportar.", true);
            
            const btn = document.getElementById('generate-email-btn');
            const btnText = document.getElementById('email-btn-text');
            const spinner = document.getElementById('email-spinner');
            const container = document.getElementById('email-draft-container');
            const textarea = document.getElementById('email-draft-textarea');
            
            isGenerating = true; btn.disabled = true; btnText.textContent = "Redactando..."; spinner.classList.remove('hidden'); container.classList.add('hidden'); document.getElementById('savings-tips-container').classList.add('hidden');

            let expenseDetails = allExpenses.map(e => `- ${formatDate(e.date)}: ${e.description} (${categoryDetails[e.category].name}) - ${formatCurrency(e.amount)}`).join('\n');
            const { summary } = await getSummaryData();

            const payload = {
                contents: [{ parts: [{ text: `Redacta un email formal y conciso para un reporte de gastos de viaje. Incluye un saludo, el resumen total de gastos, y la lista detallada. Usa el siguiente formato y datos:\n\nRESUMEN:\n${summary}\n\nGASTOS DETALLADOS:\n${expenseDetails}`}]}],
                systemInstruction: { parts: [{ text: "Eres un asistente profesional que redacta correos de reporte de gastos en espa√±ol. S√© claro y formal."}]}
            };

            const emailBody = await callGemini(payload);
            if (emailBody) {
                textarea.value = emailBody;
                container.classList.remove('hidden');
            } else showToast("No se pudo redactar el email.", true);

            isGenerating = false; btn.disabled = false; btnText.textContent = "üìß Redactar Email de Reporte"; spinner.classList.add('hidden');
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('Email copiado al portapapeles');
        }
        
        // --- EVENT LISTENERS ---
        function initializeEventListeners() {
            navItems.forEach(item => item.addEventListener('click', () => { if (item.dataset.view === 'form' && editingExpenseId) resetFormAndSwitchView(); switchView(item.dataset.view); }));
            document.getElementById('filter-category').addEventListener('change', renderExpenses);
            document.getElementById('filter-date').addEventListener('change', listenToExpenses);
            document.getElementById('expense-form').addEventListener('submit', e => { 
                e.preventDefault(); 
                saveExpense({ 
                    date: document.getElementById('expense-date').value, 
                    category: document.getElementById('expense-category').value, 
                    description: document.getElementById('expense-description').value, 
                    amount: parseFloat(document.getElementById('expense-amount').value), 
                    paymentMethod: document.getElementById('expense-payment-method').value 
                }); 
            });
            document.getElementById('form-cancel-btn').addEventListener('click', resetFormAndSwitchView);
            document.getElementById('expense-list').addEventListener('click', e => { const editBtn = e.target.closest('.edit-btn'); if (editBtn) { populateFormForEdit(editBtn.dataset.id); return; } const deleteBtn = e.target.closest('.delete-btn'); if (deleteBtn) { showConfirmationModal('¬øSeguro que quieres eliminar este gasto?', () => deleteExpense(deleteBtn.dataset.id)); } });
            cancelBtn.addEventListener('click', hideConfirmationModal);
            confirmModal.addEventListener('click', e => { if (e.target === confirmModal) hideConfirmationModal(); });
            document.getElementById('ai-modal-close-btn').addEventListener('click', hideAiModal);
            aiModal.addEventListener('click', e => { if (e.target === aiModal) hideAiModal(); });

            // AI Features Listeners
            document.getElementById('autocategorize-btn').addEventListener('click', handleAutocategorize);
            document.getElementById('generate-tips-btn').addEventListener('click', handleGenerateTips);
            document.getElementById('generate-summary-btn').addEventListener('click', handleGenerateDashboardSummary);
            document.getElementById('generate-email-btn').addEventListener('click', handleGenerateReportEmail);
            document.getElementById('copy-email-btn').addEventListener('click', () => copyToClipboard(document.getElementById('email-draft-textarea').value));
        }
        
        // --- INICIALIZACI√ìN DE LA APP ---
        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, user => {
                if (user) {
                    console.log("Usuario autenticado:", user.uid);
                    const today = new Date();
                    document.getElementById('filter-date').value = today.toISOString().slice(0, 7);
                    document.getElementById('expense-date').value = today.toISOString().split('T')[0];
                    initializeEventListeners();
                    listenToExpenses();
                    switchView('dashboard');
                } else { signInAnonymously(auth).catch(e => { console.error(e); showToast("Error de autenticaci√≥n.", true); }); }
            });
        });
    </script>
</body>
</html>
