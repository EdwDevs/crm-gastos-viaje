<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>CRM Gastos Viaje - Tabla</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

  <style>
    /* ====== Dise√±o base con temas (restauradas variables) ====== */
    :root{
      --bg: #f7f9fc;
      --bg-soft: #ffffff;
      --bg-glass: rgba(255,255,255,0.75);
      --stroke: rgba(9,30,66,0.12);
      --text: #0f172a;
      --muted: #6b7280;

      --primary: #2563eb;
      --primary-2: #3b82f6;
      --success: #16a34a;
      --danger: #dc2626;

      --gasolina:#2563eb;
      --hotel:#7c3aed;
      --comida:#059669;
      --bebida:#d97706;

      --radius-lg:16px;
      --radius:12px;
      --radius-sm:10px;

      --shadow-xl: 0 24px 60px rgba(2,6,23,0.08);
      --shadow-md: 0 14px 36px rgba(2,6,23,0.08);
      --shadow-sm: 0 8px 20px rgba(2,6,23,0.06);
    }

    [data-theme="dark"]{
      --bg: #0b1220;
      --bg-soft: #0f172a;
      --bg-glass: rgba(17,24,39,0.55);
      --stroke: rgba(148,163,184,0.16);
      --text: #e5e7eb;
      --muted: #94a3b8;

      --primary:#60a5fa; --primary-2:#3b82f6;
      --success:#34d399; --danger:#f87171;

      --gasolina:#60a5fa; --hotel:#a78bfa; --comida:#34d399; --bebida:#f59e0b;
    }

    html { font-size: clamp(14px, 2.2vw, 16px); }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body{
      margin:0; min-height:100vh; color:var(--text);
      background: radial-gradient(1200px 800px at 100% -10%, var(--bg-soft) 0%, transparent 40%),
                  radial-gradient(1000px 700px at -10% 0%, var(--bg-soft) 0%, transparent 45%),
                  linear-gradient(180deg, var(--bg), var(--bg));
      padding-bottom: calc(76px + env(safe-area-inset-bottom, 12px));
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }

    /* Topbar */
    .topbar{ position: sticky; top:0; z-index: 1000; padding: calc(10px + env(safe-area-inset-top, 6px)) 14px 10px; background: linear-gradient(180deg, var(--bg-glass), rgba(255,255,255,0.02)); backdrop-filter: blur(10px); border-bottom: 1px solid var(--stroke); display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand i{ color: var(--primary); font-size: 1.15rem; }
    .brand h1{ margin:0; font-size:1rem; letter-spacing:.3px; font-weight:800; }

    .top-actions{ display:flex; gap:10px; align-items:center; }
    .theme-toggle{ min-width:40px; min-height:40px; border-radius: 12px; background: var(--bg-glass); border:1px solid var(--stroke); color: var(--text); display:flex; align-items:center; justify-content:center; }
    .badge-total{ display:flex; align-items:center; gap:10px; background: linear-gradient(180deg, rgba(59,130,246,0.18), rgba(59,130,246,0.1)); border:1px solid rgba(96,165,250,0.35); padding:8px 12px; border-radius: 999px; box-shadow: var(--shadow-sm); min-height: 38px; }
    #trip-total-badge{ font-weight:900; }

    .container-main{ padding: 14px; }
    .glass{ background: var(--bg-glass); border:1px solid var(--stroke); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); }
    .section{ margin-top:12px; }

    /* Table styling */
    .table-wrap{ overflow-x:auto; -webkit-overflow-scrolling: touch; border-radius:12px; }
    table.expenses-table{ width:100%; border-collapse:collapse; min-width:720px; }
    table.expenses-table thead th{
      text-align:left; padding:12px 10px; font-weight:800; color:var(--muted); font-size:.85rem; border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    }
    table.expenses-table tbody tr{ border-bottom:1px dashed rgba(255,255,255,0.03); }
    table.expenses-table td{
      padding:10px; vertical-align:middle; font-weight:700; color:var(--text);
    }
    .amount-cell{ font-weight:900; color:var(--success); text-align:right; white-space:nowrap; }

    .cat-badge{ display:inline-block; padding:6px 8px; border-radius:999px; font-weight:800; font-size:.78rem; border:1px solid var(--stroke); background: rgba(255,255,255,0.04); }

    /* Action buttons */
    .action-btn{ min-width:40px; min-height:36px; border-radius:8px; border:1px solid var(--stroke); background: rgba(255,255,255,0.03); color:inherit; padding:8px; margin-left:6px; }
    .action-btn .fas{ font-size:0.92rem; }

    /* Responsive: transformar tabla en "cards" en pantallas peque√±as */
    @media (max-width:720px){
      table.expenses-table{ min-width:100%; display:block; }
      table.expenses-table thead{ display:none; }
      table.expenses-table tbody{ display:block; }
      table.expenses-table tbody tr{ display:block; margin-bottom:12px; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border-radius:12px; padding:10px; }
      table.expenses-table tbody td{ display:flex; justify-content:space-between; padding:8px 10px; }
      table.expenses-table tbody td::before{
        content: attr(data-label);
        color: var(--muted);
        font-weight:800;
        margin-right:8px;
        flex:0 0 45%;
        text-align:left;
      }
      .amount-cell{ text-align:right; }
      .actions-cell{ display:flex; justify-content:flex-end; gap:8px; }
    }

    /* Skeleton / loading */
    .skeleton{ position:relative; overflow:hidden; background: rgba(148,163,184,0.12); border-radius:12px; height:64px; }
    .skeleton::after{ content:""; position:absolute; inset:0; transform: translateX(-100%); background: linear-gradient(90deg, transparent, rgba(255,255,255,0.25), transparent); animation: shimmer 1.2s infinite; }
    @keyframes shimmer{ 100%{ transform: translateX(100%);} }

    /* Other small helpers */
    .loading{ text-align:center; padding:18px 8px; color: var(--muted); }
    .fab{ position:fixed; right: calc(16px + env(safe-area-inset-right, 8px)); bottom: calc(90px + env(safe-area-inset-bottom, 8px)); width:60px; height:60px; border-radius:50%; background: linear-gradient(180deg, rgba(59,130,246,0.9), rgba(59,130,246,0.6)); border:1px solid rgba(96,165,250,0.5); color:#fff; display:flex; align-items:center; justify-content:center; box-shadow: var(--shadow-xl); z-index:1200; }
    .btn-primary{ width:100%; padding:12px; border-radius: 14px; }

    @media (max-width:420px){
      .action-btn{ min-width:48px; min-height:48px; }
      .fab{ width:64px; height:64px; }
    }
  </style>
</head>
<body>
  <!-- Top bar -->
  <header class="topbar">
    <div class="brand">
      <i class="fas fa-plane-departure"></i>
      <h1>Gastos de Viaje</h1>
    </div>
    <div class="top-actions">
      <button id="themeToggle" class="theme-toggle" aria-label="Cambiar tema">
        <i class="fas fa-sun"></i>
      </button>
      <div class="badge-total" title="Total del viaje seleccionado" aria-live="polite">
        <i class="fas fa-wallet"></i>
        <span style="font-weight:800;">Viaje:</span>
        <span id="trip-total-badge">$0</span>
      </div>
    </div>
  </header>

  <main id="appMain" class="container-main" aria-busy="false">
    <!-- Stats -->
    <section class="glass stats-card section" aria-live="polite">
      <div>
        <div class="label">Total (vista actual)</div>
        <div class="amount" id="total-amount">$0</div>
        <div class="label">Con filtros aplicados</div>
      </div>
      <div style="min-width:110px;text-align:right;"></div>
    </section>

    <!-- Filters -->
    <section class="glass chips section">
      <div class="chip">
        <label for="filter-category">Categor√≠a</label>
        <select id="filter-category" class="form-select">
          <option value="">Todas</option>
          <option value="gasolina">Gasolina</option>
          <option value="hotel">Hotel</option>
          <option value="comida">Comida</option>
          <option value="bebida">Bebida</option>
        </select>
      </div>
      <div class="chip">
        <label for="filter-date">Per√≠odo</label>
        <input id="filter-date" type="month" class="form-control"/>
      </div>
      <div class="chip">
        <label for="filter-trip">Viaje</label>
        <select id="filter-trip" class="form-select">
          <option value="">Todas</option>
          <option value="__NO_TRIP__">(Sin viaje)</option>
        </select>
      </div>
    </section>

    <!-- Table: historial -->
    <section class="glass section">
      <div class="table-wrap">
        <table class="expenses-table" aria-describedby="table-desc">
          <caption id="table-desc" style="display:none">Historial de gastos</caption>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Categor√≠a</th>
              <th>Descripci√≥n</th>
              <th style="text-align:right">Monto</th>
              <th>M√©todo</th>
              <th>Viaje</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="expenses-tbody">
            <!-- Rows se insertan v√≠a JS -->
          </tbody>
        </table>
      </div>

      <div class="d-grid gap-2 mt-2">
        <button id="loadMoreBtn" class="btn btn-outline-secondary" style="display:none;">Cargar m√°s</button>
      </div>
    </section>

    <!-- Add / Edit form (igual que antes) -->
    <section class="tab-pane" id="add-form-section" role="region" aria-label="Formulario de gasto">
      <div class="glass form-card" style="margin-top:12px;">
        <h3><i class="fas fa-plus-circle"></i> Registrar / Editar Gasto</h3>
        <form id="expense-form" novalidate>
          <input type="hidden" id="edit-id" value="">
          <div class="mb-3">
            <label class="form-label" for="expense-date">Fecha</label>
            <input type="date" class="form-control" id="expense-date" required />
          </div>
          <div class="mb-3">
            <label class="form-label" for="expense-category">Categor√≠a</label>
            <select class="form-select" id="expense-category" required>
              <option value="">Seleccionar categor√≠a</option>
              <option value="gasolina">üöó Gasolina</option>
              <option value="hotel">üè® Hotel</option>
              <option value="comida">üçΩÔ∏è Comida</option>
              <option value="bebida">ü•§ Bebida</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label" for="expense-description">Descripci√≥n</label>
            <input type="text" class="form-control" id="expense-description" placeholder="Detalles del gasto" required />
            <div class="form-text">M√≠nimo 3 caracteres.</div>
          </div>
          <div class="mb-3">
            <label class="form-label" for="expense-amount">Monto</label>
            <input type="number" class="form-control" id="expense-amount" placeholder="0" step="1" min="0" required />
            <div class="d-flex justify-content-between mt-2" style="color:var(--muted);">
              <small><strong>Total actual (viaje):</strong></small>
              <small id="current-total-form" style="font-weight:900;">$0</small>
            </div>
            <div class="d-flex justify-content-between" style="color:var(--muted);">
              <small><strong>Total si guardas (viaje):</strong></small>
              <small id="projected-total-form" style="font-weight:900;">$0</small>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label" for="expense-payment-method">M√©todo de Pago</label>
            <select class="form-select" id="expense-payment-method">
              <option value="Efectivo">üíµ Efectivo</option>
              <option value="Tarjeta de Cr√©dito">üí≥ Tarjeta de Cr√©dito</option>
              <option value="Tarjeta de D√©bito">üí≥ Tarjeta de D√©bito</option>
              <option value="Transferencia">üì± Transferencia</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label" for="expense-trip">Viaje (Opcional)</label>
            <input type="text" class="form-control" id="expense-trip" placeholder="Identificador del viaje" />
          </div>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-check-circle me-2"></i> <span id="submitLabel">Guardar Gasto</span>
            </button>
            <button type="button" id="btnClearForm" class="btn btn-outline-secondary">Limpiar</button>
          </div>
        </form>
      </div>
    </section>

  </main>

  <!-- FAB -->
  <button class="fab" id="openFormFab" aria-label="Agregar gasto">
    <i class="fas fa-plus"></i>
  </button>

  <!-- Toast -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:1300">
    <div id="appToast" class="toast text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg">Mensaje</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- App JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy, updateDoc,
      limit, startAfter, serverTimestamp, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* ===== Firebase config (mismo que usas) ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyCg9A5CbpKOLV6WspRz87bhWT3wJVbWXDE",
      authDomain: "crm-gastos-viaje.firebaseapp.com",
      projectId: "crm-gastos-viaje",
      storageBucket: "crm-gastos-viaje.firebasestorage.app",
      messagingSenderId: "1030088242238",
      appId: "1:1030088242238:web:53c2dcb3fc6642f82e4d6f"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ===== Helpers ===== */
    const $ = (sel)=> document.querySelector(sel);
    function formatDate(date){
      try{ if(!(date instanceof Date)) date = new Date(date); if(isNaN(date)) return ''; return date.toLocaleDateString('es-CO',{year:'numeric',month:'short',day:'numeric'}); }
      catch{ return ''; }
    }
    function formatCurrency(n){ n = Number(n)||0; return `$${new Intl.NumberFormat('es-CO').format(Math.round(n))}`; }
    function debounce(fn, wait=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

    // Toast API
    const toastEl = $("#appToast");
    let toast = new bootstrap.Toast(toastEl, { delay: 2500 });
    function showToast(msg, type="primary"){ $("#toastMsg").textContent = msg; toastEl.className = `toast text-bg-${type} border-0`; toast.show(); }

    // Theme toggle
    const themeToggle = $("#themeToggle");
    function applyTheme(theme){ document.documentElement.setAttribute("data-theme", theme); themeToggle.innerHTML = theme === "dark" ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; }
    const savedTheme = localStorage.getItem("theme");
    applyTheme(savedTheme || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light"));
    themeToggle.addEventListener("click", ()=>{
      const current = document.documentElement.getAttribute("data-theme");
      const next = current === "dark" ? "light" : "dark";
      applyTheme(next); localStorage.setItem("theme", next);
    });

    /* ===== Estado / paginaci√≥n ===== */
    const pageSize = 10;
    let lastVisible = null;
    let moreAvailable = false;
    const categoryNames  = { gasolina:"Gasolina", hotel:"Hotel", comida:"Comida", bebida:"Bebida" };
    const categoryColors = { gasolina:getComputedStyle(document.documentElement).getPropertyValue('--gasolina').trim() || "#60a5fa", hotel:getComputedStyle(document.documentElement).getPropertyValue('--hotel').trim() || "#a78bfa", comida:getComputedStyle(document.documentElement).getPropertyValue('--comida').trim() || "#34d399", bebida:getComputedStyle(document.documentElement).getPropertyValue('--bebida').trim() || "#f59e0b" };
    const tripTotals = {};

    /* ===== Utilities de formulario ===== */
    function clearFormFields(){
      $("#edit-id").value = "";
      const today = new Date().toISOString().slice(0,10);
      $("#expense-date").value = today;
      $("#expense-category").value = "";
      $("#expense-description").value = "";
      $("#expense-amount").value = "";
      $("#expense-payment-method").value = "Efectivo";
      $("#expense-trip").value = "";
      $("#current-total-form").textContent = formatCurrency(0);
      $("#projected-total-form").textContent = formatCurrency(0);
      $("#submitLabel").textContent = "Guardar Gasto";
      document.activeElement.blur && document.activeElement.blur();
    }

    /* ===== Firestore helpers: trips & totals ===== */
    async function fetchTripsAndPopulate(){
      try{
        const snap = await getDocs(collection(db,"travel_expenses"));
        const set = new Set();
        snap.forEach(d=>{
          const t = d.data().trip;
          if(t && String(t).trim()!=='') set.add(String(t));
        });
        const sel = $("#filter-trip");
        sel.querySelectorAll('option:not([value=""]):not([value="__NO_TRIP__"])').forEach(o=>o.remove());
        Array.from(set).sort().forEach(tr=>{
          const opt = document.createElement('option'); opt.value = tr; opt.textContent = tr; sel.appendChild(opt);
        });
      }catch(e){ console.error("Trips error:",e); }
    }

    async function computeTotalForTrip(tripKey){
      if(tripTotals.hasOwnProperty(tripKey) && typeof tripTotals[tripKey]==='number') return tripTotals[tripKey];
      try{
        const base = collection(db,"travel_expenses");
        let qy;
        if(tripKey==="") qy=query(base);
        else if(tripKey==="__NO_TRIP__") qy=query(base, where("trip","==",null));
        else qy=query(base, where("trip","==",tripKey));
        const snap = await getDocs(qy);
        let tot=0; snap.forEach(s=> tot += Number(s.data().amount)||0 );
        tripTotals[tripKey]=tot; return tot;
      }catch(e){ console.error("Total trip error:",e); return 0; }
    }

    /* ===== Construir query con filtros ===== */
    function buildBaseQuery(applyFilters=true){
      const base = collection(db,"travel_expenses");
      const cs = [];
      if(!applyFilters) return query(base, orderBy("date","desc"));
      const category = $("#filter-category").value;
      const monthVal = $("#filter-date").value;
      const tripVal  = $("#filter-trip").value;
      if(category) cs.push(where("category","==",category));
      if(monthVal){
        const [y,m]=monthVal.split('-');
        const start = new Date(Date.UTC(parseInt(y), parseInt(m)-1, 1));
        const end   = new Date(Date.UTC(parseInt(y), parseInt(m),   1));
        cs.push(where("date",">=", Timestamp.fromDate(start)));
        cs.push(where("date","<",  Timestamp.fromDate(end)));
      }
      if(tripVal){
        if(tripVal==="__NO_TRIP__") cs.push(where("trip","==",null));
        else cs.push(where("trip","==",tripVal));
      }
      return cs.length ? query(base, ...cs, orderBy("date","desc")) : query(base, orderBy("date","desc"));
    }

    /* ===== Cargar gastos y poblar tabla ===== */
    function renderSkeletonRows(){
      const tbody = $("#expenses-tbody");
      tbody.innerHTML = `<tr><td colspan="7"><div class="skeleton"></div></td></tr><tr><td colspan="7"><div class="skeleton"></div></td></tr>`;
    }

    async function loadExpenses(reset=true){
      const tbody = $("#expenses-tbody");
      const loadMoreBtn = $("#loadMoreBtn");
      if(reset){ lastVisible = null; moreAvailable = false; renderSkeletonRows(); tbody.innerHTML = ''; }
      try{
        const baseQuery = buildBaseQuery(true);
        let qy = lastVisible ? query(baseQuery, startAfter(lastVisible), limit(pageSize)) : query(baseQuery, limit(pageSize));
        const snap = await getDocs(qy);
        if(reset) tbody.innerHTML = '';
        if(snap.empty && reset){
          tbody.innerHTML = `<tr><td colspan="7" class="loading">No hay gastos con estos filtros</td></tr>`;
          updateStats(0, { gasolina:0, hotel:0, comida:0, bebida:0 });
          const t = await computeTotalForTrip($("#filter-trip").value || "");
          $("#trip-total-badge").textContent = formatCurrency(t);
          loadMoreBtn.style.display = 'none';
          return;
        }

        // acumular totales de la p√°gina
        let totalPage = 0;
        const tot = { gasolina:0, hotel:0, comida:0, bebida:0 };

        snap.forEach(d=>{
          const e = { id:d.id, ...d.data() };
          const amt = Number(e.amount)||0; totalPage += amt;
          if(tot.hasOwnProperty(e.category)) tot[e.category] += amt;

          // fecha
          const dd = e.date && e.date.toDate ? e.date.toDate() : new Date(e.date);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td data-label="Fecha">${formatDate(dd)}</td>
            <td data-label="Categor√≠a"><span class="cat-badge" style="color:${categoryColors[e.category] || '#fff'}">${categoryNames[e.category]||'Otra'}</span></td>
            <td data-label="Descripci√≥n">${e.description || 'Sin descripci√≥n'}</td>
            <td data-label="Monto" class="amount-cell">${formatCurrency(amt)}</td>
            <td data-label="M√©todo">${e.paymentMethod || 'No especificado'}</td>
            <td data-label="Viaje">${e.trip || ''}</td>
            <td data-label="Acciones" class="actions-cell" style="white-space:nowrap">
              <button class="action-btn edit" data-id="${e.id}" title="Editar"><i class="fas fa-edit"></i></button>
              <button class="action-btn delete" data-id="${e.id}" title="Eliminar"><i class="fas fa-trash"></i></button>
            </td>
          `;
          tbody.appendChild(row);
        });

        lastVisible = snap.docs[snap.docs.length - 1];
        moreAvailable = snap.size === pageSize;
        loadMoreBtn.style.display = moreAvailable ? 'block' : 'none';

        updateStats(totalPage, tot);

        // Delegaci√≥n de eventos: edit / delete
        // eliminamos y reasignamos para evitar duplicados: (simple approach)
        tbody.querySelectorAll(".action-btn.delete").forEach(btn=>{
          btn.removeEventListener?.('click', onDeleteClick);
          btn.addEventListener('click', onDeleteClick);
        });
        tbody.querySelectorAll(".action-btn.edit").forEach(btn=>{
          btn.removeEventListener?.('click', onEditClick);
          btn.addEventListener('click', onEditClick);
        });

        // trip badge global
        const tripTotal = await computeTotalForTrip($("#filter-trip").value || "");
        $("#trip-total-badge").textContent = formatCurrency(tripTotal);
        fetchTripsAndPopulate().catch(()=>{});
      }catch(e){
        console.error("Load error:", e);
        tbody.innerHTML = `<tr><td colspan="7" class="loading">Error al cargar. Reintenta.</td></tr>`;
        showToast("Error al cargar gastos", "danger");
        $("#loadMoreBtn").style.display = 'none';
      }
    }

    function onDeleteClick(e){
      const id = e.currentTarget.getAttribute('data-id');
      deleteExpense(id).then(()=> goToFirstPageAndRefresh()).catch(()=>{});
    }
    function onEditClick(e){
      const id = e.currentTarget.getAttribute('data-id');
      loadExpenseIntoForm(id).then(()=> {
        // scroll to form for/mobile, focus first input
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }).catch(()=>{});
    }

    async function loadMore(){ if(!moreAvailable) return; await loadExpenses(false); }
    async function goToFirstPageAndRefresh(){ lastVisible = null; await loadExpenses(true); }

    /* ===== CRUD ===== */
    async function addExpense(data){
      try{
        const [y,m,d] = data.date.split('-');
        const dateUTC = new Date(Date.UTC(parseInt(y), parseInt(m)-1, parseInt(d)));
        await addDoc(collection(db,"travel_expenses"), {
          ...data, date: Timestamp.fromDate(dateUTC), createdAt: serverTimestamp()
        });
        const k = data.trip && String(data.trip).trim()!=='' ? String(data.trip) : "__NO_TRIP__";
        tripTotals[k] = undefined; tripTotals[""] = undefined;
        return true;
      }catch(e){ console.error("Add error:",e); return false; }
    }

    async function updateExpense(id, data){
      try{
        const [y,m,d] = data.date.split('-');
        const dateUTC = new Date(Date.UTC(parseInt(y), parseInt(m)-1, parseInt(d)));
        await updateDoc(doc(db,"travel_expenses", id), { ...data, date: Timestamp.fromDate(dateUTC), updatedAt: serverTimestamp() });
        for(const k in tripTotals) tripTotals[k] = undefined;
        return true;
      }catch(e){ console.error("Update error:",e); return false; }
    }

    async function deleteExpense(id){
      if(!confirm('¬øEliminar este gasto?')) return;
      try{
        await deleteDoc(doc(db,"travel_expenses", id));
        for(const k in tripTotals) tripTotals[k] = undefined;
        showToast("Gasto eliminado", "primary");
      }catch(e){ console.error("Delete error:",e); showToast("Error al eliminar", "danger"); }
    }

    /* ===== Load single expense into form for editing ===== */
    async function loadExpenseIntoForm(id){
      try{
        const q = query(collection(db,"travel_expenses"), where('__name__','==', id));
        const snap = await getDocs(q);
        if(snap.empty){ showToast("No se encontr√≥ el gasto", "danger"); return; }
        const data = snap.docs[0].data();
        $("#edit-id").value = id;
        $("#expense-date").value = (data.date && data.date.toDate) ? data.date.toDate().toISOString().slice(0,10) : new Date().toISOString().slice(0,10);
        $("#expense-category").value = data.category || '';
        $("#expense-description").value = data.description || '';
        $("#expense-amount").value = data.amount || '';
        $("#expense-payment-method").value = data.paymentMethod || 'Efectivo';
        $("#expense-trip").value = data.trip || '';
        $("#submitLabel").textContent = 'Actualizar Gasto';
        const key = $("#expense-trip").value && $("#expense-trip").value.trim()!=='' ? $("#expense-trip").value.trim() : "";
        const tot = await computeTotalForTrip(key==="" ? "" : key);
        $("#current-total-form").textContent = formatCurrency(tot);
        const amt = Number($("#expense-amount").value)||0;
        $("#projected-total-form").textContent = formatCurrency(tot + amt);
        // abrir/mostrar form (scroll)
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }catch(e){ console.error("Load for edit error:", e); showToast("Error al cargar gasto para edici√≥n", "danger"); }
    }

    /* ===== Stats & Chart (igual comportamiento) ===== */
    function updateStats(totalAmount, catTotals){
      $("#total-amount").textContent   = formatCurrency(totalAmount);
      $("#gasolina-amount")?.textContent && ($("#gasolina-amount").textContent = formatCurrency(catTotals.gasolina || 0));
      $("#hotel-amount")?.textContent && ($("#hotel-amount").textContent = formatCurrency(catTotals.hotel || 0));
      $("#comida-amount")?.textContent && ($("#comida-amount").textContent = formatCurrency(catTotals.comida || 0));
      $("#bebida-amount")?.textContent && ($("#bebida-amount").textContent = formatCurrency(catTotals.bebida || 0));
      // no reconstrui el chart aqu√≠ para mantener simplicidad; si quieres lo integro de nuevo
    }

    /* ===== Form validation & ARIA busy ===== */
    function setBusy(isBusy){
      const main = $("#appMain");
      main.setAttribute('aria-busy', String(!!isBusy));
      document.body.setAttribute('aria-busy', String(!!isBusy));
    }

    function validateFormData(data){
      if(!data.date) return { ok:false, msg:'Selecciona una fecha' };
      if(!data.category) return { ok:false, msg:'Selecciona una categor√≠a' };
      if(!data.description || String(data.description).trim().length < 3) return { ok:false, msg:'La descripci√≥n debe tener al menos 3 caracteres' };
      if(!data.amount || Number(data.amount) <= 0) return { ok:false, msg:'El monto debe ser mayor a cero' };
      return { ok:true };
    }

    /* ===== Eventos UI principales ===== */
    document.addEventListener("DOMContentLoaded", async ()=>{
      const today = new Date();
      $("#expense-date").value = today.toISOString().split('T')[0];
      $("#filter-date").value  = today.toISOString().slice(0,7);

      await fetchTripsAndPopulate();
      await loadExpenses(true);

      $("#loadMoreBtn").addEventListener("click", async ()=>{ await loadMore(); });

      // Limpiar form
      $("#btnClearForm").addEventListener("click", ()=> clearFormFields());

      // Submit (add/update)
      $("#expense-form").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const btn = e.currentTarget.querySelector('button[type="submit"]');
        const labelSpan = $("#submitLabel");
        btn.disabled = true;
        labelSpan.textContent = labelSpan.textContent.includes('Actualizar') ? 'Procesando...' : 'Guardando...';
        setBusy(true);
        try{
          const idEdit = $("#edit-id").value || '';
          const data = {
            date: $("#expense-date").value,
            category: $("#expense-category").value,
            description: $("#expense-description").value && $("#expense-description").value.trim(),
            amount: Number($("#expense-amount").value),
            paymentMethod: $("#expense-payment-method").value,
            trip: ($("#expense-trip").value || null)
          };

          const v = validateFormData(data);
          if(!v.ok){ showToast(v.msg, 'danger'); return; }

          if(idEdit){
            const ok = await updateExpense(idEdit, data);
            if(ok){ showToast('‚úÖ Gasto actualizado', 'primary'); clearFormFields(); }
            else showToast('‚ùå Error al actualizar', 'danger');
          }else{
            const ok = await addExpense(data);
            if(ok){ showToast('‚úÖ Gasto registrado', 'primary'); clearFormFields(); }
            else showToast('‚ùå Error al registrar', 'danger');
          }

          await fetchTripsAndPopulate();
          await goToFirstPageAndRefresh();
        } finally {
          btn.disabled = false;
          labelSpan.textContent = 'Guardar Gasto';
          setBusy(false);
        }
      });

      // filtros -> recargar
      const debouncedReload = debounce(()=> goToFirstPageAndRefresh(), 250);
      $("#filter-category").addEventListener("change", debouncedReload);
      $("#filter-date").addEventListener("change", debouncedReload);
      $("#filter-trip").addEventListener("change", async function(){
        const total = await computeTotalForTrip(this.value || "");
        $("#trip-total-badge").textContent = formatCurrency(total);
        debouncedReload();
      });

      // live totals in form
      const debouncedComputeTripForm = debounce(async (tripText)=>{
        const key = tripText && tripText.trim()!=='' ? tripText.trim() : "";
        const tot = await computeTotalForTrip(key==="" ? "" : key);
        $("#current-total-form").textContent   = formatCurrency(tot);
        const amt = Number($("#expense-amount").value)||0;
        $("#projected-total-form").textContent = formatCurrency(tot + amt);
      }, 300);

      $("#expense-trip").addEventListener("input", function(){ debouncedComputeTripForm(this.value); });
      $("#expense-amount").addEventListener("input", ()=> {
        const amt = Number($("#expense-amount").value)||0;
        const tripText = $("#expense-trip").value;
        const key = tripText && tripText.trim()!=='' ? tripText.trim() : "";
        const current = (tripTotals.hasOwnProperty(key) && typeof tripTotals[key]==='number') ? tripTotals[key] : 0;
        $("#projected-total-form").textContent = formatCurrency(current + amt);
      });

      // FAB abre form (scroll)
      $("#openFormFab").addEventListener("click", ()=>{
        clearFormFields();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

    }); // DOMContentLoaded end

  </script>
</body>
</html>