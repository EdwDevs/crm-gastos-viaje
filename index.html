<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <!-- Nueva UI mobile-first con soporte safe-area y zoom -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>CRM Gastos Viaje</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

  <style>
    :root{
      --bg-grad-1:#0f172a; /* slate-900 */
      --bg-grad-2:#111827; /* gray-900 */
      --glass: rgba(255,255,255,0.08);
      --glass-2: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.12);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --primary:#60a5fa;  /* blue-400 */
      --primary-2:#3b82f6;/* blue-500 */
      --success:#34d399;  /* emerald-400 */
      --danger:#f87171;   /* red-400 */

      --gasolina:#60a5fa;
      --hotel:#a78bfa;
      --comida:#34d399;
      --bebida:#f59e0b;

      --radius:16px;
      --radius-sm:12px;
      --shadow-xl: 0 20px 45px rgba(0,0,0,0.35);
      --shadow-md: 0 10px 25px rgba(0,0,0,0.25);
      --shadow-sm: 0 6px 16px rgba(0,0,0,0.2);
    }

    html { font-size: clamp(14px, 2.2vw, 16px); }
    *{ box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body{
      margin:0;
      min-height:100vh;
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 100% -10%, #1f2937 0%, transparent 50%),
        radial-gradient(1000px 700px at -10% 0%, #111827 0%, transparent 50%),
        linear-gradient(180deg, var(--bg-grad-1), var(--bg-grad-2));
      padding-bottom: calc(76px + env(safe-area-inset-bottom, 12px));
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }

    /* Top App Bar */
    .topbar{
      position: sticky; top:0; z-index: 1000;
      padding: calc(10px + env(safe-area-inset-top, 6px)) 16px 10px;
      background: linear-gradient(180deg, rgba(17,24,39,0.85), rgba(17,24,39,0.55));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand i{ color: var(--primary); font-size: 1.15rem; }
    .brand h1{ margin:0; font-size:1rem; letter-spacing:.3px; font-weight:800; }

    .badge-total{
      display:flex; align-items:center; gap:10px;
      background: linear-gradient(180deg, rgba(59,130,246,0.25), rgba(59,130,246,0.12));
      border:1px solid rgba(96,165,250,0.35);
      padding:8px 12px; border-radius: 999px;
      box-shadow: var(--shadow-sm);
      min-height: 38px;
    }
    .badge-total i{ color: var(--primary); }
    #trip-total-badge{ font-weight:900; color:#fff; }

    /* Container */
    .container-main{ padding: 14px; }

    /* Cards glass */
    .glass{
      background: var(--glass);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
    }

    /* Stats header card */
    .stats-card{
      display:flex; justify-content:space-between; align-items:center; gap:14px;
      padding:14px;
    }
    .stats-card .label{ color: var(--muted); font-weight:600; font-size:.9rem; }
    .stats-card .amount{
      font-weight:900; font-size:1.6rem;
      background: linear-gradient(90deg, var(--success), #10b981);
      -webkit-background-clip:text; color:transparent;
    }

    /* Filters bar (chips) */
    .filters{
      display:grid; grid-template-columns: 1fr; gap:10px; margin-top:12px; padding:12px;
    }
    @media (min-width: 380px){
      .filters{ grid-template-columns: repeat(3, 1fr); }
    }
    .chip{
      display:flex; flex-direction:column; gap:6px;
    }
    .chip label{ color: var(--muted); font-weight:700; font-size:.85rem; margin:0 2px; }
    .chip .form-control, .chip .form-select{
      background: var(--glass-2); color: var(--text);
      border:1px solid var(--stroke);
      border-radius: var(--radius-sm); padding:10px 12px; font-size:16px;
    }
    .chip .form-control:focus, .chip .form-select:focus{
      outline:none; border-color: rgba(96,165,250,0.55);
      box-shadow: 0 0 0 4px rgba(96,165,250,0.18);
    }

    /* Category tiles */
    .category-grid{
      margin-top:12px; display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;
    }
    .cat-tile{
      padding:12px; text-align:center; border-radius: var(--radius-sm);
      background: var(--glass);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow-sm);
    }
    .cat-tile .value{ font-weight:800; font-size:1.05rem; margin-top:6px; }
    .gas .value{ color: var(--gasolina); }
    .hot .value{ color: var(--hotel); }
    .food .value{ color: var(--comida); }
    .drink .value{ color: var(--bebida); }

    /* Tabs redesigned */
    .nav-tabs{
      margin-top:12px; border: 1px solid var(--stroke); border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      overflow: hidden;
    }
    .nav-tabs .nav-link{
      border:none; color: var(--muted); font-weight:800; letter-spacing:.3px;
      padding:12px 14px;
    }
    .nav-tabs .nav-link.active{
      color:#fff; background: linear-gradient(180deg, rgba(59,130,246,0.35), rgba(59,130,246,0.15));
      border-right: 1px solid var(--stroke);
    }

    /* Expense list */
    .expense-list{ margin-top:12px; }
    .expense-item{
      display:block; padding:12px; margin-bottom:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
      border:1px solid var(--stroke); border-left:4px solid var(--primary-2);
      border-radius: var(--radius-sm); box-shadow: var(--shadow-sm);
    }
    .expense-item.gasolina{ border-left-color: var(--gasolina); }
    .expense-item.hotel{ border-left-color: var(--hotel); }
    .expense-item.comida{ border-left-color: var(--comida); }
    .expense-item.bebida{ border-left-color: var(--bebida); }

    .expense-header{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .expense-date{ color: var(--muted); font-weight:700; font-size:.9rem; }
    .expense-amount{ font-weight:900; color: var(--success); }

    .expense-category{
      display:inline-block; margin-top:8px; padding:6px 10px; border-radius: 999px; font-weight:800; font-size:.82rem;
      border:1px solid var(--stroke); background: rgba(255,255,255,0.06);
    }
    .gasolina-category{ color: var(--gasolina); }
    .hotel-category{ color: var(--hotel); }
    .comida-category{ color: var(--comida); }
    .bebida-category{ color: var(--bebida); }

    .expense-description{ margin-top:8px; font-weight:700; }
    .expense-footer{
      display:flex; justify-content:space-between; align-items:center;
      margin-top:10px; padding-top:10px; border-top: 1px dashed var(--stroke); color: var(--muted);
    }
    .action-btn{
      min-width:44px; min-height:44px; border-radius: 10px; border:1px solid var(--stroke);
      background: var(--glass-2); color: #fff;
    }

    /* Forms */
    .form-card{ padding:14px; margin-top:12px; }
    .form-card h3{ margin:0 0 10px; display:flex; gap:8px; align-items:center; font-size:1rem; color:#fff; }
    .form-label{ color: var(--muted); font-weight:700; }

    .btn-primary{
      width:100%; padding:12px; border-radius: 12px; border: 1px solid rgba(96,165,250,0.35);
      background: linear-gradient(180deg, rgba(59,130,246,0.35), rgba(59,130,246,0.22));
      color:#fff; font-weight:900; letter-spacing:.3px;
      box-shadow: var(--shadow-md);
    }
    .btn-primary:active{ transform: translateY(1px); }

    /* Chart container */
    .chart-wrap{ margin:14px 0 0; padding:12px; }
    canvas#expenses-chart{ width:100%; height:240px; }

    /* FAB */
    .fab{
      position:fixed;
      right: calc(16px + env(safe-area-inset-right, 8px));
      bottom: calc(90px + env(safe-area-inset-bottom, 8px));
      width:60px; height:60px; border-radius:50%;
      background: linear-gradient(180deg, rgba(59,130,246,0.9), rgba(59,130,246,0.6));
      border:1px solid rgba(96,165,250,0.5); color:#fff;
      display:flex; align-items:center; justify-content:center;
      box-shadow: var(--shadow-xl);
      z-index:1200;
    }

    /* Bottom nav */
    .bottom-nav{
      position: fixed; left:0; right:0; bottom:0; z-index:1100;
      height: 64px; padding-bottom: env(safe-area-inset-bottom, 6px);
      display:flex; align-items:center; justify-content:space-around; gap:6px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      backdrop-filter: blur(8px);
      border-top: 1px solid var(--stroke);
    }
    .bottom-nav .nav-item{ display:flex; flex-direction:column; align-items:center; gap:4px; color: var(--muted); font-weight:800; font-size:.78rem; }
    .bottom-nav .nav-item.active{ color:#fff; }

    /* Loading */
    .loading{ text-align:center; padding:18px 8px; color: var(--muted); }
    .spinner{ border:4px solid rgba(96,165,250,0.12); border-top:4px solid var(--primary);
      width:36px; height:36px; border-radius:50%; animation: spin 1s linear infinite; margin: 8px auto; }
    @keyframes spin{ 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }

    /* Accessibility */
    @media (max-width:480px){
      .category-grid{ grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <!-- Top bar -->
  <header class="topbar">
    <div class="brand">
      <i class="fas fa-plane-departure"></i>
      <h1>Gastos de Viaje</h1>
    </div>
    <div class="badge-total" title="Total del viaje seleccionado" aria-live="polite">
      <i class="fas fa-wallet"></i>
      <span style="color:#dbeafe;font-weight:800;">Viaje:</span>
      <span id="trip-total-badge">$0</span>
    </div>
  </header>

  <main class="container-main">
    <!-- Stats -->
    <section class="glass stats-card" aria-live="polite">
      <div>
        <div class="label">Total (vista actual)</div>
        <div class="amount" id="total-amount">$0</div>
        <div class="label">Con filtros aplicados</div>
      </div>
      <div style="min-width:110px;text-align:right;">
        <!-- espacio lateral -->
      </div>
    </section>

    <!-- Filters -->
    <section class="glass filters">
      <div class="chip">
        <label for="filter-category">Categoría</label>
        <select id="filter-category" class="form-select">
          <option value="">Todas</option>
          <option value="gasolina">Gasolina</option>
          <option value="hotel">Hotel</option>
          <option value="comida">Comida</option>
          <option value="bebida">Bebida</option>
        </select>
      </div>
      <div class="chip">
        <label for="filter-date">Período</label>
        <input id="filter-date" type="month" class="form-control"/>
      </div>
      <div class="chip">
        <label for="filter-trip">Viaje</label>
        <select id="filter-trip" class="form-select">
          <option value="">Todas</option>
          <option value="__NO_TRIP__">(Sin viaje)</option>
        </select>
      </div>
    </section>

    <!-- Category tiles -->
    <section class="category-grid">
      <div class="cat-tile gas">
        <div style="color:#cbd5e1;font-weight:700;">Gasolina</div>
        <div class="value" id="gasolina-amount">$0</div>
      </div>
      <div class="cat-tile hot">
        <div style="color:#cbd5e1;font-weight:700;">Hotel</div>
        <div class="value" id="hotel-amount">$0</div>
      </div>
      <div class="cat-tile food">
        <div style="color:#cbd5e1;font-weight:700;">Comida</div>
        <div class="value" id="comida-amount">$0</div>
      </div>
      <div class="cat-tile drink">
        <div style="color:#cbd5e1;font-weight:700;">Bebida</div>
        <div class="value" id="bebida-amount">$0</div>
      </div>
    </section>

    <!-- Tabs -->
    <ul class="nav nav-tabs glass" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses" type="button" role="tab">
          <i class="fas fa-list"></i> Gastos
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">
          <i class="fas fa-plus-circle"></i> Agregar
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
          <i class="fas fa-chart-pie"></i> Reportes
        </button>
      </li>
    </ul>

    <div class="tab-content" id="myTabContent">
      <!-- GASTOS -->
      <div class="tab-pane fade show active" id="expenses" role="tabpanel">
        <div id="expense-list" class="expense-list">
          <div class="loading">
            <div class="spinner" role="status" aria-hidden="true"></div>
            <p>Cargando gastos...</p>
          </div>
        </div>
      </div>

      <!-- AGREGAR -->
      <div class="tab-pane fade" id="add" role="tabpanel">
        <div class="glass form-card">
          <h3><i class="fas fa-plus-circle"></i> Registrar Gasto</h3>
          <form id="expense-form" novalidate>
            <div class="mb-3">
              <label class="form-label" for="expense-date">Fecha</label>
              <input type="date" class="form-control" id="expense-date" required />
            </div>
            <div class="mb-3">
              <label class="form-label" for="expense-category">Categoría</label>
              <select class="form-select" id="expense-category" required>
                <option value="">Seleccionar categoría</option>
                <option value="gasolina">🚗 Gasolina</option>
                <option value="hotel">🏨 Hotel</option>
                <option value="comida">🍽️ Comida</option>
                <option value="bebida">🥤 Bebida</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label" for="expense-description">Descripción</label>
              <input type="text" class="form-control" id="expense-description" placeholder="Detalles del gasto" required />
            </div>
            <div class="mb-3">
              <label class="form-label" for="expense-amount">Monto</label>
              <input type="number" class="form-control" id="expense-amount" placeholder="0" step="1" min="0" required />
              <div class="d-flex justify-content-between mt-2" style="color:var(--muted);">
                <small><strong>Total actual (viaje):</strong></small>
                <small id="current-total-form" style="font-weight:900;color:#fff;">$0</small>
              </div>
              <div class="d-flex justify-content-between" style="color:var(--muted);">
                <small><strong>Total si guardas (viaje):</strong></small>
                <small id="projected-total-form" style="font-weight:900;color:#fff;">$0</small>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label" for="expense-payment-method">Método de Pago</label>
              <select class="form-select" id="expense-payment-method">
                <option value="Efectivo">💵 Efectivo</option>
                <option value="Tarjeta de Crédito">💳 Tarjeta de Crédito</option>
                <option value="Tarjeta de Débito">💳 Tarjeta de Débito</option>
                <option value="Transferencia">📱 Transferencia</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label" for="expense-trip">Viaje (Opcional)</label>
              <input type="text" class="form-control" id="expense-trip" placeholder="Identificador del viaje" />
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-check-circle me-2"></i> Guardar Gasto
            </button>
          </form>
        </div>
      </div>

      <!-- REPORTES -->
      <div class="tab-pane fade" id="reports" role="tabpanel">
        <div class="glass form-card">
          <h3><i class="fas fa-chart-pie"></i> Distribución de Gastos</h3>
          <div class="glass chart-wrap">
            <canvas id="expenses-chart"></canvas>
          </div>
          <div class="category-grid" style="margin-top:12px;">
            <div class="cat-tile gas"><div style="color:#cbd5e1;font-weight:700;">Gasolina</div><div class="value" id="report-gasolina">0%</div></div>
            <div class="cat-tile hot"><div style="color:#cbd5e1;font-weight:700;">Hotel</div><div class="value" id="report-hotel">0%</div></div>
            <div class="cat-tile food"><div style="color:#cbd5e1;font-weight:700;">Comida</div><div class="value" id="report-comida">0%</div></div>
            <div class="cat-tile drink"><div style="color:#cbd5e1;font-weight:700;">Bebida</div><div class="value" id="report-bebida">0%</div></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- FAB -->
  <button class="fab" data-bs-toggle="tab" data-bs-target="#add" aria-label="Agregar gasto">
    <i class="fas fa-plus"></i>
  </button>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav" role="navigation" aria-label="Navegación">
    <div class="nav-item active"><i class="fas fa-home"></i><small>Inicio</small></div>
    <div class="nav-item"><i class="fas fa-receipt"></i><small>Gastos</small></div>
    <div class="nav-item"><i class="fas fa-chart-bar"></i><small>Reportes</small></div>
    <div class="nav-item"><i class="fas fa-user-circle"></i><small>Perfil</small></div>
  </nav>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- App JS (misma lógica; UI renovada) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCg9A5CbpKOLV6WspRz87bhWT3wJVbWXDE",
      authDomain: "crm-gastos-viaje.firebaseapp.com",
      projectId: "crm-gastos-viaje",
      storageBucket: "crm-gastos-viaje.firebasestorage.app",
      messagingSenderId: "1030088242238",
      appId: "1:1030088242238:web:53c2dcb3fc6642f82e4d6f"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const categoryNames  = { gasolina:"Gasolina", hotel:"Hotel", comida:"Comida", bebida:"Bebida" };
    const categoryColors = { gasolina:"#60a5fa", hotel:"#a78bfa", comida:"#34d399", bebida:"#f59e0b" };

    const tripTotals = {}; // cache por viaje

    const $ = (sel)=> document.querySelector(sel);

    function formatDate(date){
      try{
        if(!(date instanceof Date)) date = new Date(date);
        if(isNaN(date)) return '';
        return date.toLocaleDateString('es-CO',{year:'numeric',month:'short',day:'numeric'});
      }catch{return '';}
    }
    function formatCurrency(n){ n = Number(n)||0; return `$${new Intl.NumberFormat('es-CO').format(Math.round(n))}`; }
    function debounce(fn, wait=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

    /* ---------- Trips (dropdown) ---------- */
    async function fetchTripsAndPopulate(){
      try{
        const snap = await getDocs(collection(db,"travel_expenses"));
        const set = new Set();
        snap.forEach(d=>{
          const t = d.data().trip;
          if(t && String(t).trim()!=='') set.add(String(t));
        });
        const sel = $("#filter-trip");
        sel.querySelectorAll('option:not([value=""]):not([value="__NO_TRIP__"])').forEach(o=>o.remove());
        Array.from(set).sort().forEach(tr=>{
          const opt = document.createElement('option'); opt.value = tr; opt.textContent = tr; sel.appendChild(opt);
        });
      }catch(e){ console.error("Trips error:",e); }
    }

    async function computeTotalForTrip(tripKey){
      if(tripTotals.hasOwnProperty(tripKey) && typeof tripTotals[tripKey]==='number') return tripTotals[tripKey];
      try{
        const base = collection(db,"travel_expenses");
        let q;
        if(tripKey==="") q=query(base);
        else if(tripKey==="__NO_TRIP__") q=query(base, where("trip","==",null));
        else q=query(base, where("trip","==",tripKey));
        const snap = await getDocs(q);
        let tot=0; snap.forEach(s=> tot += Number(s.data().amount)||0 );
        tripTotals[tripKey]=tot; return tot;
      }catch(e){ console.error("Total trip error:",e); return 0; }
    }

    /* ---------- Carga de gastos (con filtros) ---------- */
    async function loadExpenses(){
      const list = $("#expense-list");
      list.innerHTML = `<div class="loading"><div class="spinner"></div><p>Cargando gastos...</p></div>`;
      try{
        const category = $("#filter-category").value;
        const monthVal = $("#filter-date").value;
        const tripVal  = $("#filter-trip").value;

        const base = collection(db,"travel_expenses");
        const cs   = [];

        if(category) cs.push(where("category","==",category));
        if(monthVal){
          const [y,m]=monthVal.split('-');
          const start = new Date(Date.UTC(parseInt(y), parseInt(m)-1, 1));
          const end   = new Date(Date.UTC(parseInt(y), parseInt(m),   1));
          cs.push(where("date",">=",start)); cs.push(where("date","<",end));
        }
        if(tripVal){
          if(tripVal==="__NO_TRIP__") cs.push(where("trip","==",null));
          else cs.push(where("trip","==",tripVal));
        }

        const qy = cs.length ? query(base, ...cs, orderBy("date","desc")) : query(base, orderBy("date","desc"));
        const snap = await getDocs(qy);

        let total=0;
        const tot = { gasolina:0, hotel:0, comida:0, bebida:0 };

        list.innerHTML = "";
        if(snap.empty){
          list.innerHTML = `<div class="loading"><p>No hay gastos con estos filtros</p></div>`;
          updateStats(0, tot);
          // actualizar badge de viaje
          const t = await computeTotalForTrip(tripVal || "");
          $("#trip-total-badge").textContent = formatCurrency(t);
          return;
        }

        snap.forEach(d=>{
          const e = { id:d.id, ...d.data() };
          const amt = Number(e.amount)||0; total += amt;
          if(tot.hasOwnProperty(e.category)) tot[e.category]+=amt;

          const el = document.createElement('div');
          el.className = `expense-item ${e.category||''}`;
          const dd = e.date && e.date.toDate ? e.date.toDate() : new Date(e.date);
          el.innerHTML = `
            <div class="expense-header">
              <div class="expense-date">${formatDate(dd)}</div>
              <div class="expense-amount">${formatCurrency(amt)}</div>
            </div>
            <div class="expense-category ${e.category}-category">${categoryNames[e.category]||'Otra'}</div>
            <div class="expense-description">${e.description||'Sin descripción'}</div>
            <div class="expense-footer">
              <div>${e.paymentMethod||'No especificado'}</div>
              <div>
                <button class="action-btn delete" data-id="${e.id}" aria-label="Eliminar"><i class="fas fa-trash"></i></button>
              </div>
            </div>
          `;
          list.appendChild(el);
        });

        updateStats(total, tot);

        // Eliminar
        list.querySelectorAll(".action-btn.delete").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.getAttribute("data-id");
            await deleteExpense(id);
          });
        });

        // Badge de viaje
        const tripTotal = await computeTotalForTrip($("#filter-trip").value || "");
        $("#trip-total-badge").textContent = formatCurrency(tripTotal);

      }catch(e){
        console.error("Load error:",e);
        list.innerHTML = `<div class="loading"><p>Error al cargar. Reintenta.</p></div>`;
      }
    }

    /* ---------- Stats + Chart ---------- */
    function updateStats(totalAmount, catTotals){
      $("#total-amount").textContent   = formatCurrency(totalAmount);
      $("#gasolina-amount").textContent= formatCurrency(catTotals.gasolina);
      $("#hotel-amount").textContent   = formatCurrency(catTotals.hotel);
      $("#comida-amount").textContent  = formatCurrency(catTotals.comida);
      $("#bebida-amount").textContent  = formatCurrency(catTotals.bebida);
      updateReportChart(totalAmount, catTotals);
    }

    function updateReportChart(total, catTotals){
      const ctx = $("#expenses-chart");
      if(!ctx) return;
      if(window.expensesChart) window.expensesChart.destroy();
      window.expensesChart = new Chart(ctx.getContext('2d'), {
        type:'doughnut',
        data:{
          labels:['Gasolina','Hotel','Comida','Bebida'],
          datasets:[{
            data:[catTotals.gasolina, catTotals.hotel, catTotals.comida, catTotals.bebida],
            backgroundColor:[categoryColors.gasolina, categoryColors.hotel, categoryColors.comida, categoryColors.bebida],
            borderWidth:2, borderColor:'rgba(255,255,255,0.9)'
          }]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ position:'bottom', labels:{ color:'#e5e7eb' } },
            tooltip:{ callbacks:{ label: (c)=> `${c.label}: ${formatCurrency(c.parsed)}` } }
          }
        }
      });

      const pct = (v)=> total ? Math.round((v/total)*100) : 0;
      $("#report-gasolina").textContent = `${pct(catTotals.gasolina)}%`;
      $("#report-hotel").textContent    = `${pct(catTotals.hotel)}%`;
      $("#report-comida").textContent   = `${pct(catTotals.comida)}%`;
      $("#report-bebida").textContent   = `${pct(catTotals.bebida)}%`;
    }

    /* ---------- CRUD ---------- */
    async function addExpense(data){
      try{
        const [y,m,d] = data.date.split('-');
        const dateUTC = new Date(Date.UTC(parseInt(y), parseInt(m)-1, parseInt(d)));
        await addDoc(collection(db,"travel_expenses"), { ...data, date: dateUTC, createdAt: new Date() });

        // invalidar cache
        const k = data.trip && String(data.trip).trim()!=='' ? String(data.trip) : "__NO_TRIP__";
        tripTotals[k] = undefined; tripTotals[""] = undefined;

        // repoblar viajes por si es nuevo
        await fetchTripsAndPopulate();
        return true;
      }catch(e){ console.error("Add error:",e); return false; }
    }

    async function deleteExpense(id){
      if(!confirm('¿Eliminar este gasto?')) return;
      try{
        await deleteDoc(doc(db,"travel_expenses", id));
        // invalidar cache completa (simple)
        for(const k in tripTotals) tripTotals[k] = undefined;
        await fetchTripsAndPopulate();
        await loadExpenses();
      }catch(e){ console.error("Delete error:",e); alert('Error al eliminar.'); }
    }

    /* ---------- Totales en el formulario (por viaje) ---------- */
    const debouncedComputeTripForm = debounce(async (tripText)=>{
      const key = tripText && tripText.trim()!=='' ? tripText.trim() : "";
      const tot = await computeTotalForTrip(key==="" ? "" : key);
      $("#current-total-form").textContent   = formatCurrency(tot);
      const amt = Number($("#expense-amount").value)||0;
      $("#projected-total-form").textContent = formatCurrency(tot + amt);
    }, 300);

    function updateProjectedFromAmount(){
      const amt = Number($("#expense-amount").value)||0;
      const tripText = $("#expense-trip").value;
      const key = tripText && tripText.trim()!=='' ? tripText.trim() : "";
      const current = (tripTotals.hasOwnProperty(key) && typeof tripTotals[key]==='number') ? tripTotals[key] : 0;
      $("#projected-total-form").textContent = formatCurrency(current + amt);
    }

    /* ---------- Bootstrap tabs + eventos ---------- */
    const debouncedLoad = debounce(loadExpenses, 250);

    document.addEventListener("DOMContentLoaded", async ()=>{
      // defaults
      const today = new Date();
      $("#expense-date").value = today.toISOString().split('T')[0];
      $("#filter-date").value  = today.toISOString().slice(0,7);

      // trips
      await fetchTripsAndPopulate();

      // carga inicial
      await loadExpenses();

      // submit
      $("#expense-form").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const btn = e.currentTarget.querySelector('button[type="submit"]');
        const orig = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Guardando...';
        btn.disabled = true;

        const data = {
          date: $("#expense-date").value,
          category: $("#expense-category").value,
          description: $("#expense-description").value,
          amount: parseFloat($("#expense-amount").value),
          paymentMethod: $("#expense-payment-method").value,
          trip: ($("#expense-trip").value || null)
        };

        if(!data.category){ alert('Selecciona una categoría'); btn.innerHTML=orig; btn.disabled=false; return; }
        if(!data.amount || data.amount<=0){ alert('El monto debe ser mayor a cero'); btn.innerHTML=orig; btn.disabled=false; return; }

        const ok = await addExpense(data);
        if(ok){
          e.currentTarget.reset();
          $("#expense-date").value = new Date().toISOString().split('T')[0];
          alert('✅ Gasto registrado');
          new bootstrap.Tab($('[data-bs-target="#expenses"]')).show();
          await fetchTripsAndPopulate();
          for(const k in tripTotals) tripTotals[k]=undefined;
          await loadExpenses();
        }else{
          alert('❌ Error al registrar');
        }

        btn.innerHTML = orig; btn.disabled=false;
      });

      // filtros
      $("#filter-category").addEventListener("change", debouncedLoad);
      $("#filter-date").addEventListener("change", debouncedLoad);
      $("#filter-trip").addEventListener("change", async function(){
        const total = await computeTotalForTrip(this.value || "");
        $("#trip-total-badge").textContent = formatCurrency(total);
        debouncedLoad();
      });

      // formulario: totales por viaje en vivo
      $("#expense-trip").addEventListener("input", function(){ debouncedComputeTripForm(this.value); });
      $("#expense-amount").addEventListener("input", updateProjectedFromAmount);

      // FAB abre "Agregar"
      document.querySelector(".fab").addEventListener("click", ()=>{
        new bootstrap.Tab($('[data-bs-target="#add"]')).show();
      });

      // Chart resize al abrir tab reportes
      document.querySelectorAll('#myTab button').forEach(btn=>{
        btn.addEventListener('shown.bs.tab', function(){
          if(this.getAttribute('data-bs-target')==='#reports'){
            setTimeout(()=>{ if(window.expensesChart) window.expensesChart.resize(); }, 120);
          }
        });
      });
    });
  </script>
</body>
</html>