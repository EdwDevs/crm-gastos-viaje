<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>CRM Gastos Viaje - Correcci√≥n Clear Fields</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

  <style>
    /* --- Mantengo estilos previos (resumidos y con ajuste m√≥vil) --- */
    :root{ }
    [data-theme="dark"]{ }

    html { font-size: clamp(14px, 2.2vw, 16px); }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body{ margin:0; min-height:100vh; padding-bottom: calc(76px + env(safe-area-inset-bottom, 12px)); font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; }

    .topbar{ position: sticky; top:0; z-index: 1000; padding: 10px 14px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand i{ color: var(--primary, #60a5fa); font-size: 1.15rem; }
    .brand h1{ margin:0; font-size:1rem; letter-spacing:.3px; font-weight:800; }

    .top-actions{ display:flex; gap:10px; align-items:center; }
    .theme-toggle{ min-width:40px; min-height:40px; border-radius: 12px; display:flex; align-items:center; justify-content:center; }

    .badge-total{ display:flex; align-items:center; gap:10px; padding:8px 12px; border-radius: 999px; min-height: 38px; }
    #trip-total-badge{ font-weight:900; }

    .container-main{ padding: 14px; }
    .glass{ border-radius: 12px; padding: 0; }

    .stats-card{ display:flex; justify-content:space-between; align-items:center; gap:14px; padding:14px; }
    .chip .form-control, .chip .form-select{ padding:10px 12px; }

    .expense-list{ margin-top:12px; }
    .expense-item{ display:block; padding:12px; margin-bottom:10px; border-radius: 12px; }

    .action-btn{ min-width:44px; min-height:44px; border-radius:12px; }

    @media (max-width:420px){
      .action-btn{ min-width:48px; min-height:48px; padding:8px; }
      .fab{ width:64px; height:64px; }
      .chip .form-control, .chip .form-select { padding:12px 14px; }
    }
  </style>
</head>
<body>
  <!-- Top bar -->
  <header class="topbar">
    <div class="brand">
      <i class="fas fa-plane-departure"></i>
      <h1>Gastos de Viaje</h1>
    </div>
    <div class="top-actions">
      <button id="themeToggle" class="theme-toggle" aria-label="Cambiar tema">
        <i class="fas fa-sun"></i>
      </button>
      <div class="badge-total" title="Total del viaje seleccionado" aria-live="polite">
        <i class="fas fa-wallet"></i>
        <span style="font-weight:800;">Viaje:</span>
        <span id="trip-total-badge">$0</span>
      </div>
    </div>
  </header>

  <main id="appMain" class="container-main" aria-busy="false">
    <section class="glass stats-card section" aria-live="polite">
      <div>
        <div class="label">Total (vista actual)</div>
        <div class="amount" id="total-amount">$0</div>
        <div class="label">Con filtros aplicados</div>
      </div>
      <div style="min-width:110px;text-align:right;"></div>
    </section>

    <!-- Filters -->
    <section class="glass chips section">
      <div class="chip">
        <label for="filter-category">Categor√≠a</label>
        <select id="filter-category" class="form-select">
          <option value="">Todas</option>
          <option value="gasolina">Gasolina</option>
          <option value="hotel">Hotel</option>
          <option value="comida">Comida</option>
          <option value="bebida">Bebida</option>
        </select>
      </div>
      <div class="chip">
        <label for="filter-date">Per√≠odo</label>
        <input id="filter-date" type="month" class="form-control"/>
      </div>
      <div class="chip">
        <label for="filter-trip">Viaje</label>
        <select id="filter-trip" class="form-select">
          <option value="">Todas</option>
          <option value="__NO_TRIP__">(Sin viaje)</option>
        </select>
      </div>
    </section>

    <!-- Category tiles -->
    <section class="category-grid section">
      <div class="cat gas"><div class="k">Gasolina</div><div class="v" id="gasolina-amount">$0</div></div>
      <div class="cat hot"><div class="k">Hotel</div><div class="v" id="hotel-amount">$0</div></div>
      <div class="cat food"><div class="k">Comida</div><div class="v" id="comida-amount">$0</div></div>
      <div class="cat drink"><div class="k">Bebida</div><div class="v" id="bebida-amount">$0</div></div>
    </section>

    <!-- Tabs -->
    <ul class="nav nav-tabs glass section" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses" type="button" role="tab">
          <i class="fas fa-list"></i> Gastos
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">
          <i class="fas fa-plus-circle"></i> Agregar
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
          <i class="fas fa-chart-pie"></i> Reportes
        </button>
      </li>
    </ul>

    <div class="tab-content" id="myTabContent">
      <!-- GASTOS -->
      <div class="tab-pane fade show active" id="expenses" role="tabpanel">
        <div id="expense-list" class="expense-list" aria-live="polite"></div>
        <div class="d-grid gap-2 mt-2">
          <button id="loadMoreBtn" class="btn btn-outline-secondary" style="display:none;">Cargar m√°s</button>
        </div>
      </div>

      <!-- AGREGAR -->
      <div class="tab-pane fade" id="add" role="tabpanel">
        <div class="glass form-card">
          <h3><i class="fas fa-plus-circle"></i> Registrar Gasto</h3>
          <form id="expense-form" novalidate>
            <input type="hidden" id="edit-id" value="">
            <div class="mb-3">
              <label class="form-label" for="expense-date">Fecha</label>
              <input type="date" class="form-control" id="expense-date" required />
            </div>
            <div class="mb-3">
              <label class="form-label" for="expense-category">Categor√≠a</label>
              <select class="form-select" id="expense-category" required>
                <option value="">Seleccionar categor√≠a</option>
                <option value="gasolina">üöó Gasolina</option>
                <option value="hotel">üè® Hotel</option>
                <option value="comida">üçΩÔ∏è Comida</option>
                <option value="bebida">ü•§ Bebida</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label" for="expense-description">Descripci√≥n</label>
              <input type="text" class="form-control" id="expense-description" placeholder="Detalles del gasto" required />
              <div class="form-text">M√≠nimo 3 caracteres.</div>
            </div>
            <div class="mb-3">
              <label class="form-label" for="expense-amount">Monto</label>
              <input type="number" class="form-control" id="expense-amount" placeholder="0" step="1" min="0" required />
              <div class="d-flex justify-content-between mt-2" style="color:var(--muted);">
                <small><strong>Total actual (viaje):</strong></small>
                <small id="current-total-form" style="font-weight:900;">$0</small>
              </div>
              <div class="d-flex justify-content-between" style="color:var(--muted);">
                <small><strong>Total si guardas (viaje):</strong></small>
                <small id="projected-total-form" style="font-weight:900;">$0</small>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label" for="expense-payment-method">M√©todo de Pago</label>
              <select class="form-select" id="expense-payment-method">
                <option value="Efectivo">üíµ Efectivo</option>
                <option value="Tarjeta de Cr√©dito">üí≥ Tarjeta de Cr√©dito</option>
                <option value="Tarjeta de D√©bito">üí≥ Tarjeta de D√©bito</option>
                <option value="Transferencia">üì± Transferencia</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label" for="expense-trip">Viaje (Opcional)</label>
              <input type="text" class="form-control" id="expense-trip" placeholder="Identificador del viaje" />
            </div>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-check-circle me-2"></i> <span id="submitLabel">Guardar Gasto</span>
              </button>
              <button type="button" id="btnClearForm" class="btn btn-outline-secondary">Limpiar</button>
            </div>
          </form>
        </div>
      </div>

      <!-- REPORTES -->
      <div class="tab-pane fade" id="reports" role="tabpanel">
        <div class="glass form-card">
          <h3><i class="fas fa-chart-pie"></i> Distribuci√≥n de Gastos</h3>
          <div class="glass chart-wrap">
            <canvas id="expenses-chart"></canvas>
          </div>
          <div class="category-grid" style="margin-top:12px;">
            <div class="cat gas"><div class="k">Gasolina</div><div class="v" id="report-gasolina">0%</div></div>
            <div class="cat hot"><div class="k">Hotel</div><div class="v" id="report-hotel">0%</div></div>
            <div class="cat food"><div class="k">Comida</div><div class="v" id="report-comida">0%</div></div>
            <div class="cat drink"><div class="k">Bebida</div><div class="v" id="report-bebida">0%</div></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- FAB -->
  <button class="fab" data-bs-toggle="tab" data-bs-target="#add" aria-label="Agregar gasto">
    <i class="fas fa-plus"></i>
  </button>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav" role="navigation" aria-label="Navegaci√≥n">
    <div class="nav-item active" data-target="#expenses"><i class="fas fa-home"></i><small>Inicio</small></div>
    <div class="nav-item" data-target="#expenses"><i class="fas fa-receipt"></i><small>Gastos</small></div>
    <div class="nav-item" data-target="#reports"><i class="fas fa-chart-bar"></i><small>Reportes</small></div>
    <div class="nav-item" data-target="#add"><i class="fas fa-user-circle"></i><small>Perfil</small></div>
  </nav>

  <!-- Toast container -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:1300">
    <div id="appToast" class="toast text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg">Mensaje</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- App JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy, updateDoc,
      limit, startAfter, serverTimestamp, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCg9A5CbpKOLV6WspRz87bhWT3wJVbWXDE",
      authDomain: "crm-gastos-viaje.firebaseapp.com",
      projectId: "crm-gastos-viaje",
      storageBucket: "crm-gastos-viaje.firebasestorage.app",
      messagingSenderId: "1030088242238",
      appId: "1:1030088242238:web:53c2dcb3fc6642f82e4d6f"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ===== Helpers ===== */
    const $ = (sel)=> document.querySelector(sel);
    function formatDate(date){
      try{ if(!(date instanceof Date)) date = new Date(date); if(isNaN(date)) return ''; return date.toLocaleDateString('es-CO',{year:'numeric',month:'short',day:'numeric'}); }
      catch{ return ''; }
    }
    function formatCurrency(n){ n = Number(n)||0; return `$${new Intl.NumberFormat('es-CO').format(Math.round(n))}`; }
    function debounce(fn, wait=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

    // Toast API (Bootstrap)
    const toastEl = $("#appToast");
    let toast = new bootstrap.Toast(toastEl, { delay: 2500 });
    function showToast(msg, type="primary"){
      $("#toastMsg").textContent = msg;
      toastEl.className = `toast text-bg-${type} border-0`;
      toast.show();
    }

    // Theme toggle
    const themeToggle = $("#themeToggle");
    function applyTheme(theme){ document.documentElement.setAttribute("data-theme", theme); themeToggle.innerHTML = theme === "dark" ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; }
    const savedTheme = localStorage.getItem("theme");
    applyTheme(savedTheme || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light"));
    themeToggle.addEventListener("click", ()=>{
      const current = document.documentElement.getAttribute("data-theme");
      const next = current === "dark" ? "light" : "dark";
      applyTheme(next); localStorage.setItem("theme", next);
    });

    /* ===== Estado / Paginaci√≥n ===== */
    const pageSize = 10;
    let lastVisible = null;
    let moreAvailable = false;
    const categoryNames  = { gasolina:"Gasolina", hotel:"Hotel", comida:"Comida", bebida:"Bebida" };
    const tripTotals = {};

    /* ===== Utilities de formulario (limpieza expl√≠cita) ===== */
    function clearFormFields(){
      // Vac√≠a cada campo de forma expl√≠cita para evitar valores residuales
      $("#edit-id").value = "";
      const today = new Date().toISOString().slice(0,10);
      $("#expense-date").value = today;
      $("#expense-category").value = "";
      $("#expense-description").value = "";
      $("#expense-amount").value = "";
      $("#expense-payment-method").value = "Efectivo";
      $("#expense-trip").value = "";
      $("#current-total-form").textContent = formatCurrency(0);
      $("#projected-total-form").textContent = formatCurrency(0);
      $("#submitLabel").textContent = "Guardar Gasto";
      // quitar foco por si acaso
      document.activeElement.blur && document.activeElement.blur();
    }

    /* ===== Trips helpers ===== */
    async function fetchTripsAndPopulate(){
      try{
        const snap = await getDocs(collection(db,"travel_expenses"));
        const set = new Set();
        snap.forEach(d=>{
          const t = d.data().trip;
          if(t && String(t).trim()!=='') set.add(String(t));
        });
        const sel = $("#filter-trip");
        sel.querySelectorAll('option:not([value=""]):not([value="__NO_TRIP__"])').forEach(o=>o.remove());
        Array.from(set).sort().forEach(tr=>{
          const opt = document.createElement('option'); opt.value = tr; opt.textContent = tr; sel.appendChild(opt);
        });
      }catch(e){ console.error("Trips error:",e); }
    }

    async function computeTotalForTrip(tripKey){
      if(tripTotals.hasOwnProperty(tripKey) && typeof tripTotals[tripKey]==='number') return tripTotals[tripKey];
      try{
        const base = collection(db,"travel_expenses");
        let qy;
        if(tripKey==="") qy=query(base);
        else if(tripKey==="__NO_TRIP__") qy=query(base, where("trip","==",null));
        else qy=query(base, where("trip","==",tripKey));
        const snap = await getDocs(qy);
        let tot=0; snap.forEach(s=> tot += Number(s.data().amount)||0 );
        tripTotals[tripKey]=tot; return tot;
      }catch(e){ console.error("Total trip error:",e); return 0; }
    }

    /* ===== Render skeleton y paginaci√≥n ===== */
    function renderSkeleton(){
      const list = $("#expense-list");
      list.innerHTML = `
        <div class="expense-item"><div class="skeleton" style="height:16px; width:40%;"></div><div class="skeleton" style="height:14px; width:20%; margin-top:10px;"></div><div class="skeleton" style="height:12px; width:70%; margin-top:10px;"></div></div>
        <div class="expense-item"><div class="skeleton" style="height:16px; width:35%;"></div><div class="skeleton" style="height:14px; width:25%; margin-top:10px;"></div><div class="skeleton" style="height:12px; width:60%; margin-top:10px;"></div></div>
      `;
    }

    function buildBaseQuery(applyFilters=true){
      const base = collection(db,"travel_expenses");
      const cs = [];
      if(!applyFilters) return query(base, orderBy("date","desc"));
      const category = $("#filter-category").value;
      const monthVal = $("#filter-date").value;
      const tripVal  = $("#filter-trip").value;
      if(category) cs.push(where("category","==",category));
      if(monthVal){
        const [y,m]=monthVal.split('-');
        const start = new Date(Date.UTC(parseInt(y), parseInt(m)-1, 1));
        const end   = new Date(Date.UTC(parseInt(y), parseInt(m),   1));
        cs.push(where("date",">=", Timestamp.fromDate(start)));
        cs.push(where("date","<",  Timestamp.fromDate(end)));
      }
      if(tripVal){
        if(tripVal==="__NO_TRIP__") cs.push(where("trip","==",null));
        else cs.push(where("trip","==",tripVal));
      }
      return cs.length ? query(base, ...cs, orderBy("date","desc")) : query(base, orderBy("date","desc"));
    }

    async function loadExpenses(reset=true){
      const list = $("#expense-list");
      const loadMoreBtn = $("#loadMoreBtn");
      if(reset){ lastVisible = null; moreAvailable = false; renderSkeleton(); list.innerHTML = ''; }
      try{
        const baseQuery = buildBaseQuery(true);
        let qy = lastVisible ? query(baseQuery, startAfter(lastVisible), limit(pageSize)) : query(baseQuery, limit(pageSize));
        const snap = await getDocs(qy);
        if(reset) list.innerHTML = '';
        if(snap.empty && reset){
          list.innerHTML = `<div class="loading"><p>No hay gastos con estos filtros</p></div>`;
          updateStats(0, { gasolina:0, hotel:0, comida:0, bebida:0 });
          const t = await computeTotalForTrip($("#filter-trip").value || "");
          $("#trip-total-badge").textContent = formatCurrency(t);
          loadMoreBtn.style.display = 'none';
          return;
        }

        let total = 0;
        const tot = { gasolina:0, hotel:0, comida:0, bebida:0 };

        snap.forEach(d=>{
          const e = { id:d.id, ...d.data() };
          const amt = Number(e.amount)||0; total += amt;
          if(tot.hasOwnProperty(e.category)) tot[e.category] += amt;

          const el = document.createElement('div');
          el.className = `expense-item ${e.category||''}`;
          const dd = e.date && e.date.toDate ? e.date.toDate() : new Date(e.date);
          el.innerHTML = `
            <div class="expense-header">
              <div class="expense-date">${formatDate(dd)}</div>
              <div class="expense-amount">${formatCurrency(amt)}</div>
            </div>
            <div class="expense-category ${e.category}-category">${categoryNames[e.category]||'Otra'}</div>
            <div class="expense-description">${e.description||'Sin descripci√≥n'}</div>
            <div class="expense-footer">
              <div>${e.paymentMethod||'No especificado'}</div>
              <div>
                <button class="action-btn edit me-1" data-id="${e.id}" aria-label="Editar"><i class="fas fa-edit"></i></button>
                <button class="action-btn delete" data-id="${e.id}" aria-label="Eliminar"><i class="fas fa-trash"></i></button>
              </div>
            </div>
          `;
          list.appendChild(el);
        });

        lastVisible = snap.docs[snap.docs.length - 1];
        moreAvailable = snap.size === pageSize;
        loadMoreBtn.style.display = moreAvailable ? 'block' : 'none';

        updateStats(total, tot);

        list.querySelectorAll(".action-btn.delete").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.getAttribute("data-id");
            await deleteExpense(id);
            await goToFirstPageAndRefresh();
          });
        });
        list.querySelectorAll(".action-btn.edit").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.getAttribute("data-id");
            await loadExpenseIntoForm(id);
            new bootstrap.Tab($('[data-bs-target="#add"]')).show();
          });
        });

        const tripTotal = await computeTotalForTrip($("#filter-trip").value || "");
        $("#trip-total-badge").textContent = formatCurrency(tripTotal);
        fetchTripsAndPopulate().catch(()=>{});
      }catch(e){
        console.error("Load error:",e);
        list.innerHTML = `<div class="loading"><p>Error al cargar. Reintenta.</p></div>`;
        showToast("Error al cargar gastos", "danger");
        $("#loadMoreBtn").style.display = 'none';
      }
    }

    async function loadMore(){
      if(!moreAvailable) return;
      await loadExpenses(false);
    }

    async function goToFirstPageAndRefresh(){
      lastVisible = null;
      await loadExpenses(true);
    }

    /* ===== CRUD: ADD / UPDATE / DELETE ===== */
    async function addExpense(data){
      try{
        const [y,m,d] = data.date.split('-');
        const dateUTC = new Date(Date.UTC(parseInt(y), parseInt(m)-1, parseInt(d)));
        await addDoc(collection(db,"travel_expenses"), {
          ...data,
          date: Timestamp.fromDate(dateUTC),
          createdAt: serverTimestamp()
        });
        const k = data.trip && String(data.trip).trim()!=='' ? String(data.trip) : "__NO_TRIP__";
        tripTotals[k] = undefined; tripTotals[""] = undefined;
        return true;
      }catch(e){
        console.error("Add error:",e);
        return false;
      }
    }

    async function updateExpense(id, data){
      try{
        const [y,m,d] = data.date.split('-');
        const dateUTC = new Date(Date.UTC(parseInt(y), parseInt(m)-1, parseInt(d)));
        await updateDoc(doc(db,"travel_expenses", id), {
          ...data,
          date: Timestamp.fromDate(dateUTC),
          updatedAt: serverTimestamp()
        });
        for(const k in tripTotals) tripTotals[k] = undefined;
        return true;
      }catch(e){
        console.error("Update error:",e);
        return false;
      }
    }

    async function deleteExpense(id){
      if(!confirm('¬øEliminar este gasto?')) return;
      try{
        await deleteDoc(doc(db,"travel_expenses", id));
        for(const k in tripTotals) tripTotals[k] = undefined;
        showToast("Gasto eliminado", "primary");
      }catch(e){
        console.error("Delete error:",e);
        showToast("Error al eliminar", "danger");
      }
    }

    /* ===== Cargar un gasto al formulario para edici√≥n ===== */
    async function loadExpenseIntoForm(id){
      try{
        const q = query(collection(db,"travel_expenses"), where('__name__','==', id));
        const snap = await getDocs(q);
        if(snap.empty){ showToast("No se encontr√≥ el gasto", "danger"); return; }
        const data = snap.docs[0].data();
        $("#edit-id").value = id;
        $("#expense-date").value = (data.date && data.date.toDate) ? data.date.toDate().toISOString().slice(0,10) : new Date().toISOString().slice(0,10);
        $("#expense-category").value = data.category || '';
        $("#expense-description").value = data.description || '';
        $("#expense-amount").value = data.amount || '';
        $("#expense-payment-method").value = data.paymentMethod || 'Efectivo';
        $("#expense-trip").value = data.trip || '';
        $("#submitLabel").textContent = 'Actualizar Gasto';
        const key = $("#expense-trip").value && $("#expense-trip").value.trim()!=='' ? $("#expense-trip").value.trim() : "";
        const tot = await computeTotalForTrip(key==="" ? "" : key);
        $("#current-total-form").textContent = formatCurrency(tot);
        const amt = Number($("#expense-amount").value)||0;
        $("#projected-total-form").textContent = formatCurrency(tot + amt);
      }catch(e){
        console.error("Load for edit error:", e);
        showToast("Error al cargar gasto para edici√≥n", "danger");
      }
    }

    /* ===== Stats + Chart ===== */
    function updateStats(totalAmount, catTotals){
      $("#total-amount").textContent   = formatCurrency(totalAmount);
      $("#gasolina-amount").textContent= formatCurrency(catTotals.gasolina);
      $("#hotel-amount").textContent   = formatCurrency(catTotals.hotel);
      $("#comida-amount").textContent  = formatCurrency(catTotals.comida);
      $("#bebida-amount").textContent  = formatCurrency(catTotals.bebida);
      updateReportChart(totalAmount, catTotals);
    }

    function updateReportChart(total, catTotals){
      const ctx = $("#expenses-chart");
      if(!ctx) return;
      if(window.expensesChart) window.expensesChart.destroy();
      window.expensesChart = new Chart(ctx.getContext('2d'), {
        type:'doughnut',
        data:{
          labels:['Gasolina','Hotel','Comida','Bebida'],
          datasets:[{
            data:[catTotals.gasolina, catTotals.hotel, catTotals.comida, catTotals.bebida],
            backgroundColor:['#60a5fa','#a78bfa','#34d399','#f59e0b'],
            borderWidth:2, borderColor:'rgba(255,255,255,0.9)'
          }]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ position:'bottom', labels:{ color:getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#0f172a' } },
            tooltip:{ callbacks:{ label: (c)=> `${c.label}: ${formatCurrency(c.parsed)}` } }
          }
        }
      });

      const pct = (v)=> total ? Math.round((v/total)*100) : 0;
      $("#report-gasolina").textContent = `${pct(catTotals.gasolina)}%`;
      $("#report-hotel").textContent    = `${pct(catTotals.hotel)}%`;
      $("#report-comida").textContent   = `${pct(catTotals.comida)}%`;
      $("#report-bebida").textContent   = `${pct(catTotals.bebida)}%`;
    }

    /* ===== Form validations y ARIA busy ===== */
    function setBusy(isBusy){
      const main = $("#appMain");
      main.setAttribute('aria-busy', String(!!isBusy));
      document.body.setAttribute('aria-busy', String(!!isBusy));
    }

    function validateFormData(data){
      if(!data.date) return { ok:false, msg:'Selecciona una fecha' };
      if(!data.category) return { ok:false, msg:'Selecciona una categor√≠a' };
      if(!data.description || String(data.description).trim().length < 3) return { ok:false, msg:'La descripci√≥n debe tener al menos 3 caracteres' };
      if(!data.amount || Number(data.amount) <= 0) return { ok:false, msg:'El monto debe ser mayor a cero' };
      return { ok:true };
    }

    /* ===== Eventos UI ===== */
    document.addEventListener("DOMContentLoaded", async ()=>{
      const today = new Date();
      $("#expense-date").value = today.toISOString().split('T')[0];
      $("#filter-date").value  = today.toISOString().slice(0,7);

      await fetchTripsAndPopulate();
      await loadExpenses(true);

      $("#loadMoreBtn").addEventListener("click", async ()=>{ await loadMore(); });

      // Bot√≥n "Limpiar" expl√≠cito
      $("#btnClearForm").addEventListener("click", ()=> clearFormFields());

      // Submit (add / update) - ahora limpiamos campos expl√≠citamente tras √©xito
      $("#expense-form").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const btn = e.currentTarget.querySelector('button[type="submit"]');
        const labelSpan = $("#submitLabel");
        const origText = labelSpan.textContent;
        btn.disabled = true;
        labelSpan.textContent = labelSpan.textContent.includes('Actualizar') ? 'Procesando...' : 'Guardando...';
        setBusy(true);

        try{
          const idEdit = $("#edit-id").value || '';
          const data = {
            date: $("#expense-date").value,
            category: $("#expense-category").value,
            description: $("#expense-description").value && $("#expense-description").value.trim(),
            amount: Number($("#expense-amount").value),
            paymentMethod: $("#expense-payment-method").value,
            trip: ($("#expense-trip").value || null)
          };

          const v = validateFormData(data);
          if(!v.ok){ showToast(v.msg, 'danger'); return; }

          if(idEdit){
            const ok = await updateExpense(idEdit, data);
            if(ok){
              showToast('‚úÖ Gasto actualizado', 'primary');
              // limpiar campos expl√≠citamente
              clearFormFields();
            }else{
              showToast('‚ùå Error al actualizar', 'danger');
            }
          }else{
            const ok = await addExpense(data);
            if(ok){
              showToast('‚úÖ Gasto registrado', 'primary');
              // limpiar campos expl√≠citamente
              clearFormFields();
            }else{
              showToast('‚ùå Error al registrar', 'danger');
            }
          }

          await fetchTripsAndPopulate();
          await goToFirstPageAndRefresh();
          new bootstrap.Tab($('[data-bs-target="#expenses"]')).show();
        } finally {
          btn.disabled = false;
          labelSpan.textContent = 'Guardar Gasto';
          setBusy(false);
        }
      });

      // filtros -> recargar (reset paginaci√≥n)
      const debouncedReload = debounce(()=> goToFirstPageAndRefresh(), 250);
      $("#filter-category").addEventListener("change", debouncedReload);
      $("#filter-date").addEventListener("change", debouncedReload);
      $("#filter-trip").addEventListener("change", async function(){
        const total = await computeTotalForTrip(this.value || "");
        $("#trip-total-badge").textContent = formatCurrency(total);
        debouncedReload();
      });

      // formulario: totales por viaje en vivo
      const debouncedComputeTripForm = debounce(async (tripText)=>{
        const key = tripText && tripText.trim()!=='' ? tripText.trim() : "";
        const tot = await computeTotalForTrip(key==="" ? "" : key);
        $("#current-total-form").textContent   = formatCurrency(tot);
        const amt = Number($("#expense-amount").value)||0;
        $("#projected-total-form").textContent = formatCurrency(tot + amt);
      }, 300);

      $("#expense-trip").addEventListener("input", function(){ debouncedComputeTripForm(this.value); });
      $("#expense-amount").addEventListener("input", ()=> {
        const amt = Number($("#expense-amount").value)||0;
        const tripText = $("#expense-trip").value;
        const key = tripText && tripText.trim()!=='' ? tripText.trim() : "";
        const current = (tripTotals.hasOwnProperty(key) && typeof tripTotals[key]==='number') ? tripTotals[key] : 0;
        $("#projected-total-form").textContent = formatCurrency(current + amt);
      });

      // FAB abre "Agregar" y limpia formulario
      document.querySelector(".fab").addEventListener("click", ()=>{
        clearFormFields();
        new bootstrap.Tab($('[data-bs-target="#add"]')).show();
      });

      // Tabs -> bottom nav activo + resize chart
      document.querySelectorAll('#myTab button').forEach(btn=>{
        btn.addEventListener('shown.bs.tab', function(){
          const target = this.getAttribute('data-bs-target');
          document.querySelectorAll('.bottom-nav .nav-item').forEach(i=> i.classList.toggle('active', i.dataset.target === target));
          if(target==='#reports'){ setTimeout(()=>{ if(window.expensesChart) window.expensesChart.resize(); }, 120); }
        });
      });

      // Bottom nav -> cambiar tab
      document.querySelectorAll('.bottom-nav .nav-item').forEach(i=>{
        i.addEventListener('click', ()=>{
          const t = i.dataset.target || '#expenses';
          new bootstrap.Tab(document.querySelector(`[data-bs-target="${t}"]`)).show();
        });
      });

    }); // DOMContentLoaded end

  </script>
</body>
</html>