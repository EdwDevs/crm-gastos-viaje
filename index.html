<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>CRM Gastos Viaje</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

  <style>
    :root{
      --bg: #f7f9fc;
      --bg-soft: #ffffff;
      --bg-glass: rgba(255,255,255,0.75);
      --stroke: rgba(9,30,66,0.12);
      --text: #0f172a;
      --muted: #6b7280;
      --primary: #2563eb;
      --success: #16a34a;
      --danger: #dc2626;
      --gasolina:#2563eb;
      --hotel:#7c3aed;
      --comida:#059669;
      --bebida:#d97706;
      --radius:12px;
      --shadow-md: 0 14px 36px rgba(2,6,23,0.08);
    }

    [data-theme="dark"]{
      --bg: #0b1220;
      --bg-soft: #0f172a;
      --bg-glass: rgba(17,24,39,0.55);
      --stroke: rgba(148,163,184,0.16);
      --text: #e5e7eb;
      --muted: #94a3b8;
      --primary:#60a5fa;
      --success:#34d399;
      --danger:#f87171;
      --gasolina:#60a5fa; --hotel:#a78bfa; --comida:#34d399; --bebida:#f59e0b;
    }

    * { box-sizing:border-box; margin:0; padding:0; }
    body{
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 20px;
      padding-bottom: 100px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--bg-glass);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .stat-card {
      padding: 15px;
      background: var(--bg-glass);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      text-align: center;
    }

    .stat-label {
      color: var(--muted);
      font-size: 0.85rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.2rem;
      font-weight: 900;
      color: var(--success);
    }

    .expenses-table {
      width: 100%;
      background: var(--bg-glass);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .expenses-table thead {
      background: rgba(59,130,246,0.1);
    }

    .expenses-table th {
      padding: 12px 10px;
      text-align: left;
      font-weight: 800;
      font-size: 0.8rem;
      border-bottom: 1px solid var(--stroke);
    }

    .expenses-table td {
      padding: 10px;
      border-bottom: 1px solid var(--stroke);
      font-size: 0.85rem;
    }

    .expenses-table tbody tr:hover {
      background: rgba(96, 165, 250, 0.05);
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .badge-gasolina { background: rgba(96,165,250,0.2); color: var(--gasolina); }
    .badge-hotel { background: rgba(167,139,250,0.2); color: var(--hotel); }
    .badge-comida { background: rgba(52,211,153,0.2); color: var(--comida); }
    .badge-bebida { background: rgba(245,158,11,0.2); color: var(--bebida); }

    .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.85rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }

    @media (max-width: 768px) {
      .expenses-table th:nth-child(4),
      .expenses-table td:nth-child(4) {
        display: none;
      }
    }
  </style>
</head>

<body>
  <div class="header">
    <h1 style="font-size: 1.2rem; font-weight: 800;">
      <i class="fas fa-plane-departure"></i> CRM Gastos
    </h1>
    <button class="btn btn-primary" onclick="location.reload()">
      <i class="fas fa-sync"></i> Recargar
    </button>
  </div>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-label">TOTAL</div>
      <div class="stat-value" id="total-amount">$0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">GASTOS</div>
      <div class="stat-value" id="total-count">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">GASOLINA</div>
      <div class="stat-value" id="gasolina-amount" style="color: var(--gasolina);">$0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">HOTEL</div>
      <div class="stat-value" id="hotel-amount" style="color: var(--hotel);">$0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">COMIDA</div>
      <div class="stat-value" id="comida-amount" style="color: var(--comida);">$0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">BEBIDA</div>
      <div class="stat-value" id="bebida-amount" style="color: var(--bebida);">$0</div>
    </div>
  </div>

  <table class="expenses-table">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Descripci√≥n</th>
        <th>Categor√≠a</th>
        <th>Viaje</th>
        <th>Monto</th>
      </tr>
    </thead>
    <tbody id="expenses-tbody">
      <tr>
        <td colspan="5" class="loading">
          <i class="fas fa-spinner fa-spin"></i> Cargando gastos...
        </td>
      </tr>
    </tbody>
  </table>

  <div id="error-message" style="display: none; margin-top: 20px; padding: 15px; background: rgba(220, 38, 38, 0.1); border: 1px solid var(--danger); border-radius: var(--radius); color: var(--danger);">
    <strong>Error:</strong> <span id="error-text"></span>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Tu configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCg9A5CbpKOLV6WspRz87bhWT3wJVbWXDE",
      authDomain: "crm-gastos-viaje.firebaseapp.com",
      projectId: "crm-gastos-viaje",
      storageBucket: "crm-gastos-viaje.firebasestorage.app",
      messagingSenderId: "1030088242238",
      appId: "1:1030088242238:web:53c2dcb3fc6642f82e4d6f"
    };

    const $ = id => document.getElementById(id);
    const formatCurrency = (val) => new Intl.NumberFormat('es-MX', { style:'currency', currency:'MXN' }).format(val || 0);
    const formatDate = (d) => {
      try {
        return d.toLocaleDateString('es-MX', { day:'2-digit', month:'short', year:'numeric' });
      } catch(e) {
        return 'Sin fecha';
      }
    };

    function showError(message) {
      $("error-message").style.display = 'block';
      $("error-text").textContent = message;
    }

    async function loadExpenses() {
      const tbody = $("expenses-tbody");
      
      try {
        console.log("üöÄ Iniciando Firebase...");
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        console.log("‚úÖ Firebase inicializado");

        console.log("üì• Obteniendo gastos...");
        
        // Consulta M√ÅS SIMPLE posible - sin filtros, solo ordenar por fecha
        const expensesRef = collection(db, "travel_expenses");
        const q = query(expensesRef, orderBy("date", "desc"));
        
        console.log("üîÑ Ejecutando consulta...");
        const querySnapshot = await getDocs(q);
        
        console.log(`üìä Documentos obtenidos: ${querySnapshot.size}`);

        if (querySnapshot.empty) {
          console.log("‚ö†Ô∏è No hay documentos en la colecci√≥n");
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="empty-state">
                <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                <strong>No hay gastos registrados</strong>
                <p style="font-size: 0.9rem; margin-top: 5px;">La base de datos est√° vac√≠a</p>
              </td>
            </tr>
          `;
          return;
        }

        // Limpiar tabla
        tbody.innerHTML = '';

        // Calcular totales
        let totalAmount = 0;
        let totalCount = 0;
        const catTotals = { gasolina: 0, hotel: 0, comida: 0, bebida: 0 };

        // Procesar cada documento
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          console.log("üìÑ Documento:", data.description, formatCurrency(data.amount));
          
          // Sumar totales
          const amount = Number(data.amount) || 0;
          totalAmount += amount;
          totalCount++;
          
          if (catTotals.hasOwnProperty(data.category)) {
            catTotals[data.category] += amount;
          }

          // Obtener fecha
          let dateObj;
          try {
            dateObj = data.date && data.date.toDate ? data.date.toDate() : new Date();
          } catch(e) {
            dateObj = new Date();
          }

          // Crear fila
          const row = document.createElement('tr');
          row.innerHTML = `
            <td style="color: var(--muted); font-weight: 600; white-space: nowrap;">${formatDate(dateObj)}</td>
            <td style="font-weight: 600;">${data.description || 'Sin descripci√≥n'}</td>
            <td>
              <span class="badge badge-${data.category || 'gasolina'}">
                ${data.category ? data.category.charAt(0).toUpperCase() + data.category.slice(1) : 'N/A'}
              </span>
            </td>
            <td style="color: var(--muted); font-size: 0.85rem;">${data.trip || '‚Äî'}</td>
            <td style="font-weight: 900; color: var(--success);">${formatCurrency(amount)}</td>
          `;
          tbody.appendChild(row);
        });

        // Actualizar estad√≠sticas
        $("total-amount").textContent = formatCurrency(totalAmount);
        $("total-count").textContent = totalCount;
        $("gasolina-amount").textContent = formatCurrency(catTotals.gasolina);
        $("hotel-amount").textContent = formatCurrency(catTotals.hotel);
        $("comida-amount").textContent = formatCurrency(catTotals.comida);
        $("bebida-amount").textContent = formatCurrency(catTotals.bebida);

        console.log("‚úÖ Carga completada");
        console.log("üí∞ Total:", formatCurrency(totalAmount));
        console.log("üìù Gastos:", totalCount);

      } catch (error) {
        console.error("‚ùå ERROR:", error);
        console.error("C√≥digo:", error.code);
        console.error("Mensaje:", error.message);
        
        let errorMsg = error.message;
        if (error.code === 'permission-denied') {
          errorMsg = 'Sin permisos para leer datos. Verifica las reglas de Firestore.';
        } else if (error.code === 'unavailable') {
          errorMsg = 'No hay conexi√≥n a internet o Firestore no est√° disponible.';
        }
        
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 20px; color: var(--danger);">
              <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
              <strong>Error al cargar gastos</strong>
              <p style="font-size: 0.9rem; margin-top: 5px;">${errorMsg}</p>
            </td>
          </tr>
        `;
        
        showError(errorMsg);
      }
    }

    // Iniciar carga autom√°ticamente
    document.addEventListener("DOMContentLoaded", () => {
      console.log("üåê P√°gina cargada, iniciando...");
      loadExpenses();
    });
  </script>
</body>
</html>