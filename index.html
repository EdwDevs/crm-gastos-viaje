<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <!-- ‚úÖ A11y: permitir zoom; mobile-first -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM Gastos Viaje - M√≥vil</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    :root{
      --primary:#2c3e50; --secondary:#3498db; --success:#27ae60; --warning:#f39c12; --danger:#e74c3c;
      --light:#ecf0f1; --dark:#34495e; --info:#1abc9c;
      --gasolina:#3498db; --hotel:#9b59b6; --comida:#2ecc71; --bebida:#e67e22;
      --ring: rgba(52,152,219,.35);
      --header-h: 56px; /* usado por sticky */
      color-scheme: light;
    }
    @media (prefers-color-scheme: dark){ :root{ color-scheme: dark; } }

    body{
      background-color:#f5f7fa; font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
      padding-bottom:80px; /* espacio para bottom nav */
      overflow-x:hidden; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Header */
    .app-header{
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:#fff; padding:12px 16px; position:sticky; top:0; z-index:1000; box-shadow:0 2px 10px rgba(0,0,0,.1);
      min-height: var(--header-h);
    }
    .app-header h1{ font-size:1.1rem; margin:0; display:flex; align-items:center; gap:10px; }

    /* Stats */
    .stats-card{
      background:#fff; border-radius:12px; padding:14px; margin:12px 12px 8px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
    }
    .stats-card .amount{ font-size:1.6rem; font-weight:800; color:var(--success); margin:4px 0; }
    .stats-card .label{ font-size:.9rem; color:var(--dark); }

    /* Category stats */
    .category-stats{ display:flex; flex-wrap:wrap; gap:10px; padding:0 12px 8px; }
    .category-stat{
      flex:1; min-width:140px; background:#fff; border-radius:10px; padding:12px; text-align:center;
      box-shadow:0 2px 5px rgba(0,0,0,.05);
    }
    .category-stat .amount{ font-weight:800; font-size:1.05rem; margin:4px 0; }
    .category-stat .label{ font-size:.8rem; color:#7f8c8d; }
    .gasolina-stat{ border-top:3px solid var(--gasolina); }
    .hotel-stat{ border-top:3px solid var(--hotel); }
    .comida-stat{ border-top:3px solid var(--comida); }
    .bebida-stat{ border-top:3px solid var(--bebida); }

    /* Tabs top */
    .nav-tabs{
      background:#fff; border-bottom:1px solid #eee; position:sticky; top:var(--header-h); z-index:999;
      overflow-x:auto; white-space:nowrap; scrollbar-width:none; /* Firefox */
    }
    .nav-tabs::-webkit-scrollbar{ display:none; }
    .nav-tabs .nav-link{ color:var(--dark); font-weight:600; padding:12px 16px; border:0; }
    .nav-tabs .nav-link.active{ color:var(--secondary); border-bottom:3px solid var(--secondary); background:transparent; }
    .tab-content{ padding:12px; }

    /* Forms */
    .form-card{
      background:#fff; border-radius:12px; padding:16px; margin-bottom:16px; box-shadow:0 2px 8px rgba(0,0,0,.05);
    }
    .form-card h3{ font-size:1.1rem; margin-bottom:14px; color:var(--primary); display:flex; align-items:center; gap:.5rem; }
    .form-control, .form-select{
      border-radius:10px; padding:12px 14px; font-size:1rem; border:1px solid #ddd; height:auto; min-height:44px;
      transition: box-shadow .15s, border-color .15s;
    }
    .form-control:focus, .form-select:focus{ outline:none; border-color:var(--secondary); box-shadow:0 0 0 3px var(--ring); }
    .btn-primary{
      background-color:var(--secondary); border-color:var(--secondary); border-radius:10px; padding:12px; font-weight:700; width:100%; margin-top:10px;
    }
    .btn-primary:focus-visible{ box-shadow:0 0 0 3px var(--ring); outline:0; }

    /* Expense list */
    .expense-item{
      background:#fff; border-radius:12px; padding:14px; margin-bottom:12px; box-shadow:0 2px 8px rgba(0,0,0,.05);
      border-left:4px solid var(--secondary); transition:transform .15s, box-shadow .15s;
    }
    .expense-item:active{ transform:scale(.98); box-shadow:0 1px 4px rgba(0,0,0,.1); }
    .expense-item.gasolina{ border-left-color:var(--gasolina); }
    .expense-item.hotel{ border-left-color:var(--hotel); }
    .expense-item.comida{ border-left-color:var(--comida); }
    .expense-item.bebida{ border-left-color:var(--bebida); }

    .expense-header{ display:flex; justify-content:space-between; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
    .expense-date{ font-size:.85rem; color:#7f8c8d; }
    .expense-amount{ font-weight:800; color:var(--success); font-size:1.15rem; }
    .expense-category{ display:inline-block; padding:3px 10px; border-radius:20px; font-size:.78rem; margin-bottom:8px; font-weight:600; }
    .gasolina-category{ background:rgba(52,152,219,.1); color:var(--gasolina); }
    .hotel-category{ background:rgba(155,89,182,.1); color:var(--hotel); }
    .comida-category{ background:rgba(46,204,113,.1); color:var(--comida); }
    .bebida-category{ background:rgba(230,126,34,.1); color:var(--bebida); }
    .expense-description{ font-size:.95rem; margin-bottom:8px; color:#34495e; }
    .expense-footer{ display:flex; justify-content:space-between; font-size:.85rem; color:#7f8c8d; gap:8px; align-items:center; }

    .action-buttons{ display:flex; gap:10px; }
    .action-btn{
      width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center;
      background:#f1f2f6; border:none; color:var(--dark); transition:transform .12s, background-color .12s;
    }
    .action-btn:active{ transform:scale(.92); }
    .action-btn.edit{ background:rgba(52,152,219,.12); color:var(--secondary); }
    .action-btn.delete{ background:rgba(231,76,60,.12); color:var(--danger); }
    .action-btn:focus-visible{ outline:0; box-shadow:0 0 0 3px var(--ring); }

    /* Filters */
    .filter-section{ background:#fff; border-radius:12px; padding:12px; margin-bottom:16px; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    .filter-title{ font-weight:700; margin-bottom:10px; color:var(--primary); display:flex; align-items:center; gap:.5rem; }
    .filter-row{ display:flex; gap:10px; margin-bottom:10px; }
    .filter-item{ flex:1; }
    .filter-item label{ font-size:.85rem; margin-bottom:6px; color:#7f8c8d; display:block; }

    /* Reports */
    .chart-wrap{ width:100%; height:260px; position:relative; }
    #expenses-chart{ width:100% !important; height:100% !important; }

    /* Bottom nav */
    .bottom-nav{
      position:fixed; bottom:0; left:0; right:0; background:#fff; display:flex; border-top:1px solid #eee; z-index:1000;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .nav-item{ flex:1; text-align:center; padding:10px 0; color:#7f8c8d; font-size:.8rem; user-select:none; cursor:pointer; }
    .nav-item.active{ color:var(--secondary); font-weight:700; }
    .nav-item i{ display:block; font-size:1.2rem; margin-bottom:3px; }

    /* Empty / loading */
    .empty-state{ text-align:center; padding:40px 20px; color:#95a5a6; }
    .empty-state i{ font-size:3rem; margin-bottom:15px; opacity:.3; }
    .loading{ text-align:center; padding:20px; }
    .spinner{
      border:4px solid rgba(0,0,0,.1); border-radius:50%; border-top:4px solid var(--secondary);
      width:32px; height:32px; animation:spin 1s linear infinite; margin:0 auto;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    /* FAB */
    .fab{
      position:fixed; bottom:88px; right:20px; width:60px; height:60px; border-radius:50%;
      background:var(--secondary); color:#fff; display:flex; align-items:center; justify-content:center; font-size:1.5rem;
      box-shadow:0 6px 18px rgba(0,0,0,.22); z-index:1100; border:none; transition:transform .12s, box-shadow .12s;
    }
    .fab:active{ transform:scale(.95); box-shadow:0 3px 10px rgba(0,0,0,.2); }
    .fab:focus-visible{ outline:0; box-shadow:0 0 0 3px var(--ring); }

    /* Mobile tweaks */
    @media (max-width:576px){
      .category-stat{ min-width:calc(50% - 5px); padding:10px; }
      .expense-header{ flex-direction:column; align-items:flex-start; }
      .expense-amount{ align-self:flex-end; }
      .filter-row{ flex-direction:column; gap:10px; }
      .stats-card .amount{ font-size:1.45rem; }
    }
  </style>
</head>
<body>
  <div class="app-header">
    <h1><i class="fas fa-suitcase"></i> Gastos de Viaje</h1>
  </div>

  <div class="stats-card">
    <div class="label">Total Gastado</div>
    <div class="amount" id="total-amount">$0</div>
    <div class="label">Este mes</div>
  </div>

  <div class="category-stats">
    <div class="category-stat gasolina-stat">
      <div class="amount" id="gasolina-amount">$0</div>
      <div class="label">Gasolina</div>
    </div>
    <div class="category-stat hotel-stat">
      <div class="amount" id="hotel-amount">$0</div>
      <div class="label">Hotel</div>
    </div>
    <div class="category-stat comida-stat">
      <div class="amount" id="comida-amount">$0</div>
      <div class="label">Comida</div>
    </div>
    <div class="category-stat bebida-stat">
      <div class="amount" id="bebida-amount">$0</div>
      <div class="label">Bebida</div>
    </div>
  </div>

  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses" type="button" role="tab">
        <i class="fas fa-list"></i> Gastos
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">
        <i class="fas fa-plus"></i> Agregar
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
        <i class="fas fa-chart-bar"></i> Reportes
      </button>
    </li>
  </ul>

  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="expenses" role="tabpanel">
      <div class="filter-section">
        <div class="filter-title"><i class="fas fa-filter me-2"></i> Filtrar Gastos</div>
        <div class="filter-row">
          <div class="filter-item">
            <label for="filter-category">Categor√≠a</label>
            <select class="form-select" id="filter-category">
              <option value="">Todas</option>
              <option value="gasolina">Gasolina</option>
              <option value="hotel">Hotel</option>
              <option value="comida">Comida</option>
              <option value="bebida">Bebida</option>
            </select>
          </div>
          <div class="filter-item">
            <label for="filter-date">Fecha</label>
            <input type="month" class="form-control" id="filter-date" />
          </div>
        </div>
      </div>

      <div class="expense-list" id="expense-list">
        <div class="loading">
          <div class="spinner"></div>
          <p>Cargando gastos...</p>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="add" role="tabpanel">
      <div class="form-card">
        <h3><i class="fas fa-receipt"></i> Nuevo Gasto</h3>
        <form id="expense-form">
          <div class="mb-3">
            <label class="form-label" for="expense-date">Fecha</label>
            <input type="date" class="form-control" id="expense-date" required />
          </div>

          <div class="mb-3">
            <label class="form-label" for="expense-category">Categor√≠a</label>
            <select class="form-select" id="expense-category" required>
              <option value="">Seleccionar categor√≠a</option>
              <option value="gasolina">Gasolina</option>
              <option value="hotel">Hotel</option>
              <option value="comida">Comida</option>
              <option value="bebida">Bebida</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label" for="expense-description">Descripci√≥n</label>
            <input type="text" class="form-control" id="expense-description" placeholder="¬øEn qu√© se gast√≥?" required />
          </div>

          <div class="mb-3">
            <label class="form-label" for="expense-amount">Monto</label>
            <input type="number" class="form-control" id="expense-amount" placeholder="0" step="1" min="0" inputmode="numeric" required />
          </div>

          <div class="mb-3">
            <label class="form-label" for="expense-payment-method">M√©todo de Pago</label>
            <select class="form-select" id="expense-payment-method">
              <option value="Efectivo">Efectivo</option>
              <option value="Tarjeta de Cr√©dito">Tarjeta de Cr√©dito</option>
              <option value="Tarjeta de D√©bito">Tarjeta de D√©bito</option>
              <option value="Transferencia">Transferencia</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label" for="expense-trip">Viaje (Opcional)</label>
            <input type="text" class="form-control" id="expense-trip" placeholder="Identificador del viaje" />
          </div>

          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i> Guardar Gasto
          </button>
        </form>
      </div>
    </div>

    <div class="tab-pane fade" id="reports" role="tabpanel">
      <div class="form-card">
        <h3><i class="fas fa-chart-pie"></i> Reporte de Gastos</h3>
        <div class="chart-wrap my-3">
          <canvas id="expenses-chart"></canvas>
        </div>
        <div class="category-stats">
          <div class="category-stat gasolina-stat">
            <div class="amount" id="report-gasolina">0%</div>
            <div class="label">Gasolina</div>
          </div>
          <div class="category-stat hotel-stat">
            <div class="amount" id="report-hotel">0%</div>
            <div class="label">Hotel</div>
          </div>
          <div class="category-stat comida-stat">
            <div class="amount" id="report-comida">0%</div>
            <div class="label">Comida</div>
          </div>
          <div class="category-stat bebida-stat">
            <div class="amount" id="report-bebida">0%</div>
            <div class="label">Bebida</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <button class="fab" data-bs-toggle="tab" data-bs-target="#add" aria-label="Agregar gasto">
    <i class="fas fa-plus"></i>
  </button>

  <div class="bottom-nav">
    <div class="nav-item active" data-tab="#expenses">
      <i class="fas fa-home"></i>
      <span>Inicio</span>
    </div>
    <div class="nav-item" data-tab="#expenses">
      <i class="fas fa-list"></i>
      <span>Gastos</span>
    </div>
    <div class="nav-item" data-tab="#reports">
      <i class="fas fa-chart-bar"></i>
      <span>Reportes</span>
    </div>
    <div class="nav-item" data-tab="#add">
      <i class="fas fa-cog"></i>
      <span>Ajustes</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
    // Firebase (sin cambios estructurales)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCg9A5CbpKOLV6WspRz87bhWT3wJVbWXDE",
      authDomain: "crm-gastos-viaje.firebaseapp.com",
      projectId: "crm-gastos-viaje",
      storageBucket: "crm-gastos-viaje.firebasestorage.app",
      messagingSenderId: "1030088242238",
      appId: "1:1030088242238:web:53c2dcb3fc6642f82e4d6f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const categories = ["gasolina", "hotel", "comida", "bebida"];
    const categoryNames = { gasolina:"Gasolina", hotel:"Hotel", comida:"Comida", bebida:"Bebida" };
    const categoryColors = { gasolina:"#3498db", hotel:"#9b59b6", comida:"#2ecc71", bebida:"#e67e22" };

    // Formateos
    function formatDate(date){
      if(date instanceof Date){
        const options = { year:'numeric', month:'short', day:'numeric', timeZone:'UTC' };
        return date.toLocaleDateString('es-ES', options);
      }
      return date;
    }
    function formatCurrency(amount){
      return `$${new Intl.NumberFormat('es-CO').format(Math.round(parseFloat(amount || 0)))}`;
    }

    // Estado Chart
    let expensesChart = null;

    async function loadExpenses(){
      const expenseList = document.getElementById('expense-list');
      expenseList.innerHTML = '<div class="loading"><div class="spinner"></div><p>Cargando gastos...</p></div>';

      // Filtros UI
      const categoryFilter = document.getElementById('filter-category').value;
      const dateFilter = document.getElementById('filter-date').value;

      const colRef = collection(db, "travel_expenses");
      let qRef = colRef;
      let hasInequality = false;

      try{
        // Construcci√≥n incremental de la query (igual que ten√≠as, con peque√±os safeguards)
        if(categoryFilter){
          qRef = query(qRef, where("category", "==", categoryFilter));
        }
        if(dateFilter){
          const startDate = new Date(dateFilter + "-01T00:00:00");
          const endDate = new Date(startDate);
          endDate.setMonth(endDate.getMonth() + 1);
          hasInequality = true;
          qRef = query(qRef, where("date", ">=", startDate), where("date", "<", endDate));
        }
        // Orden por fecha
        qRef = query(qRef, orderBy("date", "desc"));

        let snapshot;
        try{
          snapshot = await getDocs(qRef);
        }catch(err){
          // üîÅ Fallback si falta √≠ndice compuesto en Firestore
          if(String(err).includes("FAILED_PRECONDITION") || String(err).includes("requires an index")){
            const allSnap = await getDocs(colRef);
            const all = allSnap.docs.map(d => ({ id:d.id, ...d.data() }));
            let filtered = all;
            if(categoryFilter){
              filtered = filtered.filter(e => e.category === categoryFilter);
            }
            if(dateFilter){
              const startDate = new Date(dateFilter + "-01T00:00:00");
              const endDate = new Date(startDate); endDate.setMonth(endDate.getMonth()+1);
              filtered = filtered.filter(e => {
                const d = e.date?.toDate ? e.date.toDate() : new Date(e.date);
                return d >= startDate && d < endDate;
              });
            }
            filtered.sort((a,b) => {
              const ad = a.date?.toDate ? a.date.toDate() : new Date(a.date);
              const bd = b.date?.toDate ? b.date.toDate() : new Date(b.date);
              return bd - ad;
            });
            renderExpenses(filtered);
            return;
          }else{
            throw err;
          }
        }

        const items = snapshot.docs.map(d => ({ id:d.id, ...d.data() }));
        renderExpenses(items);

      }catch(error){
        console.error("Error al cargar gastos: ", error);
        expenseList.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle text-danger"></i>
            <p>Error al cargar los gastos</p>
            <p class="text-muted">Por favor, intenta nuevamente</p>
          </div>`;
      }
    }

    function renderExpenses(expenses){
      const expenseList = document.getElementById('expense-list');
      expenseList.innerHTML = '';

      let totalAmount = 0;
      const categoryTotals = { gasolina:0, hotel:0, comida:0, bebida:0 };

      if(!expenses.length){
        expenseList.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-receipt"></i>
            <p>No hay gastos registrados</p>
            <p class="text-muted">Agrega tu primer gasto usando el bot√≥n +</p>
          </div>`;
        updateStats(0, categoryTotals);
        return;
      }

      for(const expense of expenses){
        totalAmount += parseFloat(expense.amount || 0);
        if(categoryTotals.hasOwnProperty(expense.category)){
          categoryTotals[expense.category] += parseFloat(expense.amount || 0);
        }

        const el = document.createElement('div');
        el.className = `expense-item ${expense.category || ''}`;

        const displayDate = expense.date?.toDate ? expense.date.toDate() : new Date(expense.date);

        el.innerHTML = `
          <div class="expense-header">
            <div class="expense-date">${formatDate(displayDate)}</div>
            <div class="expense-amount">${formatCurrency(expense.amount)}</div>
          </div>
          <div class="expense-category ${expense.category}-category">${categoryNames[expense.category] || '-'}</div>
          <div class="expense-description">${expense.description ? String(expense.description) : '-'}</div>
          <div class="expense-footer">
            <div>${expense.paymentMethod || '-'}</div>
            <div class="action-buttons">
              <button class="action-btn edit" data-id="${expense.id}" aria-label="Editar gasto"><i class="fas fa-edit"></i></button>
              <button class="action-btn delete" data-id="${expense.id}" aria-label="Eliminar gasto"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        `;
        expenseList.appendChild(el);
      }

      // Eventos de acci√≥n
      expenseList.querySelectorAll('.action-btn.edit').forEach(btn=>{
        btn.addEventListener('click', function(){
          const id = this.getAttribute('data-id');
          alert(`Editar gasto con ID: ${id}\n(En una implementaci√≥n completa, cargar√≠amos los datos en el formulario)`);
        });
      });
      expenseList.querySelectorAll('.action-btn.delete').forEach(btn=>{
        btn.addEventListener('click', function(){
          const id = this.getAttribute('data-id');
          deleteExpense(id);
        });
      });

      updateStats(totalAmount, categoryTotals);
    }

    function updateStats(totalAmount, categoryTotals){
      document.getElementById('total-amount').textContent = formatCurrency(totalAmount);
      document.getElementById('gasolina-amount').textContent = formatCurrency(categoryTotals.gasolina);
      document.getElementById('hotel-amount').textContent = formatCurrency(categoryTotals.hotel);
      document.getElementById('comida-amount').textContent = formatCurrency(categoryTotals.comida);
      document.getElementById('bebida-amount').textContent = formatCurrency(categoryTotals.bebida);
      updateReportChart(totalAmount, categoryTotals);
    }

    function updateReportChart(totalAmount, categoryTotals){
      const percentages = {};
      for(const c of categories){
        percentages[c] = totalAmount > 0 ? Math.round((categoryTotals[c] / totalAmount) * 100) : 0;
      }
      document.getElementById('report-gasolina').textContent = `${percentages.gasolina}%`;
      document.getElementById('report-hotel').textContent = `${percentages.hotel}%`;
      document.getElementById('report-comida').textContent = `${percentages.comida}%`;
      document.getElementById('report-bebida').textContent = `${percentages.bebida}%`;

      const ctx = document.getElementById('expenses-chart').getContext('2d');
      if(expensesChart){ expensesChart.destroy(); }

      expensesChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Gasolina','Hotel','Comida','Bebida'],
          datasets: [{
            data: [categoryTotals.gasolina, categoryTotals.hotel, categoryTotals.comida, categoryTotals.bebida],
            backgroundColor: [categoryColors.gasolina, categoryColors.hotel, categoryColors.comida, categoryColors.bebida],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '58%',
          plugins: { legend: { display: false } },
          animation: { duration: 250 }
        }
      });
    }

    async function addExpense(expenseData){
      try{
        // guarda Date local (Firestore lo serializa como Timestamp)
        const docRef = await addDoc(collection(db, "travel_expenses"), {
          ...expenseData,
          date: new Date(expenseData.date + 'T00:00:00')
        });
        console.log("Gasto registrado con ID:", docRef.id);
        await loadExpenses();
        return true;
      }catch(error){
        console.error("Error al registrar gasto:", error);
        return false;
      }
    }

    async function deleteExpense(id){
      if(confirm('¬øEst√° seguro de eliminar este gasto?')){
        try{
          await deleteDoc(doc(db, "travel_expenses", id));
          console.log("Gasto eliminado");
          await loadExpenses();
        }catch(error){
          console.error("Error al eliminar gasto:", error);
          alert('Error al eliminar el gasto');
        }
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // Fechas iniciales
      document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('filter-date').value = new Date().toISOString().slice(0,7);

      // Cargar datos
      loadExpenses();

      // Form submit
      document.getElementById('expense-form').addEventListener('submit', async function(e){
        e.preventDefault();
        const data = {
          date: document.getElementById('expense-date').value,
          category: document.getElementById('expense-category').value,
          description: document.getElementById('expense-description').value,
          amount: parseFloat(document.getElementById('expense-amount').value),
          paymentMethod: document.getElementById('expense-payment-method').value,
          trip: document.getElementById('expense-trip').value || null
        };
        if(!data.category){
          alert('Por favor seleccione una categor√≠a'); return;
        }
        const ok = await addExpense(data);
        if(ok){
          this.reset();
          document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
          alert('Gasto registrado exitosamente');
          // Cambiar a la pesta√±a de gastos
          const expensesTab = document.querySelector('[data-bs-target="#expenses"]');
          const tab = new bootstrap.Tab(expensesTab); tab.show();
        }else{
          alert('Error al registrar el gasto');
        }
      });

      // Filtros
      document.getElementById('filter-category').addEventListener('change', loadExpenses);
      document.getElementById('filter-date').addEventListener('change', loadExpenses);

      // FAB -> pesta√±a agregar
      document.querySelector('.fab').addEventListener('click', function(){
        const addTab = document.querySelector('[data-bs-target="#add"]');
        const tab = new bootstrap.Tab(addTab); tab.show();
      });

      // Bottom nav -> tabs
      document.querySelectorAll('.bottom-nav .nav-item').forEach(item=>{
        item.addEventListener('click', function(){
          document.querySelectorAll('.bottom-nav .nav-item').forEach(i=>i.classList.remove('active'));
          this.classList.add('active');
          const target = this.getAttribute('data-tab');
          if(target){
            const tabBtn = document.querySelector(`[data-bs-target="${target}"]`);
            if(tabBtn){ new bootstrap.Tab(tabBtn).show(); }
          }
        });
      });
    });
  </script>
</body>
</html>

