<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>CRM Gastos Viaje</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

  <style>
    /* ====== Dise√±o base con temas ====== */
    :root{
      /* LIGHT */
      --bg: #f7f9fc;
      --bg-soft: #ffffff;
      --bg-glass: rgba(255,255,255,0.75);
      --stroke: rgba(9,30,66,0.12);
      --text: #0f172a;
      --muted: #6b7280;

      --primary: #2563eb;  /* azul */
      --primary-2: #3b82f6;
      --success: #16a34a;
      --danger: #dc2626;

      --gasolina:#2563eb;
      --hotel:#7c3aed;
      --comida:#059669;
      --bebida:#d97706;

      --radius-lg:16px;
      --radius:12px;
      --radius-sm:10px;

      --shadow-xl: 0 24px 60px rgba(2,6,23,0.08);
      --shadow-md: 0 14px 36px rgba(2,6,23,0.08);
      --shadow-sm: 0 8px 20px rgba(2,6,23,0.06);
    }

    /* DARK THEME */
    [data-theme="dark"]{
      --bg: #0b1220;         /* navy-900 */
      --bg-soft: #0f172a;    /* slate-900 */
      --bg-glass: rgba(17,24,39,0.55);
      --stroke: rgba(148,163,184,0.16);
      --text: #e5e7eb;
      --muted: #94a3b8;

      --primary:#60a5fa; --primary-2:#3b82f6;
      --success:#34d399; --danger:#f87171;

      --gasolina:#60a5fa; --hotel:#a78bfa; --comida:#34d399; --bebida:#f59e0b;
    }

    @media (prefers-color-scheme: dark){
      :root{ color-scheme: dark; }
    }

    html { font-size: clamp(14px, 2.2vw, 16px); }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; }
    }

    body{
      margin:0; min-height:100vh; color:var(--text);
      background: radial-gradient(1200px 800px at 100% -10%, var(--bg-soft) 0%, transparent 40%),
                  radial-gradient(1000px 700px at -10% 0%, var(--bg-soft) 0%, transparent 45%),
                  linear-gradient(180deg, var(--bg), var(--bg));
      padding-bottom: calc(76px + env(safe-area-inset-bottom, 12px));
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }

    /* ===== Top App Bar ===== */
    .topbar{
      position: sticky; top:0; z-index: 1000;
      padding: calc(10px + env(safe-area-inset-top, 6px)) 14px 10px;
      background: linear-gradient(180deg, var(--bg-glass), rgba(255,255,255,0.02));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand i{ color: var(--primary); font-size: 1.15rem; }
    .brand h1{ margin:0; font-size:1rem; letter-spacing:.3px; font-weight:800; }

    .top-actions{ display:flex; gap:10px; align-items:center; }
    .theme-toggle{
      min-width:40px; min-height:40px; border-radius: 12px;
      background: var(--bg-glass); border:1px solid var(--stroke); color: var(--text);
      display:flex; align-items:center; justify-content:center;
    }
    .badge-total{
      display:flex; align-items:center; gap:10px;
      background: linear-gradient(180deg, rgba(59,130,246,0.18), rgba(59,130,246,0.1));
      border:1px solid rgba(96,165,250,0.35);
      padding:8px 12px; border-radius: 999px;
      box-shadow: var(--shadow-sm);
      min-height: 38px;
    }
    .badge-total i{ color: var(--primary); }
    #trip-total-badge{ font-weight:900; }

    /* ===== Containers / Cards ===== */
    .container-main{ padding: 14px; }
    .glass{
      background: var(--bg-glass);
      border:1px solid var(--stroke);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
    }
    .section{ margin-top:12px; }

    /* ===== Stats ===== */
    .stats-card{
      display:flex; justify-content:space-between; align-items:center; gap:14px;
      padding:14px;
    }
    .stats-card .label{ color: var(--muted); font-weight:700; font-size:.9rem; }
    .stats-card .amount{ font-weight:900; font-size:1.6rem; background: linear-gradient(90deg, var(--success), #10b981); -webkit-background-clip:text; color:transparent; }

    /* ===== Filters (chips) ===== */
    .chips{ display:grid; grid-template-columns: 1fr; gap:10px; padding:12px; }
    @media (min-width: 390px){ .chips{ grid-template-columns: repeat(3, 1fr); } }
    .chip{ display:flex; flex-direction:column; gap:6px; }
    .chip label{ color: var(--muted); font-weight:800; font-size:.82rem; margin:0 2px; }
    .chip .form-control, .chip .form-select{
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:10px 12px; font-size:16px;
    }
    .chip .form-control:focus, .chip .form-select:focus{
      outline:none; border-color: rgba(96,165,250,0.6);
      box-shadow: 0 0 0 4px rgba(96,165,250,0.18);
    }

    /* ===== Category tiles ===== */
    .category-grid{
      display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin-top:12px;
    }
    .cat{
      padding:12px; border-radius: var(--radius);
      background: rgba(255,255,255,0.08);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow-sm); text-align:center;
    }
    .cat .k{ color: var(--muted); font-weight:800; font-size:.82rem; }
    .cat .v{ font-weight:900; font-size:1.06rem; margin-top:6px; }
    .gas .v{ color: var(--gasolina); } .hot .v{ color: var(--hotel); }
    .food .v{ color: var(--comida); } .drink .v{ color: var(--bebida); }

    /* ===== Tabs Redesigned ===== */
    .nav-tabs{
      margin-top:12px; border: 1px solid var(--stroke); border-radius: var(--radius-lg);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      overflow: hidden;
    }
    .nav-tabs .nav-link{
      border:none; color: var(--muted); font-weight:900; letter-spacing:.3px;
      padding:12px 14px;
    }
    .nav-tabs .nav-link.active{
      color:var(--text); background: linear-gradient(180deg, rgba(59,130,246,0.18), rgba(59,130,246,0.1));
      border-right: 1px solid var(--stroke);
    }

    /* ===== Expense list + skeleton ===== */
    .expense-list{ margin-top:12px; }
    .expense-item{
      display:block; padding:12px; margin-bottom:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
      border:1px solid var(--stroke); border-left:4px solid var(--primary-2);
      border-radius: var(--radius); box-shadow: var(--shadow-sm);
    }
    .expense-item.gasolina{ border-left-color: var(--gasolina); }
    .expense-item.hotel{ border-left-color: var(--hotel); }
    .expense-item.comida{ border-left-color: var(--comida); }
    .expense-item.bebida{ border-left-color: var(--bebida); }

    .expense-header{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .expense-date{ color: var(--muted); font-weight:800; font-size:.9rem; }
    .expense-amount{ font-weight:900; color: var(--success); }
    .expense-category{
      display:inline-block; margin-top:8px; padding:6px 10px; border-radius: 999px; font-weight:800; font-size:.82rem;
      border:1px solid var(--stroke); background: rgba(255,255,255,0.06);
    }
    .gasolina-category{ color: var(--gasolina); }
    .hotel-category{ color: var(--hotel); }
    .comida-category{ color: var(--comida); }
    .bebida-category{ color: var(--bebida); }
    .expense-description{ margin-top:8px; font-weight:800; }
    .expense-footer{
      display:flex; justify-content:space-between; align-items:center;
      margin-top:10px; padding-top:10px; border-top: 1px dashed var(--stroke); color: var(--muted);
    }
    .action-btn{
      min-width:44px; min-height:44px; border-radius: 12px; border:1px solid var(--stroke);
      background: rgba(255,255,255,0.06); color: inherit;
    }

    /* Skeleton shimmer */
    .skeleton{ position:relative; overflow:hidden; background: rgba(148,163,184,0.12); border-radius:12px; }
    .skeleton::after{
      content:""; position:absolute; inset:0; transform: translateX(-100%);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.25), transparent);
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer{ 100%{ transform: translateX(100%);} }

    /* ===== Forms ===== */
    .form-card{ padding:14px; margin-top:12px; }
    .form-card h3{ margin:0 0 10px; display:flex; gap:8px; align-items:center; font-size:1rem; }
    .form-label{ color: var(--muted); font-weight:800; }
    .btn-primary{
      width:100%; padding:12px; border-radius: 14px; border: 1px solid rgba(96,165,250,0.35);
      background: linear-gradient(180deg, rgba(59,130,246,0.35), rgba(59,130,246,0.22));
      color:var(--text); font-weight:900; letter-spacing:.3px; box-shadow: var(--shadow-md);
    }
    .btn-primary:active{ transform: translateY(1px); }

    /* ===== Chart ===== */
    .chart-wrap{ margin-top:12px; padding:12px; }
    canvas#expenses-chart{ width:100%; height:240px; }

    /* ===== FAB ===== */
    .fab{
      position:fixed; right: calc(16px + env(safe-area-inset-right, 8px));
      bottom: calc(90px + env(safe-area-inset-bottom, 8px));
      width:60px; height:60px; border-radius:50%;
      background: linear-gradient(180deg, rgba(59,130,246,0.9), rgba(59,130,246,0.6));
      border:1px solid rgba(96,165,250,0.5); color:#fff;
      display:flex; align-items:center; justify-content:center;
      box-shadow: var(--shadow-xl); z-index:1200;
    }

    /* ===== Bottom Nav ===== */
    .bottom-nav{
      position: fixed; left:0; right:0; bottom:0; z-index:1100;
      height: 64px; padding-bottom: env(safe-area-inset-bottom, 6px);
      display:flex; align-items:center; justify-content:space-around; gap:6px;
      background: linear-gradient(180deg, var(--bg-glass), rgba(255,255,255,0.02));
      backdrop-filter: blur(8px);
      border-top: 1px solid var(--stroke);
    }
    .bottom-nav .nav-item{ display:flex; flex-direction:column; align-items:center; gap:4px; color: var(--muted); font-weight:900; font-size:.78rem; }
    .bottom-nav .nav-item.active{ color: var(--text); }

    /* ===== Loading ===== */
    .loading{ text-align:center; padding:18px 8px; color: var(--muted); }
    .spinner{ border:4px solid rgba(96,165,250,0.12); border-top:4px solid var(--primary);
      width:36px; height:36px; border-radius:50%; animation: spin 1s linear infinite; margin: 8px auto; }
    @keyframes spin{ 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }

    @media (max-width:480px){ .category-grid{ grid-template-columns: repeat(2,1fr); } }
  </style>
</head>
<body>
  <!-- Top bar -->
  <header class="topbar">
    <div class="brand">
      <i class="fas fa-plane-departure"></i>
      <h1>Gastos de Viaje</h1>
    </div>
    <div class="top-actions">
      <button id="themeToggle" class="theme-toggle" aria-label="Cambiar tema">
        <i class="fas fa-sun"></i>
      </button>
      <div class="badge-total" title="Total del viaje seleccionado" aria-live="polite">
        <i class="fas fa-wallet"></i>
        <span style="font-weight:800;">Viaje:</span>
        <span id="trip-total-badge">$0</span>
      </div>
    </div>
  </header>

  <main class="container-main">
    <!-- Stats -->
    <section class="glass stats-card section" aria-live="polite">
      <div>
        <div class="label">Total (vista actual)</div>
        <div class="amount" id="total-amount">$0</div>
        <div class="label">Con filtros aplicados</div>
      </div>
      <div style="min-width:110px;text-align:right;"></div>
    </section>

    <!-- Filters -->
    <section class="glass chips section">
      <div class="chip">
        <label for="filter-category">Categor√≠a</label>
        <select id="filter-category" class="form-select">
          <option value="">Todas</option>
          <option value="gasolina">Gasolina</option>
          <option value="hotel">Hotel</option>
          <option value="comida">Comida</option>
          <option value="bebida">Bebida</option>
        </select>
      </div>
      <div class="chip">
        <label for="filter-date">Per√≠odo</label>
        <input id="filter-date" type="month" class="form-control"/>
      </div>
      <div class="chip">
        <label for="filter-trip">Viaje</label>
        <select id="filter-trip" class="form-select">
          <option value="">Todas</option>
          <option value="__NO_TRIP__">(Sin viaje)</option>
        </select>
      </div>
    </section>

    <!-- Category tiles -->
    <section class="category-grid section">
      <div class="cat gas"><div class="k">Gasolina</div><div class="v" id="gasolina-amount">$0</div></div>
      <div class="cat hot"><div class="k">Hotel</div><div class="v" id="hotel-amount">$0</div></div>
      <div class="cat food"><div class="k">Comida</div><div class="v" id="comida-amount">$0</div></div>
      <div class="cat drink"><div class="k">Bebida</div><div class="v" id="bebida-amount">$0</div></div>
    </section>

    <!-- Tabs -->
    <ul class="nav nav-tabs glass section" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses" type="button" role="tab">
          <i class="fas fa-list"></i> Gastos
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">
          <i class="fas fa-plus-circle"></i> Agregar
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
          <i class="fas fa-chart-pie"></i> Reportes
        </button>
      </li>
    </ul>

    <div class="tab-content" id="myTabContent">
      <!-- GASTOS -->
      <div class="tab-pane fade show active" id="expenses" role="tabpanel">
        <div id="expense-list" class="expense-list">
          <!-- Skeleton list (mientras carga) -->
          <div class="expense-item">
            <div class="skeleton" style="height:16px; width:40%;"></div>
            <div class="skeleton" style="height:14px; width:20%; margin-top:10px;"></div>
            <div class="skeleton" style="height:12px; width:70%; margin-top:10px;"></div>
          </div>
          <div class="expense-item">
            <div class="skeleton" style="height:16px; width:35%;"></div>
            <div class="skeleton" style="height:14px; width:25%; margin-top:10px;"></div>
            <div class="skeleton" style="height:12px; width:60%; margin-top:10px;"></div>
          </div>
        </div>
      </div>

      <!-- AGREGAR -->
      <div class="tab-pane fade" id="add" role="tabpanel">
        <div class="glass form-card">
          <h3><i class="fas fa-plus-circle"></i> Registrar Gasto</h3>
          <form id="expense-form" novalidate>
            <div class="mb-3">
              <label class="form-label" for="expense-date">Fecha</label>
              <input type="date" class="form-control" id="expense-date" required />
            </div>
            <div class="mb-3">
              <label class="form-label" for="expense-category">Categor√≠a</label>
              <select class="form-select" id="expense-category" required>
                <option value="">Seleccionar categor√≠a</option>
                <option value="gasolina">üöó Gasolina</option>
                <option value="hotel">üè® Hotel</option>
                <option value="comida">üçΩÔ∏è Comida</option>
                <option value="bebida">ü•§ Bebida</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label" for="expense-description">Descripci√≥n</label>
              <input type="text" class="form-control" id="expense-description" placeholder="Detalles del gasto" required />
            </div>
            <div class="mb-3">
              <label class="form-label" for="expense-amount">Monto</label>
              <input type="number" class="form-control" id="expense-amount" placeholder="0" step="1" min="0" required />
              <div class="d-flex justify-content-between mt-2" style="color:var(--muted);">
                <small><strong>Total actual (viaje):</strong></small>
                <small id="current-total-form" style="font-weight:900;">$0</small>
              </div>
              <div class="d-flex justify-content-between" style="color:var(--muted);">
                <small><strong>Total si guardas (viaje):</strong></small>
                <small id="projected-total-form" style="font-weight:900;">$0</small>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label" for="expense-payment-method">M√©todo de Pago</label>
              <select class="form-select" id="expense-payment-method">
                <option value="Efectivo">üíµ Efectivo</option>
                <option value="Tarjeta de Cr√©dito">üí≥ Tarjeta de Cr√©dito</option>
                <option value="Tarjeta de D√©bito">üí≥ Tarjeta de D√©bito</option>
                <option value="Transferencia">üì± Transferencia</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label" for="expense-trip">Viaje (Opcional)</label>
              <input type="text" class="form-control" id="expense-trip" placeholder="Identificador del viaje" />
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-check-circle me-2"></i> Guardar Gasto
            </button>
          </form>
        </div>
      </div>

      <!-- REPORTES -->
      <div class="tab-pane fade" id="reports" role="tabpanel">
        <div class="glass form-card">
          <h3><i class="fas fa-chart-pie"></i> Distribuci√≥n de Gastos</h3>
          <div class="glass chart-wrap">
            <canvas id="expenses-chart"></canvas>
          </div>
          <div class="category-grid" style="margin-top:12px;">
            <div class="cat gas"><div class="k">Gasolina</div><div class="v" id="report-gasolina">0%</div></div>
            <div class="cat hot"><div class="k">Hotel</div><div class="v" id="report-hotel">0%</div></div>
            <div class="cat food"><div class="k">Comida</div><div class="v" id="report-comida">0%</div></div>
            <div class="cat drink"><div class="k">Bebida</div><div class="v" id="report-bebida">0%</div></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- FAB -->
  <button class="fab" data-bs-toggle="tab" data-bs-target="#add" aria-label="Agregar gasto">
    <i class="fas fa-plus"></i>
  </button>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav" role="navigation" aria-label="Navegaci√≥n">
    <div class="nav-item active" data-target="#expenses"><i class="fas fa-home"></i><small>Inicio</small></div>
    <div class="nav-item" data-target="#expenses"><i class="fas fa-receipt"></i><small>Gastos</small></div>
    <div class="nav-item" data-target="#reports"><i class="fas fa-chart-bar"></i><small>Reportes</small></div>
    <div class="nav-item" data-target="#add"><i class="fas fa-user-circle"></i><small>Perfil</small></div>
  </nav>

  <!-- Toast container -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:1300">
    <div id="appToast" class="toast text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg">Mensaje</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- App JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, deleteDoc, doc, query, where, orderBy, getDocs,
      onSnapshot, serverTimestamp, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCg9A5CbpKOLV6WspRz87bhWT3wJVbWXDE",
      authDomain: "crm-gastos-viaje.firebaseapp.com",
      projectId: "crm-gastos-viaje",
      storageBucket: "crm-gastos-viaje.firebasestorage.app",
      messagingSenderId: "1030088242238",
      appId: "1:1030088242238:web:53c2dcb3fc6642f82e4d6f"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ===== Helpers ===== */
    const $ = (sel)=> document.querySelector(sel);
    function formatDate(date){
      try{ if(!(date instanceof Date)) date = new Date(date); if(isNaN(date)) return ''; return date.toLocaleDateString('es-CO',{year:'numeric',month:'short',day:'numeric'}); }
      catch{ return ''; }
    }
    function formatCurrency(n){ n = Number(n)||0; return `$${new Intl.NumberFormat('es-CO').format(Math.round(n))}`; }
    function debounce(fn, wait=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

    // Toast API (Bootstrap)
    const toastEl = $("#appToast");
    let toast = new bootstrap.Toast(toastEl, { delay: 2500 });
    function showToast(msg, type="primary"){
      $("#toastMsg").textContent = msg;
      toastEl.className = `toast text-bg-${type} border-0`;
      toast.show();
    }

    // Theme toggle
    const themeToggle = $("#themeToggle");
    function applyTheme(theme){ document.documentElement.setAttribute("data-theme", theme); themeToggle.innerHTML = theme === "dark" ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; }
    const savedTheme = localStorage.getItem("theme");
    applyTheme(savedTheme || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light"));
    themeToggle.addEventListener("click", ()=>{
      const current = document.documentElement.getAttribute("data-theme");
      const next = current === "dark" ? "light" : "dark";
      applyTheme(next); localStorage.setItem("theme", next);
    });

    /* ===== Datos / Estado ===== */
    const categoryNames  = { gasolina:"Gasolina", hotel:"Hotel", comida:"Comida", bebida:"Bebida" };
    const categoryColors = {
      gasolina:getComputedStyle(document.documentElement).getPropertyValue('--gasolina').trim() || "#60a5fa",
      hotel:getComputedStyle(document.documentElement).getPropertyValue('--hotel').trim() || "#a78bfa",
      comida:getComputedStyle(document.documentElement).getPropertyValue('--comida').trim() || "#34d399",
      bebida:getComputedStyle(document.documentElement).getPropertyValue('--bebida').trim() || "#f59e0b"
    };

    const tripTotals = {}; // cache por viaje
    let unsubscribeExpenses = null; // para onSnapshot actual

    /* ===== Trips ===== */
    async function fetchTripsAndPopulate(){
      try{
        const snap = await getDocs(collection(db,"travel_expenses"));
        const set = new Set();
        snap.forEach(d=>{
          const t = d.data().trip;
          if(t && String(t).trim()!=='') set.add(String(t));
        });
        const sel = $("#filter-trip");
        sel.querySelectorAll('option:not([value=""]):not([value="__NO_TRIP__"])').forEach(o=>o.remove());
        Array.from(set).sort().forEach(tr=>{
          const opt = document.createElement('option'); opt.value = tr; opt.textContent = tr; sel.appendChild(opt);
        });
      }catch(e){ console.error("Trips error:",e); }
    }

    async function computeTotalForTrip(tripKey){
      if(tripTotals.hasOwnProperty(tripKey) && typeof tripTotals[tripKey]==='number') return tripTotals[tripKey];
      try{
        const base = collection(db,"travel_expenses");
        let qy;
        if(tripKey==="") qy=query(base);
        else if(tripKey==="__NO_TRIP__") qy=query(base, where("trip","==",null));
        else qy=query(base, where("trip","==",tripKey));
        const snap = await getDocs(qy);
        let tot=0; snap.forEach(s=> tot += Number(s.data().amount)||0 );
        tripTotals[tripKey]=tot; return tot;
      }catch(e){ console.error("Total trip error:",e); return 0; }
    }

    /* ===== Render & Stats ===== */
    function updateStats(totalAmount, catTotals){
      $("#total-amount").textContent   = formatCurrency(totalAmount);
      $("#gasolina-amount").textContent= formatCurrency(catTotals.gasolina);
      $("#hotel-amount").textContent   = formatCurrency(catTotals.hotel);
      $("#comida-amount").textContent  = formatCurrency(catTotals.comida);
      $("#bebida-amount").textContent  = formatCurrency(catTotals.bebida);
      updateReportChart(totalAmount, catTotals);
    }

    function updateReportChart(total, catTotals){
      const ctx = $("#expenses-chart");
      if(!ctx) return;
      if(window.expensesChart) window.expensesChart.destroy();
      window.expensesChart = new Chart(ctx.getContext('2d'), {
        type:'doughnut',
        data:{
          labels:['Gasolina','Hotel','Comida','Bebida'],
          datasets:[{
            data:[catTotals.gasolina, catTotals.hotel, catTotals.comida, catTotals.bebida],
            backgroundColor:[categoryColors.gasolina, categoryColors.hotel, categoryColors.comida, categoryColors.bebida],
            borderWidth:2, borderColor:'rgba(255,255,255,0.9)'
          }]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ position:'bottom', labels:{ color:getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#0f172a' } },
            tooltip:{ callbacks:{ label: (c)=> `${c.label}: ${formatCurrency(c.parsed)}` } }
          }
        }
      });

      const pct = (v)=> total ? Math.round((v/total)*100) : 0;
      $("#report-gasolina").textContent = `${pct(catTotals.gasolina)}%`;
      $("#report-hotel").textContent    = `${pct(catTotals.hotel)}%`;
      $("#report-comida").textContent   = `${pct(catTotals.comida)}%`;
      $("#report-bebida").textContent   = `${pct(catTotals.bebida)}%`;
    }

    function renderSkeleton(){
      const list = $("#expense-list");
      list.innerHTML = `
        <div class="expense-item"><div class="skeleton" style="height:16px; width:40%;"></div><div class="skeleton" style="height:14px; width:20%; margin-top:10px;"></div><div class="skeleton" style="height:12px; width:70%; margin-top:10px;"></div></div>
        <div class="expense-item"><div class="skeleton" style="height:16px; width:35%;"></div><div class="skeleton" style="height:14px; width:25%; margin-top:10px;"></div><div class="skeleton" style="height:12px; width:60%; margin-top:10px;"></div></div>
      `;
    }

    function wireDeleteButtons(){
      document.querySelectorAll(".action-btn.delete").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-id");
          await deleteExpense(id);
        });
      });
    }

    /* ===== Suscripci√≥n en tiempo real a gastos (seg√∫n filtros) ===== */
    function buildQueryFromFilters(){
      const category = $("#filter-category").value;
      const monthVal = $("#filter-date").value;
      const tripVal  = $("#filter-trip").value;

      const base = collection(db,"travel_expenses");
      const cs   = [];

      if(category) cs.push(where("category","==",category));
      if(monthVal){
        const [y,m]=monthVal.split('-');
        const start = new Date(Date.UTC(parseInt(y), parseInt(m)-1, 1));
        const end   = new Date(Date.UTC(parseInt(y), parseInt(m),   1));
        cs.push(where("date",">=", Timestamp.fromDate(start)));
        cs.push(where("date","<",  Timestamp.fromDate(end)));
      }
      if(tripVal){
        if(tripVal==="__NO_TRIP__") cs.push(where("trip","==",null));
        else cs.push(where("trip","==",tripVal));
      }
      // siempre ordenar por fecha desc
      return cs.length ? query(base, ...cs, orderBy("date","desc")) : query(base, orderBy("date","desc"));
    }

    async function subscribeExpenses(){
      if(unsubscribeExpenses){ unsubscribeExpenses(); unsubscribeExpenses = null; }
      renderSkeleton();
      const qy = buildQueryFromFilters();

      unsubscribeExpenses = onSnapshot(qy, async (snap)=>{
        const list = $("#expense-list");
        if(snap.empty){
          list.innerHTML = `<div class="loading"><p>No hay gastos con estos filtros</p></div>`;
          updateStats(0, { gasolina:0, hotel:0, comida:0, bebida:0 });
          const t = await computeTotalForTrip($("#filter-trip").value || "");
          $("#trip-total-badge").textContent = formatCurrency(t);
          return;
        }

        let total=0;
        const tot = { gasolina:0, hotel:0, comida:0, bebida:0 };

        list.innerHTML = "";
        snap.forEach(d=>{
          const e = { id:d.id, ...d.data() };
          const amt = Number(e.amount)||0; total += amt;
          if(tot.hasOwnProperty(e.category)) tot[e.category] += amt;

          const el = document.createElement('div');
          el.className = `expense-item ${e.category||''}`;
          const dd = e.date && e.date.toDate ? e.date.toDate() : new Date(e.date);
          el.innerHTML = `
            <div class="expense-header">
              <div class="expense-date">${formatDate(dd)}</div>
              <div class="expense-amount">${formatCurrency(amt)}</div>
            </div>
            <div class="expense-category ${e.category}-category">${categoryNames[e.category]||'Otra'}</div>
            <div class="expense-description">${e.description||'Sin descripci√≥n'}</div>
            <div class="expense-footer">
              <div>${e.paymentMethod||'No especificado'}</div>
              <div>
                <button class="action-btn delete" data-id="${e.id}" aria-label="Eliminar"><i class="fas fa-trash"></i></button>
              </div>
            </div>
          `;
          list.appendChild(el);
        });

        updateStats(total, tot);
        wireDeleteButtons();

        const tripTotal = await computeTotalForTrip($("#filter-trip").value || "");
        $("#trip-total-badge").textContent = formatCurrency(tripTotal);

        // refrescar opciones de viaje (por si se agreg√≥ uno nuevo)
        fetchTripsAndPopulate().catch(()=>{});
      }, (error)=>{
        console.error("Snapshot error:", error);
        const list = $("#expense-list");
        list.innerHTML = `<div class="loading"><p>Error al cargar. Reintenta.</p></div>`;
        showToast("Error al cargar gastos", "danger");
      });
    }

    /* ===== CRUD ===== */
    async function addExpense(data){
      try{
        const [y,m,d] = data.date.split('-');
        const dateUTC = new Date(Date.UTC(parseInt(y), parseInt(m)-1, parseInt(d)));
        await addDoc(collection(db,"travel_expenses"), {
          ...data,
          date: Timestamp.fromDate(dateUTC),
          createdAt: serverTimestamp()
        });

        // invalidar cache b√°sica de totales
        const k = data.trip && String(data.trip).trim()!=='' ? String(data.trip) : "__NO_TRIP__";
        tripTotals[k] = undefined; tripTotals[""] = undefined;

        // No llamamos a load manual; onSnapshot har√° el update de UI autom√°ticamente
        return true;
      }catch(e){
        console.error("Add error:",e);
        return false;
      }
    }

    async function deleteExpense(id){
      if(!confirm('¬øEliminar este gasto?')) return;
      try{
        await deleteDoc(doc(db,"travel_expenses", id));
        for(const k in tripTotals) tripTotals[k] = undefined;
        showToast("Gasto eliminado", "primary");
      }catch(e){
        console.error("Delete error:",e);
        showToast("Error al eliminar", "danger");
      }
    }

    /* ===== Totales en formulario (por viaje) ===== */
    const debouncedComputeTripForm = debounce(async (tripText)=>{
      const key = tripText && tripText.trim()!=='' ? tripText.trim() : "";
      const tot = await computeTotalForTrip(key==="" ? "" : key);
      $("#current-total-form").textContent   = formatCurrency(tot);
      const amt = Number($("#expense-amount").value)||0;
      $("#projected-total-form").textContent = formatCurrency(tot + amt);
    }, 300);

    function updateProjectedFromAmount(){
      const amt = Number($("#expense-amount").value)||0;
      const tripText = $("#expense-trip").value;
      const key = tripText && tripText.trim()!=='' ? tripText.trim() : "";
      const current = (tripTotals.hasOwnProperty(key) && typeof tripTotals[key]==='number') ? tripTotals[key] : 0;
      $("#projected-total-form").textContent = formatCurrency(current + amt);
    }

    /* ===== Eventos UI ===== */
    const debouncedSubscribe = debounce(subscribeExpenses, 250);

    document.addEventListener("DOMContentLoaded", async ()=>{
      // defaults
      const today = new Date();
      $("#expense-date").value = today.toISOString().split('T')[0];
      $("#filter-date").value  = today.toISOString().slice(0,7);

      await fetchTripsAndPopulate();
      await subscribeExpenses();

      // submit
      $("#expense-form").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const btn = e.currentTarget.querySelector('button[type="submit"]');
        const orig = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Guardando...';
        btn.disabled = true;

        try{
          const data = {
            date: $("#expense-date").value,
            category: $("#expense-category").value,
            description: $("#expense-description").value,
            amount: parseFloat($("#expense-amount").value),
            paymentMethod: $("#expense-payment-method").value,
            trip: ($("#expense-trip").value || null)
          };

          if(!data.category){ showToast('Selecciona una categor√≠a', 'danger'); return; }
          if(!data.amount || data.amount<=0){ showToast('El monto debe ser mayor a cero', 'danger'); return; }

          const ok = await addExpense(data);
          if(ok){
            e.currentTarget.reset();
            $("#expense-date").value = new Date().toISOString().split('T')[0];
            showToast('‚úÖ Gasto registrado', 'primary');
            new bootstrap.Tab($('[data-bs-target="#expenses"]')).show();
            // onSnapshot actualizar√° lista/totales/trips
          }else{
            showToast('‚ùå Error al registrar', 'danger');
          }
        } finally {
          // Pase lo que pase, el bot√≥n vuelve a su estado normal
          btn.innerHTML = orig; btn.disabled=false;
        }
      });

      // filtros -> re-suscribirse
      $("#filter-category").addEventListener("change", debouncedSubscribe);
      $("#filter-date").addEventListener("change", debouncedSubscribe);
      $("#filter-trip").addEventListener("change", async function(){
        const total = await computeTotalForTrip(this.value || "");
        $("#trip-total-badge").textContent = formatCurrency(total);
        debouncedSubscribe();
      });

      // formulario: totales por viaje en vivo
      $("#expense-trip").addEventListener("input", function(){ debouncedComputeTripForm(this.value); });
      $("#expense-amount").addEventListener("input", updateProjectedFromAmount);

      // FAB abre "Agregar"
      document.querySelector(".fab").addEventListener("click", ()=>{
        new bootstrap.Tab($('[data-bs-target="#add"]')).show();
      });

      // Tabs -> bottom nav activo + resize chart
      document.querySelectorAll('#myTab button').forEach(btn=>{
        btn.addEventListener('shown.bs.tab', function(){
          const target = this.getAttribute('data-bs-target');
          // bottom nav
          document.querySelectorAll('.bottom-nav .nav-item').forEach(i=> i.classList.toggle('active', i.dataset.target === target));
          // chart
          if(target==='#reports'){ setTimeout(()=>{ if(window.expensesChart) window.expensesChart.resize(); }, 120); }
        });
      });

      // Bottom nav -> cambiar tab
      document.querySelectorAll('.bottom-nav .nav-item').forEach(i=>{
        i.addEventListener('click', ()=>{
          const t = i.dataset.target || '#expenses';
          new bootstrap.Tab(document.querySelector(`[data-bs-target="${t}"]`)).show();
        });
      });

      // Resize chart al cambiar tema (para recolorear labels)
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ()=>{ if(window.expensesChart) window.expensesChart.update(); });
    });
  </script>
</body>
</html>