<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>CRM Gastos Viaje</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

  <style>
    :root{
      --bg: #f7f9fc;
      --bg-soft: #ffffff;
      --bg-glass: rgba(255,255,255,0.75);
      --stroke: rgba(9,30,66,0.12);
      --text: #0f172a;
      --muted: #6b7280;
      --primary: #2563eb;
      --primary-2: #3b82f6;
      --success: #16a34a;
      --danger: #dc2626;
      --gasolina:#2563eb;
      --hotel:#7c3aed;
      --comida:#059669;
      --bebida:#d97706;
      --radius-lg:16px;
      --radius:12px;
      --radius-sm:10px;
      --shadow-xl: 0 24px 60px rgba(2,6,23,0.08);
      --shadow-md: 0 14px 36px rgba(2,6,23,0.08);
      --shadow-sm: 0 8px 20px rgba(2,6,23,0.06);
    }

    [data-theme="dark"]{
      --bg: #0b1220;
      --bg-soft: #0f172a;
      --bg-glass: rgba(17,24,39,0.55);
      --stroke: rgba(148,163,184,0.16);
      --text: #e5e7eb;
      --muted: #94a3b8;
      --primary:#60a5fa; --primary-2:#3b82f6;
      --success:#34d399; --danger:#f87171;
      --gasolina:#60a5fa; --hotel:#a78bfa; --comida:#34d399; --bebida:#f59e0b;
    }

    html { font-size: clamp(14px, 2.2vw, 16px); }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    
    body{
      margin:0; min-height:100vh; color:var(--text);
      background: radial-gradient(1200px 800px at 100% -10%, var(--bg-soft) 0%, transparent 40%),
                  radial-gradient(1000px 700px at -10% 0%, var(--bg-soft) 0%, transparent 45%),
                  linear-gradient(180deg, var(--bg), var(--bg));
      padding-bottom: calc(76px + env(safe-area-inset-bottom, 12px));
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }

    .topbar{
      position: sticky; top:0; z-index: 1000;
      padding: calc(10px + env(safe-area-inset-top, 6px)) 14px 10px;
      background: linear-gradient(180deg, var(--bg-glass), rgba(255,255,255,0.02));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand i{ color: var(--primary); font-size: 1.15rem; }
    .brand h1{ margin:0; font-size:1rem; letter-spacing:.3px; font-weight:800; }

    .top-actions{ display:flex; gap:10px; align-items:center; }
    .theme-toggle{
      min-width:40px; min-height:40px; border-radius: 12px;
      background: var(--bg-glass); border:1px solid var(--stroke); color: var(--text);
      display:flex; align-items:center; justify-content:center; cursor: pointer;
    }
    .badge-total{
      display:flex; align-items:center; gap:10px;
      background: linear-gradient(180deg, rgba(59,130,246,0.18), rgba(59,130,246,0.1));
      border:1px solid rgba(96,165,250,0.35);
      padding:8px 12px; border-radius: 999px;
      box-shadow: var(--shadow-sm);
      min-height: 38px;
    }
    .badge-total i{ color: var(--primary); }
    #trip-total-badge{ font-weight:900; }

    .container-main{ padding: 14px; }
    .glass{
      background: var(--bg-glass);
      border:1px solid var(--stroke);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
    }
    .section{ margin-top:12px; }

    .stats-card{
      display:flex; justify-content:space-between; align-items:center; gap:14px;
      padding:14px;
    }
    .stats-card .label{ color: var(--muted); font-weight:700; font-size:.9rem; }
    .stats-card .amount{
      font-weight:900; font-size:1.6rem;
      background: linear-gradient(90deg, var(--success), #10b981);
      -webkit-background-clip:text; color:transparent;
    }

    .filters-section {
      padding: 14px;
      margin-bottom: 12px;
    }
    
    .search-box {
      margin-bottom: 12px;
      position: relative;
    }
    
    .search-box input {
      width: 100%;
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:12px 40px 12px 14px;
      font-size:16px;
    }
    
    .search-box .search-icon {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      pointer-events: none;
    }
    
    .chips{ 
      display:grid; 
      grid-template-columns: 1fr; 
      gap:10px;
    }
    @media (min-width: 390px){ 
      .chips{ grid-template-columns: repeat(2, 1fr); } 
    }
    @media (min-width: 768px){ 
      .chips{ grid-template-columns: repeat(3, 1fr); } 
    }
    
    .chip{ display:flex; flex-direction:column; gap:6px; }
    .chip label{ color: var(--muted); font-weight:800; font-size:.82rem; margin:0 2px; }
    .chip .form-control, .chip .form-select{
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:10px 12px; font-size:16px;
    }
    .chip .form-control:focus, .chip .form-select:focus{
      outline:none; border-color: rgba(96,165,250,0.6);
      box-shadow: 0 0 0 4px rgba(96,165,250,0.18);
    }
    
    .filter-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      justify-content: flex-end;
    }
    
    .btn-clear-filters {
      background: rgba(220, 38, 38, 0.15);
      border: 1px solid rgba(220, 38, 38, 0.3);
      color: var(--danger);
      padding: 8px 16px;
      border-radius: var(--radius);
      font-weight: 700;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    
    .filter-badge {
      background: rgba(96, 165, 250, 0.2);
      border: 1px solid rgba(96, 165, 250, 0.4);
      color: var(--primary);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 800;
    }

    .category-grid{
      display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin-top:12px;
    }
    .cat{
      padding:12px; border-radius: var(--radius);
      background: rgba(255,255,255,0.08);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow-sm); text-align:center;
    }
    .cat .k{ color: var(--muted); font-weight:800; font-size:.82rem; }
    .cat .v{ font-weight:900; font-size:1.06rem; margin-top:6px; }
    .gas .v{ color: var(--gasolina); } .hot .v{ color: var(--hotel); }
    .food .v{ color: var(--comida); } .drink .v{ color: var(--bebida); }

    .nav-tabs{
      margin-top:12px; border: 1px solid var(--stroke); border-radius: var(--radius-lg);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      overflow: hidden;
    }
    .nav-tabs .nav-link{
      border:none; color: var(--muted); font-weight:900; letter-spacing:.3px;
      padding:12px 14px;
    }
    .nav-tabs .nav-link.active{
      color:var(--text); background: linear-gradient(180deg, rgba(59,130,246,0.18), rgba(59,130,246,0.1));
      border-right: 1px solid var(--stroke);
    }

    .expenses-table-wrapper {
      overflow-x: auto;
      margin-top: 12px;
    }
    
    .expenses-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--bg-glass);
      border-radius: var(--radius);
      overflow: hidden;
    }
    
    .expenses-table thead {
      background: linear-gradient(180deg, rgba(59,130,246,0.18), rgba(59,130,246,0.1));
      border-bottom: 2px solid var(--stroke);
    }
    
    .expenses-table th {
      padding: 12px 10px;
      text-align: left;
      font-weight: 800;
      font-size: 0.8rem;
      color: var(--text);
      border-bottom: 1px solid var(--stroke);
    }
    
    .expenses-table td {
      padding: 10px;
      border-bottom: 1px solid var(--stroke);
      color: var(--text);
      font-size: 0.85rem;
    }
    
    .expenses-table tbody tr {
      transition: background 0.2s ease;
    }
    
    .expenses-table tbody tr:hover {
      background: rgba(96, 165, 250, 0.08);
    }
    
    .table-category-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.75rem;
    }
    
    .table-category-badge.gasolina {
      background: rgba(96, 165, 250, 0.2);
      color: var(--gasolina);
      border: 1px solid rgba(96, 165, 250, 0.4);
    }
    
    .table-category-badge.hotel {
      background: rgba(167, 139, 250, 0.2);
      color: var(--hotel);
      border: 1px solid rgba(167, 139, 250, 0.4);
    }
    
    .table-category-badge.comida {
      background: rgba(52, 211, 153, 0.2);
      color: var(--comida);
      border: 1px solid rgba(52, 211, 153, 0.4);
    }
    
    .table-category-badge.bebida {
      background: rgba(245, 158, 11, 0.2);
      color: var(--bebida);
      border: 1px solid rgba(245, 158, 11, 0.4);
    }
    
    .table-actions {
      display: flex;
      gap: 6px;
      justify-content: center;
    }
    
    .table-btn {
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      border: none;
      font-weight: 700;
      font-size: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s ease;
    }
    
    .table-btn-edit {
      background: rgba(59, 130, 246, 0.15);
      color: var(--primary);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }
    
    .table-btn-delete {
      background: rgba(220, 38, 38, 0.15);
      color: var(--danger);
      border: 1px solid rgba(220, 38, 38, 0.3);
    }
    
    .table-amount {
      font-weight: 900;
      color: var(--success);
      font-size: 0.95rem;
    }
    
    .table-date {
      color: var(--muted);
      font-weight: 600;
      font-size: 0.8rem;
      white-space: nowrap;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    @media (max-width: 768px) {
      .expenses-table th:nth-child(4),
      .expenses-table td:nth-child(4) {
        display: none;
      }
      .table-btn span {
        display: none;
      }
    }

    .load-more-container{ margin-top:16px; text-align:center; }
    .load-more-btn{
      background: linear-gradient(180deg, rgba(59,130,246,0.18), rgba(59,130,246,0.1));
      border:1px solid rgba(96,165,250,0.35); color: var(--primary);
      padding:10px 18px; border-radius: var(--radius); font-weight:900; font-size:.9rem;
      cursor: pointer;
    }

    .fab{
      position: fixed; bottom: calc(76px + env(safe-area-inset-bottom, 16px)); right: 16px;
      width:58px; height:58px; border-radius:50%;
      background: linear-gradient(145deg, var(--primary), var(--primary-2));
      box-shadow: var(--shadow-xl);
      color:#fff; font-size:1.4rem;
      display:flex; align-items:center; justify-content:center;
      border: 2px solid rgba(255,255,255,0.25);
      z-index:999; cursor: pointer;
    }

    .form-section{ padding:14px; }
    .form-group{ margin-bottom:14px; }
    .form-group label{ color: var(--muted); font-weight:800; font-size:.85rem; margin-bottom:6px; display:block; }
    .form-control, .form-select{
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:10px 12px; font-size:16px;
      width:100%;
    }
    .form-control:focus, .form-select:focus{
      outline:none; border-color: rgba(96,165,250,0.6);
      box-shadow: 0 0 0 4px rgba(96,165,250,0.18);
    }
    .form-actions{ display:flex; gap:10px; margin-top:16px; }
    .btn-primary-submit{
      flex:1; padding:12px; border-radius: var(--radius);
      background: linear-gradient(145deg, var(--primary), var(--primary-2));
      color:#fff; font-weight:900; border:none; cursor: pointer;
    }
    .btn-secondary{
      padding:12px 18px; border-radius: var(--radius);
      background: rgba(255,255,255,0.06); border:1px solid var(--stroke);
      color: var(--text); font-weight:800; cursor: pointer;
    }

    .trip-total-preview{
      background: linear-gradient(180deg, rgba(52,211,153,0.18), rgba(52,211,153,0.1));
      border:1px solid rgba(52,211,153,0.35);
      padding:12px; border-radius: var(--radius); margin-top:12px;
      display:flex; flex-direction:column; gap:8px;
    }
    .trip-total-preview .row-preview{
      display:flex; justify-content:space-between;
    }
    .trip-total-preview .lbl{ color: var(--muted); font-weight:700; font-size:.85rem; }
    .trip-total-preview .val{ font-weight:900; color: var(--success); }

    .chart-container{ position:relative; height:260px; margin-top:14px; }
    .report-percentages{
      display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin-top:14px;
    }
    .pct-item{
      background: rgba(255,255,255,0.08);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:10px; text-align:center;
    }
    .pct-item .k{ color: var(--muted); font-size:.85rem; font-weight:800; }
    .pct-item .v{ font-size:1.4rem; font-weight:900; margin-top:4px; }
    .pct-item.gas .v{ color: var(--gasolina); }
    .pct-item.hot .v{ color: var(--hotel); }
    .pct-item.food .v{ color: var(--comida); }
    .pct-item.drink .v{ color: var(--bebida); }

    .bottom-nav{
      position: fixed; bottom:0; left:0; right:0; z-index:1100;
      padding: 10px calc(10px + env(safe-area-inset-right, 0px)) calc(10px + env(safe-area-inset-bottom, 8px)) calc(10px + env(safe-area-inset-left, 0px));
      background: linear-gradient(180deg, var(--bg-glass), rgba(15,23,42,0.92));
      backdrop-filter: blur(12px); border-top: 1px solid var(--stroke);
      display:flex; justify-content:space-around;
    }
    .bottom-nav .nav-item{
      flex:1; display:flex; flex-direction:column; align-items:center; gap:4px; padding:8px;
      border-radius: var(--radius); color: var(--muted);
      transition: all 0.25s ease; cursor: pointer;
    }
    .bottom-nav .nav-item i{ font-size:1.3rem; }
    .bottom-nav .nav-item span{ font-size:.72rem; font-weight:800; }
    .bottom-nav .nav-item.active{
      background: linear-gradient(180deg, rgba(59,130,246,0.18), rgba(59,130,246,0.1));
      color: var(--primary);
    }

    .toast-container{
      position: fixed; top: calc(env(safe-area-inset-top, 10px) + 60px); right: 16px; z-index:2000;
      display:flex; flex-direction:column; gap:8px;
    }
    .toast-item{
      min-width:260px; padding:12px 16px; border-radius: var(--radius);
      background: var(--bg-soft);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow-xl);
      display:flex; align-items:center; gap:10px;
      animation: slideInRight 0.35s ease;
    }
    @keyframes slideInRight{ from{ opacity:0; transform: translateX(40px); } to{ opacity:1; transform: translateX(0); } }
    .toast-item.success{ border-color: var(--success); }
    .toast-item.danger{ border-color: var(--danger); }
    .toast-item.primary{ border-color: var(--primary); }
    .toast-body{ font-weight:700; font-size:.88rem; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <i class="fas fa-plane-departure"></i>
      <h1>CRM Gastos</h1>
    </div>
    <div class="top-actions">
      <div class="badge-total">
        <i class="fas fa-wallet"></i>
        <span id="trip-total-badge">$0</span>
      </div>
      <button class="theme-toggle" aria-label="Cambiar tema" onclick="toggleTheme()">
        <i class="fas fa-moon" id="themeIcon"></i>
      </button>
    </div>
  </div>

  <div class="container-main" id="appMain">
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item flex-fill" role="presentation">
        <button class="nav-link active w-100" data-bs-toggle="tab" data-bs-target="#expenses" type="button">
          <i class="fas fa-list"></i> Gastos
        </button>
      </li>
      <li class="nav-item flex-fill" role="presentation">
        <button class="nav-link w-100" data-bs-toggle="tab" data-bs-target="#reports" type="button">
          <i class="fas fa-chart-pie"></i> Reportes
        </button>
      </li>
      <li class="nav-item flex-fill" role="presentation">
        <button class="nav-link w-100" data-bs-toggle="tab" data-bs-target="#add" type="button">
          <i class="fas fa-plus-circle"></i> Agregar
        </button>
      </li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="expenses">
        
        <!-- Filtros -->
        <div class="glass filters-section section">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0" style="font-size: 1.1rem; font-weight: 800;">
              <i class="fas fa-filter"></i> Filtros
            </h3>
            <span class="filter-badge" id="activeFiltersCount">0 activos</span>
          </div>
          
          <div class="search-box">
            <input 
              type="text" 
              id="filter-search" 
              placeholder="üîç Buscar..."
              class="form-control"
            />
            <i class="fas fa-search search-icon"></i>
          </div>
          
          <div class="chips">
            <div class="chip">
              <label>Categor√≠a</label>
              <select id="filter-category" class="form-select">
                <option value="">Todas</option>
                <option value="gasolina">Gasolina</option>
                <option value="hotel">Hotel</option>
                <option value="comida">Comida</option>
                <option value="bebida">Bebida</option>
              </select>
            </div>
            <div class="chip">
              <label>Mes</label>
              <input type="month" id="filter-date" class="form-control" />
            </div>
            <div class="chip">
              <label>Viaje</label>
              <select id="filter-trip" class="form-select">
                <option value="">Todos los viajes</option>
              </select>
            </div>
          </div>
          
          <div class="filter-actions">
            <button class="btn-clear-filters" id="btnClearFilters">
              <i class="fas fa-times-circle"></i> Limpiar
            </button>
          </div>
        </div>

        <div class="glass stats-card section">
          <span class="label"><i class="fas fa-coins"></i> Total:</span>
          <span class="amount" id="total-amount">$0</span>
        </div>

        <div class="category-grid">
          <div class="cat gas">
            <div class="k">GASOLINA</div>
            <div class="v" id="gasolina-amount">$0</div>
          </div>
          <div class="cat hot">
            <div class="k">HOTEL</div>
            <div class="v" id="hotel-amount">$0</div>
          </div>
          <div class="cat food">
            <div class="k">COMIDA</div>
            <div class="v" id="comida-amount">$0</div>
          </div>
          <div class="cat drink">
            <div class="k">BEBIDA</div>
            <div class="v" id="bebida-amount">$0</div>
          </div>
        </div>

        <!-- TABLA -->
        <div class="expenses-table-wrapper">
          <table class="expenses-table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Descripci√≥n</th>
                <th>Categor√≠a</th>
                <th>Viaje</th>
                <th>Monto</th>
                <th style="text-align: center;">Acciones</th>
              </tr>
            </thead>
            <tbody id="expense-list-tbody">
              <tr>
                <td colspan="6" style="text-align: center; padding: 20px; color: var(--muted);">
                  Cargando...
                </td>
              </tr>
            </tbody>
          </table>
          
          <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fas fa-inbox"></i>
            <h3>No hay gastos</h3>
            <p>Agrega tu primer gasto</p>
          </div>
        </div>

        <div class="load-more-container" id="loadMoreContainer" style="display:none;">
          <button class="load-more-btn" id="loadMoreBtn">
            <i class="fas fa-chevron-down"></i> Cargar m√°s
          </button>
        </div>
      </div>

      <div class="tab-pane fade" id="reports">
        <div class="glass stats-card section">
          <span class="label"><i class="fas fa-chart-line"></i> Total:</span>
          <span class="amount" id="total-amount-reports">$0</span>
        </div>

        <div class="glass section" style="padding:14px;">
          <div class="chart-container">
            <canvas id="expenses-chart"></canvas>
          </div>
        </div>

        <div class="report-percentages">
          <div class="pct-item gas">
            <div class="k">Gasolina</div>
            <div class="v" id="report-gasolina">0%</div>
          </div>
          <div class="pct-item hot">
            <div class="k">Hotel</div>
            <div class="v" id="report-hotel">0%</div>
          </div>
          <div class="pct-item food">
            <div class="k">Comida</div>
            <div class="v" id="report-comida">0%</div>
          </div>
          <div class="pct-item drink">
            <div class="k">Bebida</div>
            <div class="v" id="report-bebida">0%</div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="add">
        <form id="expense-form" class="form-section">
          <input type="hidden" id="edit-id" />

          <div class="form-group">
            <label>Fecha *</label>
            <input type="date" id="expense-date" class="form-control" required />
          </div>

          <div class="form-group">
            <label>Categor√≠a *</label>
            <select id="expense-category" class="form-select" required>
              <option value="">Selecciona</option>
              <option value="gasolina">Gasolina</option>
              <option value="hotel">Hotel</option>
              <option value="comida">Comida</option>
              <option value="bebida">Bebida</option>
            </select>
          </div>

          <div class="form-group">
            <label>Descripci√≥n *</label>
            <input type="text" id="expense-description" class="form-control" required />
          </div>

          <div class="form-group">
            <label>Monto (MXN) *</label>
            <input type="number" id="expense-amount" class="form-control" step="0.01" min="0" required />
          </div>

          <div class="form-group">
            <label>M√©todo de pago</label>
            <select id="expense-payment-method" class="form-select">
              <option value="Efectivo">Efectivo</option>
              <option value="Tarjeta">Tarjeta</option>
              <option value="Transferencia">Transferencia</option>
            </select>
          </div>

          <div class="form-group">
            <label>Viaje (opcional)</label>
            <input type="text" id="expense-trip" class="form-control" list="trip-options" placeholder="Ej: Guadalajara Dic 2024"/>
            <datalist id="trip-options"></datalist>
          </div>

          <div class="trip-total-preview">
            <div class="row-preview">
              <span class="lbl">Total del viaje:</span>
              <span class="val" id="current-total-form">$0</span>
            </div>
            <div class="row-preview">
              <span class="lbl">Con este gasto:</span>
              <span class="val" id="projected-total-form">$0</span>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secondary" id="btnClearForm">
              <i class="fas fa-eraser"></i> Limpiar
            </button>
            <button type="submit" class="btn-primary-submit">
              <i class="fas fa-save"></i> <span id="submitLabel">Guardar</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <button class="fab" aria-label="Agregar gasto">
    <i class="fas fa-plus"></i>
  </button>

  <div class="bottom-nav">
    <div class="nav-item active" data-target="#expenses">
      <i class="fas fa-list"></i>
      <span>Gastos</span>
    </div>
    <div class="nav-item" data-target="#reports">
      <i class="fas fa-chart-pie"></i>
      <span>Reportes</span>
    </div>
    <div class="nav-item" data-target="#add">
      <i class="fas fa-plus-circle"></i>
      <span>Agregar</span>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy, updateDoc,
      limit, startAfter, serverTimestamp, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCg9A5CbpKOLV6WspRz87bhWT3wJVbWXDE",
      authDomain: "crm-gastos-viaje.firebaseapp.com",
      projectId: "crm-gastos-viaje",
      storageBucket: "crm-gastos-viaje.firebasestorage.app",
      messagingSenderId: "1030088242238",
      appId: "1:1030088242238:web:53c2dcb3fc6642f82e4d6f"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const $ = id => document.getElementById(id);
    const formatCurrency = (val) => new Intl.NumberFormat('es-MX', { style:'currency', currency:'MXN' }).format(val || 0);
    const formatDate = (d) => d.toLocaleDateString('es-MX', { day:'2-digit', month:'short', year:'numeric' });
    
    const categoryNames = {
      gasolina: 'Gasolina',
      hotel: 'Hotel',
      comida: 'Comida',
      bebida: 'Bebida'
    };

    let lastVisible = null;
    let moreAvailable = false;
    let tripTotals = {};
    const pageSize = 50;

    function debounce(fn, delay=300){
      let t;
      return function(...args){
        clearTimeout(t);
        t = setTimeout(()=> fn.apply(this, args), delay);
      };
    }

    function showToast(message, type='primary'){
      const c = $("toastContainer");
      const t = document.createElement('div');
      t.className = `toast-item ${type}`;
      t.innerHTML = `<div class="toast-body">${message}</div>`;
      c.appendChild(t);
      setTimeout(() => t.remove(), 4000);
    }

    function toggleTheme(){
      const html = document.documentElement;
      const theme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      const icon = $("themeIcon");
      icon.className = theme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
    }
    window.toggleTheme = toggleTheme;

    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    $("themeIcon").className = savedTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';

    async function fetchTripsAndPopulate(){
      try{
        const snap = await getDocs(collection(db, "travel_expenses"));
        const trips = new Set();
        tripTotals = {};
        
        snap.forEach(d => {
          const data = d.data();
          const t = data.trip;
          if(t && typeof t === 'string' && t.trim() !== ''){
            const key = t.trim();
            trips.add(key);
            if(!tripTotals[key]) tripTotals[key] = 0;
            tripTotals[key] += (data.amount || 0);
          }
        });

        const tripArr = Array.from(trips).sort();
        const selFilter = $("filter-trip");
        const dataList = $("trip-options");
        
        selFilter.innerHTML = '<option value="">Todos los viajes</option>' +
          tripArr.map(t => `<option value="${t}">${t} (${formatCurrency(tripTotals[t])})</option>`).join('');
        
        dataList.innerHTML = tripArr.map(t => `<option value="${t}">`).join('');
      }catch(e){
        console.error("Error trips:", e);
      }
    }

    async function computeTotalForTrip(tripKey){
      if(tripTotals.hasOwnProperty(tripKey) && typeof tripTotals[tripKey]==='number') return tripTotals[tripKey];
      try{
        const base = collection(db,"travel_expenses");
        let qy;
        if(tripKey==="") qy=query(base);
        else if(tripKey==="__NO_TRIP__") qy=query(base, where("trip","==",null));
        else qy=query(base, where("trip","==",tripKey));
        const snap = await getDocs(qy);
        let tot=0; snap.forEach(s=> tot += Number(s.data().amount)||0 );
        tripTotals[tripKey]=tot; return tot;
      }catch(e){ return 0; }
    }

    function buildBaseQuery(){
      const base = collection(db,"travel_expenses");
      const cs = [];
      
      const category = $("#filter-category").value;
      const monthVal = $("#filter-date").value;
      const tripVal  = $("#filter-trip").value;
      
      if(category) cs.push(where("category","==",category));
      
      if(monthVal){
        const [y,m]=monthVal.split('-');
        const start = new Date(Date.UTC(parseInt(y), parseInt(m)-1, 1));
        const end   = new Date(Date.UTC(parseInt(y), parseInt(m),   1));
        cs.push(where("date",">=", Timestamp.fromDate(start)));
        cs.push(where("date","<",  Timestamp.fromDate(end)));
      }
      
      if(tripVal){
        if(tripVal==="__NO_TRIP__") cs.push(where("trip","==",null));
        else cs.push(where("trip","==",tripVal));
      }
      
      return cs.length ? query(base, ...cs, orderBy("date","desc")) : query(base, orderBy("date","desc"));
    }

    function getActiveFiltersCount(){
      let count = 0;
      if($("#filter-search").value.trim()) count++;
      if($("#filter-category").value) count++;
      if($("#filter-date").value) count++;
      if($("#filter-trip").value) count++;
      return count;
    }

    function applyClientSideFilter(expenses){
      const searchText = $("#filter-search").value.trim().toLowerCase();
      if(!searchText) return expenses;
      return expenses.filter(e => 
        (e.description || '').toLowerCase().includes(searchText)
      );
    }

    async function calculateAndDisplayFullTotal() {
      try {
        const totalQuery = buildBaseQuery(); 
        const querySnapshot = await getDocs(totalQuery);
        let totalAmount = 0;
        const catTotals = { gasolina:0, hotel:0, comida:0, bebida:0 };
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          totalAmount += Number(data.amount) || 0;
          if(catTotals.hasOwnProperty(data.category)){
            catTotals[data.category] += Number(data.amount) || 0;
          }
        });
        
        $('#total-amount').textContent = formatCurrency(totalAmount);
        $('#total-amount-reports').textContent = formatCurrency(totalAmount);
        updateCategoryStats(catTotals);
      } catch (e) {
        $('#total-amount').textContent = formatCurrency(0);
      }
    }

    async function loadExpenses(reset=true){
      const tbody = $("#expense-list-tbody");
      const emptyState = $("#emptyState");
      const loadMoreBtn = $("#loadMoreBtn");
      
      if(reset){ 
        lastVisible = null; 
        moreAvailable = false;
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--muted);">Cargando...</td></tr>';
      }
      
      try{
        const baseQuery = buildBaseQuery();
        let qy = lastVisible ? query(baseQuery, startAfter(lastVisible), limit(pageSize)) : query(baseQuery, limit(pageSize));
        const snap = await getDocs(qy);
        
        if(snap.empty && reset){
          tbody.innerHTML = '';
          emptyState.style.display = 'block';
          loadMoreBtn.style.display = 'none';
          return;
        }

        emptyState.style.display = 'none';
        
        let allExpenses = [];
        snap.forEach(d=>{ allExpenses.push({ id:d.id, ...d.data() }); });

        const filtered = applyClientSideFilter(allExpenses);
        
        if(reset) tbody.innerHTML = '';
        
        if(filtered.length === 0 && reset){
          tbody.innerHTML = '';
          emptyState.style.display = 'block';
          loadMoreBtn.style.display = 'none';
          return;
        }

        filtered.forEach(e => {
          const amt = Number(e.amount)||0;
          const dd = e.date && e.date.toDate ? e.date.toDate() : new Date(e.date);
          const catClass = e.category || '';
          const catLabel = categoryNames[e.category] || 'Otra';
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="table-date">${formatDate(dd)}</td>
            <td style="font-weight: 600;">${e.description||'Sin descripci√≥n'}</td>
            <td>
              <span class="table-category-badge ${catClass}">${catLabel}</span>
            </td>
            <td class="table-date">${e.trip || '‚Äî'}</td>
            <td class="table-amount">${formatCurrency(amt)}</td>
            <td>
              <div class="table-actions">
                <button class="table-btn table-btn-edit" data-id="${e.id}">
                  <i class="fas fa-edit"></i><span> Editar</span>
                </button>
                <button class="table-btn table-btn-delete" data-id="${e.id}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });

        tbody.querySelectorAll(".table-btn-delete").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.getAttribute("data-id");
            if(!confirm('¬øEliminar?')) return;
            await deleteExpense(id);
            await goToFirstPageAndRefresh();
          });
        });
        
        tbody.querySelectorAll(".table-btn-edit").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.getAttribute("data-id");
            await loadExpenseIntoForm(id);
            new bootstrap.Tab($('[data-bs-target="#add"]')).show();
          });
        });

        lastVisible = snap.docs[snap.docs.length - 1];
        moreAvailable = snap.size === pageSize;
        loadMoreBtn.style.display = moreAvailable ? 'block' : 'none';

        const tripTotal = await computeTotalForTrip($("#filter-trip").value || "");
        $("#trip-total-badge").textContent = formatCurrency(tripTotal);
        
        if(reset) {
          fetchTripsAndPopulate().catch(()=>{});
          $("activeFiltersCount").textContent = `${getActiveFiltersCount()} activos`;
        }
        
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--danger);">Error al cargar. Intenta de nuevo.</td></tr>`;
        showToast("Error al cargar", "danger");
        loadMoreBtn.style.display = 'none';
      }
    }

    async function loadMore(){
      if(!moreAvailable) return;
      await loadExpenses(false);
    }

    async function goToFirstPageAndRefresh(){
      lastVisible = null;
      await Promise.all([
        calculateAndDisplayFullTotal(),
        loadExpenses(true)
      ]);
    }

    async function addExpense(data){
      try{
        const [y,m,d] = data.date.split('-');
        const localDate = new Date(parseInt(y), parseInt(m)-1, parseInt(d));
        await addDoc(collection(db,"travel_expenses"), {
          ...data,
          date: Timestamp.fromDate(localDate),
          createdAt: serverTimestamp()
        });
        const k = data.trip && String(data.trip).trim()!=='' ? String(data.trip) : "__NO_TRIP__";
        tripTotals[k] = undefined; tripTotals[""] = undefined;
        return true;
      }catch(e){
        return false;
      }
    }

    async function updateExpense(id, data){
      try{
        const [y,m,d] = data.date.split('-');
        const localDate = new Date(parseInt(y), parseInt(m)-1, parseInt(d));
        await updateDoc(doc(db,"travel_expenses", id), {
          ...data,
          date: Timestamp.fromDate(localDate),
          updatedAt: serverTimestamp()
        });
        for(const k in tripTotals) tripTotals[k] = undefined;
        return true;
      }catch(e){
        return false;
      }
    }

    async function deleteExpense(id){
      try{
        await deleteDoc(doc(db,"travel_expenses", id));
        for(const k in tripTotals) tripTotals[k] = undefined;
        showToast("‚úÖ Eliminado", "primary");
      }catch(e){
        showToast("‚ùå Error", "danger");
      }
    }

    async function loadExpenseIntoForm(id){
      try{
        const q = query(collection(db,"travel_expenses"), where('__name__','==', id));
        const snap = await getDocs(q);
        if(snap.empty){ showToast("No encontrado", "danger"); return; }
        const data = snap.docs[0].data();
        
        $("edit-id").value = id;
        $("expense-date").value = (data.date && data.date.toDate) ? data.date.toDate().toISOString().slice(0,10) : new Date().toISOString().slice(0,10);
        $("expense-category").value = data.category || '';
        $("expense-description").value = data.description || '';
        $("expense-amount").value = data.amount || '';
        $("expense-payment-method").value = data.paymentMethod || 'Efectivo';
        $("expense-trip").value = data.trip || '';
        $("submitLabel").textContent = 'Actualizar';
        
        const key = $("expense-trip").value && $("expense-trip").value.trim()!=='' ? $("expense-trip").value.trim() : "";
        const tot = await computeTotalForTrip(key==="" ? "" : key);
        $("current-total-form").textContent = formatCurrency(tot);
        const amt = Number($("expense-amount").value)||0;
        $("projected-total-form").textContent = formatCurrency(tot + amt);
      }catch(e){
        showToast("Error", "danger");
      }
    }

    function clearFormFields(){
      $("edit-id").value = '';
      $("expense-date").value = new Date().toISOString().split('T')[0];
      $("expense-category").value = '';
      $("expense-description").value = '';
      $("expense-amount").value = '';
      $("expense-payment-method").value = 'Efectivo';
      $("expense-trip").value = '';
      $("current-total-form").textContent = '$0';
      $("projected-total-form").textContent = '$0';
      $("submitLabel").textContent = 'Guardar';
    }

    function updateCategoryStats(catTotals){
      $("gasolina-amount").textContent= formatCurrency(catTotals.gasolina);
      $("hotel-amount").textContent   = formatCurrency(catTotals.hotel);
      $("comida-amount").textContent  = formatCurrency(catTotals.comida);
      $("bebida-amount").textContent  = formatCurrency(catTotals.bebida);
      
      const totalForChart = Object.values(catTotals).reduce((sum, val) => sum + val, 0);
      updateReportChart(totalForChart, catTotals);
    }

    function updateReportChart(total, catTotals){
      const ctx = $("expenses-chart");
      if(!ctx) return;
      if(window.expensesChart) window.expensesChart.destroy();
      window.expensesChart = new Chart(ctx.getContext('2d'), {
        type:'doughnut',
        data:{
          labels:['Gasolina','Hotel','Comida','Bebida'],
          datasets:[{
            data:[catTotals.gasolina, catTotals.hotel, catTotals.comida, catTotals.bebida],
            backgroundColor:['#60a5fa','#a78bfa','#34d399','#f59e0b'],
            borderWidth:2, borderColor:'rgba(255,255,255,0.9)'
          }]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ position:'bottom', labels:{ color:getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#0f172a' } },
            tooltip:{ callbacks:{ label: (c)=> `${c.label}: ${formatCurrency(c.parsed)}` } }
          }
        }
      });

      const pct = (v)=> total > 0 ? Math.round((v/total)*100) : 0;
      $("report-gasolina").textContent = `${pct(catTotals.gasolina)}%`;
      $("report-hotel").textContent    = `${pct(catTotals.hotel)}%`;
      $("report-comida").textContent   = `${pct(catTotals.comida)}%`;
      $("report-bebida").textContent   = `${pct(catTotals.bebida)}%`;
    }

    function validateFormData(data){
      if(!data.date) return { ok:false, msg:'Selecciona fecha' };
      if(!data.category) return { ok:false, msg:'Selecciona categor√≠a' };
      if(!data.description || String(data.description).trim().length < 3) return { ok:false, msg:'Descripci√≥n muy corta' };
      if(!data.amount || Number(data.amount) <= 0) return { ok:false, msg:'Monto inv√°lido' };
      return { ok:true };
    }

    document.addEventListener("DOMContentLoaded", async ()=>{
      const today = new Date();
      $("expense-date").value = today.toISOString().split('T')[0];
      // NO establecer filtro de mes por defecto

      await fetchTripsAndPopulate();
      await goToFirstPageAndRefresh();

      $("loadMoreBtn").addEventListener("click", async ()=>{ await loadMore(); });
      $("btnClearForm").addEventListener("click", ()=> clearFormFields());
      
      $("btnClearFilters").addEventListener("click", ()=>{
        $("filter-search").value = '';
        $("filter-category").value = '';
        $("filter-date").value = '';
        $("filter-trip").value = '';
        goToFirstPageAndRefresh();
      });

      $("expense-form").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const btn = e.currentTarget.querySelector('button[type="submit"]');
        btn.disabled = true;

        try{
          const idEdit = $("edit-id").value || '';
          const data = {
            date: $("expense-date").value,
            category: $("expense-category").value,
            description: $("expense-description").value && $("expense-description").value.trim(),
            amount: Number($("expense-amount").value),
            paymentMethod: $("expense-payment-method").value,
            trip: ($("expense-trip").value || null)
          };

          const v = validateFormData(data);
          if(!v.ok){ showToast(v.msg, 'danger'); return; }

          let ok;
          if(idEdit){
            ok = await updateExpense(idEdit, data);
            if(ok) showToast('‚úÖ Actualizado', 'primary');
            else showToast('‚ùå Error', 'danger');
          } else {
            ok = await addExpense(data);
            if(ok) showToast('‚úÖ Guardado', 'primary');
            else showToast('‚ùå Error', 'danger');
          }
          
          if(ok) {
            clearFormFields();
            await fetchTripsAndPopulate();
            await goToFirstPageAndRefresh();
            new bootstrap.Tab($('[data-bs-target="#expenses"]')).show();
          }

        } finally {
          btn.disabled = false;
        }
      });
      
      const debouncedReload = debounce(()=> goToFirstPageAndRefresh(), 250);
      
      $("filter-search").addEventListener("input", debouncedReload);
      $("filter-category").addEventListener("change", debouncedReload);
      $("filter-date").addEventListener("change", debouncedReload);
      $("filter-trip").addEventListener("change", async function(){
        const total = await computeTotalForTrip(this.value || "");
        $("trip-total-badge").textContent = formatCurrency(total);
        debouncedReload();
      });

      const debouncedComputeTripForm = debounce(async (tripText)=>{
        const key = tripText && tripText.trim()!=='' ? tripText.trim() : "";
        const tot = await computeTotalForTrip(key==="" ? "" : key);
        $("current-total-form").textContent   = formatCurrency(tot);
        const amt = Number($("expense-amount").value)||0;
        $("projected-total-form").textContent = formatCurrency(tot + amt);
      }, 300);

      $("expense-trip").addEventListener("input", function(){ debouncedComputeTripForm(this.value); });
      $("expense-amount").addEventListener("input", ()=> {
        const amt = Number($("expense-amount").value)||0;
        const tripText = $("expense-trip").value;
        const key = tripText && tripText.trim()!=='' ? tripText.trim() : "";
        const current = (tripTotals.hasOwnProperty(key) && typeof tripTotals[key]==='number') ? tripTotals[key] : 0;
        $("projected-total-form").textContent = formatCurrency(current + amt);
      });
      
      document.querySelector(".fab").addEventListener("click", ()=>{
        clearFormFields();
        new bootstrap.Tab($('[data-bs-target="#add"]')).show();
      });
      
      document.querySelectorAll('#myTab button').forEach(btn=>{
        btn.addEventListener('shown.bs.tab', function(){
          const target = this.getAttribute('data-bs-target');
          document.querySelectorAll('.bottom-nav .nav-item').forEach(i=> i.classList.toggle('active', i.dataset.target === target));
          if(target==='#reports'){ setTimeout(()=>{ if(window.expensesChart) window.expensesChart.resize(); }, 120); }
        });
      });
      
      document.querySelectorAll('.bottom-nav .nav-item').forEach(i=>{
        i.addEventListener('click', ()=>{
          const t = i.dataset.target || '#expenses';
          new bootstrap.Tab(document.querySelector(`[data-bs-target="${t}"]`)).show();
        });
      });
    });

  </script>
</body>
</html>